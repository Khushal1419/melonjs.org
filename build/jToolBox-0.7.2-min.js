/*
 * jToolBox JavaScript Library
 * or... my humble attempt to create a game/app framework :)
 *
 * Minified version
 *
 * Copyright (C) 2010, Olivier BIOT
 * http://olivierbiot.wordpress.com/
 * 
 * Author:Olivier Biot
 * Date:January 2010
 */
(function(g,b){document=g.document;g.jTB=this;g.jTB.mod="jToolBox";g.jTB.nocache="";g.sys={ua:navigator.userAgent.toLowerCase(),sound:false,storage:false,gyro:(g.DeviceMotionEvent!==b),fps:60,tick:1,scale:1};audio={mp3:false,ogg:false,ma4:false,wav:false,};g.jTB.XMLParser=null;g.jTB.loadingScreen=null;readyBound=false,isReady=false,readyList=[];function d(){if(!isReady){if(!document.body){setTimeout(d,10)}else{isReady=true;for(var q=0;q<readyList.length;q++){readyList[q].call(g,[])}readyList=[]}}}function h(){if(readyBound){return}readyBound=true;if(document.addEventListener){document.addEventListener("DOMContentLoaded",d,false)}g.addEventListener("load",d,false)}onReady=function(q){h();if(isReady){q.call(g,[])}else{readyList.push(function(){return q.call(g,[])})}return this};h();if(!Function.bind){Function.prototype.bind=function(s){var q=this;return function(){return q.apply(s,arguments)}}}Array.prototype.remove=function(q){if(this.indexOf(q)!==-1){this.splice(this.indexOf(q),1);return true}else{return false}};String.prototype.trim=function(){return(this.replace(/^\s+/,"")).replace(/\s+$/,"")};String.prototype.isNumeric=function(){return(this!=null&&!isNaN(this)&&this.trim()!="")};String.prototype.isBoolean=function(){return(this!=null&&("true"==this.trim()||"false"==this.trim()))};function f(){var q={xmlDoc:null,parser:null,parseFromString:function(s){if(g.DOMParser){parser=new DOMParser();xmlDoc=parser.parseFromString(s,"text/xml")}else{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(s)}if(xmlDoc==null){console.log("xml "+xmlDoc+" not found!")}},getFirstElementByTagName:function(s){return xmlDoc?xmlDoc.getElementsByTagName(s)[0]:null},getAllTagElements:function(){return xmlDoc?xmlDoc.getElementsByTagName("*"):null},getStringAttribute:function(t,v,u){var s=t.getAttribute(v);return s?s.trim().toLowerCase():u},getIntAttribute:function(t,v,u){var s=this.getStringAttribute(t,v,u);return s?parseInt(s):u},getBooleanAttribute:function(t,v,u){var s=this.getStringAttribute(t,v,u);return s?(s=="true"):u},free:function(){xmlDoc=null}};return q}base64={base64chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),base64inv:{},init:function(){for(var q=0;q<this.base64chars.length;q++){this.base64inv[this.base64chars[q]]=q}},decodeNumeric:function(q){q=q.replace(new RegExp("[^"+this.base64chars.join("")+"=]","g"),"");p=(q.charAt(q.length-1)=="="?(q.charAt(q.length-2)=="="?"AA":"A"):"");r=[];q=q.substr(0,q.length-p.length)+p;for(c=0;c<q.length;c+=4){n=(this.base64inv[q.charAt(c)]<<18)+(this.base64inv[q.charAt(c+1)]<<12)+(this.base64inv[q.charAt(c+2)]<<6)+this.base64inv[q.charAt(c+3)];r.push((n>>>16)&255);r.push((n>>>8)&255);r.push(n&255)}return r},};var j={setNocache:function(q){jTB.nocache=q?"?"+parseInt(Math.random()*10000000):""},random:function(s,q){return(~~(Math.random()*(q-s+1))+s)},round:function(q,t){var s=Math.pow(10,t);return(Math.round(q*s)/s)},decodeNumeric_base64:function(q){return base64.decodeNumeric(q)},};function e(){if(document.addEventListener){document.removeEventListener("DOMContentLoaded",d,false)}var q=document.createElement("audio");j.setNocache(document.location.href.match(/\?nocache/));if(q.canPlayType){g.sys.sound=true;audio.mp3=("no"!=q.canPlayType("audio/mpeg"))&&(""!=q.canPlayType("audio/mpeg"));audio.ogg=("no"!=q.canPlayType('audio/ogg; codecs="vorbis"'))&&(""!=q.canPlayType('audio/ogg; codecs="vorbis"'));audio.wav=("no"!=q.canPlayType('audio/wav; codecs="1"'))&&(""!=q.canPlayType('audio/wav; codecs="1"'))}if((g.sys.ua.search("iphone")>-1)||(g.sys.ua.search("ipod")>-1)||(g.sys.ua.search("ipad")>-1)||(g.sys.ua.search("android")>-1)){g.sys.sound=false}FPS.init();jTB.XMLParser=new f();base64.init();jTB.loadingScreen=new jTB.DefaultLoadingScreen();o.init();jTB.EntityPool.init();jTB.LevelDirector.reset()}g.onReady(function(){e()});FPS={htmlCounter:null,framecount:0,framedelta:0,last:0,now:0,delta:0,tick:1,debug:false,maxfps:1/(g.sys.fps/1000),init:function(){htmlCounter=document.getElementById("framecounter");debug=(htmlCounter!==null);last=new Date().getTime();now=last;framecount=0;step=1000/g.sys.fps;maxfps=Math.round(1/(g.sys.fps/1000))},reset:function(){last=new Date().getTime();now=last;framedelta=0;framecount=0},update:function(){now=new Date().getTime();delta=(now-last);tick=(delta>maxfps)?delta/step:1;last=now;if(debug){framecount++;framedelta+=delta;if(framedelta>999){htmlCounter.replaceChild(document.createTextNode("("+framecount+"/"+g.sys.fps+" fps)"),htmlCounter.firstChild);framecount=0;framedelta=0}}},};VideoMngr={_canvas:null,_context2D:null,_backBufferCanvas:null,_backBufferContext2D:null,_wrapper:null,_double_buffering:false,_game_width_zoom:0,_game_height_zoom:0,init:function(s,v,q,t,u){this._double_buffering=t;g.sys.scale=t===true?u:1;this._game_width_zoom=v*g.sys.scale;this._game_height_zoom=q*g.sys.scale;this._wrapper=document.getElementById(s);this._canvas=document.createElement("canvas");this._canvas.setAttribute("width",(this._game_width_zoom)+"px");this._canvas.setAttribute("height",(this._game_height_zoom)+"px");this._canvas.setAttribute("border","0px solid black");this._wrapper.appendChild(this._canvas);if(this._canvas.getContext){this._context2D=this._canvas.getContext("2d");if(t){this._backBufferContext2D=VideoMngr.createCanvasSurface(v,q);this._backBufferCanvas=this._backBufferContext2D.canvas}else{this._backBufferContext2D=this._context2D;this._backBufferCanvas=this._context2D.canvas}}else{return false}return true},getWrapper:function(){return _wrapper},getWidth:function(){return this._backBufferCanvas.width},getHeight:function(){return this._backBufferCanvas.height},createCanvasSurface:function(s,q){var t=document.createElement("canvas");t.width=s;t.height=q;return t.getContext("2d")},getScreenCanvas:function(){return this._canvas},getScreenFrameBuffer:function(){return this._backBufferContext2D},updateDisplaySize:function(q){if(this._double_buffering){if(q){g.sys.scale=q}else{g.sys.scale=document.getElementById("screen size").value}this._game_width_zoom=this._backBufferCanvas.width*g.sys.scale;this._game_height_zoom=this._backBufferCanvas.height*g.sys.scale;this._canvas.width=this._game_width_zoom;this._canvas.height=this._game_height_zoom}},clearSurface:function(s,q){s.fillStyle=q;s.fillRect(0,0,s.canvas.width,s.canvas.height)},scale:function(q,s){q.translate(-(((q.canvas.width*s)-q.canvas.width)>>1),-(((q.canvas.height*s)-q.canvas.height)>>1));q.scale(s,s)},setAlpha:function(s,q){s.globalCompositeOperation=q?"source-over":"copy"},blitSurface:function(){if(this._double_buffering){this.blitSurface=function(){this._context2D.drawImage(this._backBufferCanvas,0,0,this._backBufferCanvas.width,this._backBufferCanvas.height,0,0,this._game_width_zoom,this._game_height_zoom)}}else{this.blitSurface=function(){}}this.blitSurface()}};SoundMngr={_audio_channels:[],_supportedFormat:["mp3","ogg","wav"],requestedFormat:null,_ActiveAudioExt:-1,_load_cb:null,sound_enable:true,init:function(q){if(q){this.requestedFormat=new String(q)}else{this.requestedFormat=new String("mp3")}this._ActiveAudioExt=this.getSupportedAudioFormat();return this.sound_enable},getSupportedAudioFormat:function(){var q=0;if(!g.sys.sound){this.sound_enable=false;return}if((this.requestedFormat.search(/mp3/i)!=-1)&&audio.mp3){return this._supportedFormat[q]}if((this.requestedFormat.search(/ogg/i)!=-1)&&audio.ogg){return this._supportedFormat[++q]}if((this.requestedFormat.search(/wav/i)!=-1)&&audio.wav){return this._supportedFormat[++q]}this.sound_enable=false;return -1},setLoadCallback:function(q){this._load_cb=q},soundLoadError:function(q){this._audio_channels[q][0].load()},soundLoaded:function(q,t){if(t>1){var s=this._audio_channels[q][0];for(channel=1;channel<t;channel++){this._audio_channels[q][channel]=s.cloneNode(true)}}if(this._load_cb){this._load_cb()}},load:function(s){if(this._ActiveAudioExt==-1){return 0}var q=document.createElement("audio");q.autobuffer=true;q.preload="auto";q.addEventListener("canplaythrough",function(t){q.removeEventListener("canplaythrough",arguments.callee,false);SoundMngr.soundLoaded(s.name,s.channel)},false);q.addEventListener("error",function(t){SoundMngr.soundLoadError(s.name)});q.src=s.src+s.name+"."+this._ActiveAudioExt+jTB.nocache;q.load();this._audio_channels[s.name]=[q];return 1},stop:function(q){if(this.sound_enable){var s=this._audio_channels[q];for(channel_id=s.length;channel_id--;){s[channel_id].pause();s[channel_id].currentTime=0.01}}},pause:function(q){if(this.sound_enable){var s=this._audio_channels[q];for(channel_id=s.length;channel_id--;){s[channel_id].pause()}}},getSound:function(s){var q=this._audio_channels[s];for(var t=0,u;u=q[t++];){if(u.paused||u.ended){return u}}q[0].pause();q[0].currentTime=0.01;return q[0]},play:function(s,q,u){if(this.sound_enable){var t=this.getSound(s);t.loop=q;t.play();t.addEventListener("ended",function(v){t.removeEventListener("ended",arguments.callee,false);t.pause();t.currentTime=0.01;if(u&&!q){u()}},false)}else{if(u&&!q){setTimeout(u,2000)}}}};function m(q,t,s){if(q===b){return}this.pos=new jTB.Vector2d(q,t);this.scale=new jTB.Vector2d(1,1);this.z=0;this.currentSpriteOff=0;this.spriteWidth=0;this.spriteHeight=0;this.displayWidth=0;this.displayHeight=0;this.scaleFlag=false;this.autodestroy=true;this.visible=true;if(s!=b){this.image=s;this.displayWidth=this.spriteWidth=this.image.width;this.displayHeight=this.spriteHeight=this.image.height}this.collisionBox=new jTB.Rectangle(this.pos,this.displayWidth,this.displayHeight)}m.prototype.flipX=function(q){if(q){this.scale.x=this.scale.x>0?-this.scale.x:this.scale.x}else{this.scale.x=this.scale.x<0?-this.scale.x:this.scale.x}this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))};m.prototype.flipY=function(q){if(q){this.scale.y=this.scale.y>0?-this.scale.y:this.scale.y}else{this.scale.y=this.scale.y<0?-this.scale.y:this.scale.y}this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))};m.prototype.update=function(){return false};m.prototype.draw=function(s){var q=this.pos.x-jTB.GameMngr.viewport.pos.x,t=this.pos.y-jTB.GameMngr.viewport.pos.y;if(this.scaleFlag){s.scale(this.scale.x,this.scale.y);q=(q*this.scale.x)-(this.scale.x<0?this.spriteWidth:0);t=(t*this.scale.y)-(this.scale.y<0?this.spriteHeight:0)}s.drawImage(this.image,this.currentSpriteOff,0,this.spriteWidth,this.spriteHeight,q,t,this.displayWidth,this.displayHeight);if(this.scaleFlag){s.setTransform(1,0,0,1,0,0)}};m.prototype.destroy=function(){this.onDestroyEvent();if(this.autodestroy){this.image=null;k.remove(this)}};m.prototype.onDestroyEvent=function(){};function i(q,u,t,s){if(q==b){return}m.call(this,q,u,t);this.type=0;this.currentSprite=0;this.collidable=false;this.fpscount=0;this.animationspeed=g.sys.fps/10;this.displayWidth=this.spriteWidth=s;this.spritecount=~~(this.image.width/s);this.collisionBox.set(this.pos,this.displayWidth,this.displayHeight);this.currentSpriteOff=0}i.prototype=new m();i.prototype.setCurrentSprite=function(q){this.currentSprite=q;this.currentSpriteOff=this.spriteWidth*q};i.prototype.updateColRect=function(q,s,u,t){this.collisionBox.adjustSize(q,s,u,t)};i.prototype.update=function(){if(this.visible&&(this.fpscount++>this.animationspeed)){this.setCurrentSprite(++this.currentSprite<this.spritecount?this.currentSprite:0);this.fpscount=0;return true}return false};i.prototype.checkCollision=function(s){var q=this.collisionBox.collideVsAABB(s.collisionBox);if(q.x!=0||q.y!=0){this.onCollision();return this.type}return k.NO_OBJECT};i.prototype.onCollision=function(){};var k={NO_OBJECT:0,ENEMY_OBJECT:1,COLLECTABLE_OBJECT:2,ACTION_OBJECT:3,x:0,y:0,frameBuffer:null,gameObjects:[],canvas_invalidated:true,viewport:null,collisionMap:null,currentLevel:null,registeredMouseEventObj:[],init:function(s,u,t,q){this.x=s||0;this.y=u||0;var t=t||jTB.VideoMngr.getWidth();var q=q||jTB.VideoMngr.getHeight();this.spriteCanvasSurface=jTB.VideoMngr.createCanvasSurface(t,q);this.viewport=new jTB.Viewport(0,0,t,q);this.frameBuffer=jTB.VideoMngr.getScreenFrameBuffer()},reset:function(){this.removeAll();if(this.viewport){this.viewport.reset()}this.canvas_invalidated=true},loadTMXLevel:function(u){this.currentLevel=u;this.collisionMap=this.currentLevel.getLayerByName("collision");if(!this.collisionMap||!this.collisionMap.isCollisionMap){alert("no collision map detected");return}this.currentLevel.addTo(this);this.viewport.reset();this.viewport.setBounds(this.currentLevel.realwidth,this.currentLevel.realheight);var q=this.currentLevel.getObjectGroups();for(var t=0;t<q.length;t++){for(var s=0;s<q[t].objects.length;s++){this.addEntity(q[t].objects[s],q[t].z)}}this.sort()},addEntity:function(q,s){this.add(jTB.EntityPool.newIstanceOf(q),s)},add:function(q,s){q.z=(s)?s:q.z;this.gameObjects.push(q);if(q.mouseEvent){this.registeredMouseEventObj.push(q)}},mouseEvent:function(q,t){for(var s=this.registeredMouseEventObj.length;s--;){this.registeredMouseEventObj[s].mouseEvent(q,t)}},update:function(){FPS.update();for(var q=this.gameObjects.length,s;q--,s=this.gameObjects[q];){if(s.update()){this.canvas_invalidated=true}if(s.isEntity){s.visible=this.viewport.checkAxisAligned(s.collisionBox)}}},remove:function(q){this.gameObjects.splice(this.gameObjects.indexOf(q),1);if(q.mouseEvent){this.registeredMouseEventObj.splice(this.registeredMouseEventObj.indexOf(q),1)}},removeAll:function(){this.gameObjects=[];this.registeredMouseEventObj=[]},sort:function(){this.gameObjects.sort(function(s,q){return(q.z-s.z)});this.canvas_invalidated=true},collide:function(s){var q;for(var t=this.gameObjects.length,u;t--,u=this.gameObjects[t];){if(u.isEntity&&u.visible&&u.collidable){q=u.checkCollision(s);switch(q){case k.NO_OBJECT:break;case k.COLLECTABLE_OBJECT:u.destroy();return q;break;case k.ENEMY_OBJECT:return q;break}}}return q},draw:function(){if(this.canvas_invalidated){for(var q=this.gameObjects.length,s;q--,s=this.gameObjects[q];){if(s.visible){s.draw(this.spriteCanvasSurface,this.x,this.y)}}this.canvas_invalidated=false;this.frameBuffer.drawImage(this.spriteCanvasSurface.canvas,this.x,this.y)}}};function l(q,u,t,s){i.call(this,q,u,t,s);this.isClickable=true;this.updated=false}l.prototype=new i();l.prototype.update=function(){if(this.updated){this.updated=false;return true}return false};l.prototype.clicked=function(){return false};l.prototype.mouseEvent=function(q,s){if((q>this.pos.x)&&(q<this.pos.x+this.displayWidth)&&(s>this.pos.y)&&(s<this.pos.y+this.displayHeight)){if(this.isClickable){this.updated=this.clicked()}}return this.updated};function a(q){if(q==b){return}this.nextState=q;this.actionKey=jTB.inputMngr.KEY.ENTER;this._frameBuffer=null;this.reset=function(){this._frameBuffer=VideoMngr.getScreenFrameBuffer();this.onResetEvent();k.reset();k.add(this);if(this.actionKey){jTB.inputMngr.bindKey(this.actionKey,"enter")}},this.destroy=function(){this.onDestroyEvent()};this.update=function(){if(this.actionKey&&jTB.inputMngr.isKeyPressed("enter")){o.setState(this.nextState)}return true};this.onUpdateFrame=function(){this.update();this.draw(this._frameBuffer);VideoMngr.blitSurface()}}a.prototype.draw=function(q){};a.prototype.onResetEvent=function(){};a.prototype.onDestroyEvent=function(){};var o={STATE_LOADING:0,STATE_MENU:1,STATE_READY:2,STATE_PLAY:3,STATE_GAMEOVER:4,STATE_GAME_END:5,STATE_SCORE:6,_state:-1,_intervalId:-1,_screenObject:[null,null,null,null,null,null,null,null,null,],init:function(){this.setScreenObject(this.STATE_LOADING,jTB.loadingScreen);g.addEventListener("blur",function(){if(o._state==o.STATE_PLAY){o._stopRunLoop()}},false);g.addEventListener("focus",function(){if(o._state==o.STATE_PLAY){o._startRunLoop(o.STATE_PLAY)}},false)},setScreenObject:function(q,s){this._screenObject[q]=s},setState:function(q){switch(q){case this.STATE_LOADING:case this.STATE_MENU:case this.STATE_PLAY:case this.STATE_GAMEOVER:case this.STATE_GAME_END:case this.STATE_SCORE:this._stopRunLoop();if(this._screenObject[this._state]){this._screenObject[this._state].destroy()}this._screenObject[q].reset();this._startRunLoop(q);this._state=q;break;default:break}},_startRunLoop:function(q){if(this._intervalId==-1){FPS.reset();this._intervalId=setInterval(this._screenObject[q].onUpdateFrame.bind(this._screenObject[q]),1000/g.sys.fps)}},_stopRunLoop:function(){if(this._intervalId!=-1){clearInterval(this._intervalId);this._intervalId=-1}},};g.jTB.FPS=FPS;g.jTB.XMLParser=XMLParser;g.jTB.Utils=j;g.jTB.VideoMngr=VideoMngr;g.jTB.ScreenObject=a;g.jTB.SpriteObject=m;g.jTB.GUI_Object=l;g.jTB.AnimatedSpriteObject=i;g.jTB.SoundMngr=SoundMngr;g.jTB.AppMngr=o;g.jTB.GameMngr=k})(window);(function(b,d){function a(){jTB.ScreenObject.call(this,AppMngr.STATE_PLAY);this.loadingLogo=null,this.font=new jTB.Font("bold 14px Courier","white","top");this.setLoadingLogo=function(f){this._loadingLogo=new Image();this._loadingLogo.src=f},this.onResetEvent=function(){this.actionKey=null},this.onDestroyEvent=function(){if(this._loadingLogo){this._loadingLogo=null}};this.draw=function(f){var i=f.canvas.height/2;VideoMngr.clearSurface(f,"black");if(this._loadingLogo){f.drawImage(this._loadingLogo,(f.canvas.width-this._loadingLogo.width)/2,(f.canvas.height-this._loadingLogo.height)/2);i+=this._loadingLogo.height/2+20}var g=Math.floor(jTB.loader.getLoadProgress()*f.canvas.width);f.strokeStyle="silver";f.strokeRect(0,i,f.canvas.width,20);f.fillStyle="gray";f.fillRect(2,i+2,g-4,16);var h=this.font.measure(f,"Loading...");this.font.draw(f,"Loading...",((f.canvas.width-h.width)/2),i+14)}}a.prototype=new jTB.ScreenObject();var e={_imageList:[],_xmlList:[],_ressourceCount:0,_loadCount:0,_timerId:0,onload:d,checkLoadStatus:function(){if(this._loadCount==this._ressourceCount){if(this.onload){this._timerId=setTimeout(this.onload,500)}else{alert("no load callback defined")}}else{this._timerId=setTimeout(this.checkLoadStatus.bind(this),100)}},onRessourceLoaded:function(){this._loadCount++},onImageError:function(f){console.log("Failing loading image")},preloadImage:function(f){this._imageList.push(f.name);this._imageList[f.name]=new Image();this._imageList[f.name].onload=this.onRessourceLoaded.bind(this);this._imageList[f.name].onerror=this.onImageError.bind(this);this._imageList[f.name].src=f.src+jTB.nocache},preloadXML:function(f){if(b.XMLHttpRequest){xmlhttp=new XMLHttpRequest();if(xmlhttp.overrideMimeType){xmlhttp.overrideMimeType("text/xml")}}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.open("GET",f.src+jTB.nocache,false);xmlhttp.onload=this.onRessourceLoaded.bind(this);xmlhttp.send();this._xmlList[f.name]=xmlhttp.responseText},preload:function(g){SoundMngr.setLoadCallback(this.onRessourceLoaded.bind(this));for(var f=0;f<g.length;f++){switch(g[f].type){case"image":this.preloadImage(g[f]);this._ressourceCount+=1;break;case"audio":SoundMngr.load(g[f]);this._ressourceCount+=1;break;case"tmx":this.preloadXML(g[f]);this._ressourceCount+=1;break;default:alert("error : unknow ressource type : %s",g[f].type);break}}this.checkLoadStatus()},getXML:function(f){if(this._xmlList!=null){return this._xmlList[f]}else{return null}},getImage:function(f){if(this._imageList!=null){return this._imageList[f]}else{return null}},getLoadProgress:function(){return this._loadCount/this._ressourceCount}};b.jTB.loader=e;b.jTB.DefaultLoadingScreen=a})(window);(function(d,e){function b(f,g){this.x=f||0;this.y=g||0}b.prototype.set=function(f,g){this.x=f;this.y=g};b.prototype.setZero=function(){this.set(0,0)};b.prototype.setV=function(f){this.x=f.x;this.y=f.y};b.prototype.add=function(f){this.x+=f.x;this.y+=f.y};b.prototype.sub=function(f){this.x-=f.x;this.y-=f.y};b.prototype.scale=function(f){this.x*=f.x;this.y*=f.y};b.prototype.negate=function(){return new b(-this.x,-this.y)};b.prototype.div=function(f){this.x/=f;this.y/=f};b.prototype.copy=function(f){this.x=f.x;this.y=f.y};b.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};b.prototype.normalize=function(){var f=this.length();this.x/=f;this.y/=f};b.prototype.dotProduct=function(f){return this.x*f.x+this.y*f.y};b.prototype.distance=function(f){return Math.sqrt((this.x-f.x)*(this.x-f.x)+(this.y-f.y)*(this.y-f.y))};b.prototype.clone=function(){return new b(this.x,this.y)};b.prototype.toString=function(){return"x:"+this.x+"y:"+this.y};function a(g,f,i){this.pos=g;this.colPos=new b();this.width=f;this.height=i;this.fWidth=f;this.fHeight=i;this.hWidth=~~(f/2);this.hHeight=~~(i/2);this.tthis=new b();this.trect=new b();this.__defineGetter__("left",function(){return this.pos.x+this.colsPos.x});this.__defineGetter__("right",function(){return this.pos.x+this.colsPos.x+this.width});this.__defineGetter__("top",function(){return this.pos.y+this.colPos.y});this.__defineGetter__("bottom",function(){return this.pos.y+this.colPos.y+this.height})}a.prototype.set=function(g,f,i){this.pos=g;this.width=f;this.height=i;this.fWidth=f;this.fHeight=i;this.hWidth=~~(f/2);this.hHeight=~~(i/2)};a.prototype.adjustSize=function(f,g,j,i){if(f!=0){this.colPos.x=f;this.width=g;this.hWidth=~~(this.width/2)}if(j!=0){this.colPos.y=j;this.height=i;this.hHeight=~~(this.height/2)}};a.prototype.checkAxisAligned=function(f){this.tthis.x=this.pos.x+this.colPos.x;this.tthis.y=this.pos.y+this.colPos.y;this.trect.x=f.pos.x+f.colPos.x;this.trect.y=f.pos.y+f.colPos.y;return(this.tthis.x<this.trect.x+f.width&&this.trect.x<this.tthis.x+this.width&&this.tthis.y<this.trect.y+f.height&&this.trect.y<this.tthis.y+this.height)};a.prototype.collideVsAABB=function(h){p=new b(0,0);if(this.checkAxisAligned(h)){var g=this.tthis.x+this.hWidth-this.trect.x-h.hWidth;var f=this.tthis.y+this.hHeight-this.trect.y-h.hHeight;p.x=(h.hWidth+this.hWidth)-(g<0?-g:g);p.y=(h.hHeight+this.hHeight)-(f<0?-f:f);if(p.x<p.y){p.y=0;p.x=g<0?-p.x:p.x}else{p.x=0;p.y=f<0?-p.y:p.y}}return p};a.prototype.draw=function(f){f.strokeStyle="red";f.strokeRect(this.pos.x+this.colPos.x-jTB.GameMngr.viewport.pos.x,this.pos.y+this.colPos.y-jTB.GameMngr.viewport.pos.y,this.width,this.height)};d.jTB.Vector2d=b;d.jTB.Rectangle=a})(window);(function(a,d){function e(g,f,h){this.ALIGN={LEFT:1,RIGHT:2,CENTER:3};this.font=g;this.color=f;this.align=h}e.prototype.set=function(g,f,h){this.font=g;this.color=f;this.align=h};e.prototype.measure=function(f,g){f.font=this.font;f.fillStyle=this.color;f.textBaseLine=this.align;return f.measureText(g)};e.prototype.draw=function(g,h,f,i){g.font=this.font;g.fillStyle=this.color;g.textBaseLine=this.align;g.fillText(h,f,i)};function b(g,f,i,h){e.call(this,f,null,null);if(f){this.loadFontMetrics(f)}this.scale=i;this.firstChar=h||32;this.font=null;this.size=new Vector2d();this.sSize=new Vector2d(i,i)}b.prototype=new e();b.prototype.loadFontMetrics=function(f){this.font=jTB.loader.getImageRessource(f);this.size.x=this.font.width;this.size.y=this.font.height;this.sSize.x=this.size.x*scale;this.sSize.y=this.size.y*scale};b.prototype.set=function(g,f){this.align=g;this.sSize.x=this.size.x*f;this.sSize.y=this.size.y*f};b.prototype.draw=function(h,j,f,l){var k=this.align||e.ALIGN.LEFT;j=""+j;for(var g=0;g<j.length;g++){h.drawImage(this.font,c*this.size.x,0,this.sSize.x,this.sSize.y,f,l,this.size.x,this.size.y);f+=this.width}};a.jTB.Font=e;a.jTB.BitmapFont=b})(window);(function(b,d){function a(){this.KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,PAUSE:19,ESC:27,SPACE:32,CTRL:17,X:88};this.KeyBinding=[];this.keyStatus=[];this.keyLock=[];this.keyLocked=[];this.mouseEventCB=null;this.gyroEventCB=null;this.keyboardInitialized=false}a.prototype.isKeyPressed=function(e){if(this.keyStatus[e]){if(this.keyLock[e]){this.keyLocked[e]=true;this.keyStatus[e]=false;return true}return true}return false};a.prototype.bindKey=function(e,g,f){if(!this.keyboardInitialized){this.enableKeyboardEvent(true)}this.KeyBinding[e]=g;this.keyLock[g]=f?f:false;this.keyLocked[g]=false};a.prototype.keydown=function(e){var f=this.KeyBinding[e.keyCode];if(f){if(!this.keyLocked[f]){this.keyStatus[f]=true;this.keyLocked[f]=this.keyLock[f]}this.preventDefault(e)}};a.prototype.keyup=function(e){var f=this.KeyBinding[e.keyCode];if(f){this.keyStatus[f]=false;this.keyLocked[f]=false;this.preventDefault(e)}};a.prototype.preventDefault=function(f){f.preventDefault();if(f.stopPropagation){f.stopPropagation()}f.cancelBubble=true};a.prototype.onMouseEvent=function(g){var f=g.clientX-VideoMngr.getScreenCanvas().offsetLeft;var h=g.clientY-VideoMngr.getScreenCanvas().offsetTop;this.mouseEventCB(f,h)};a.prototype.onGyroEvent=function(e){};a.prototype.enableKeyboardEvent=function(e){if(e){if(!this.keyboardInitialized){b.addEventListener("keydown",this.keydown.bind(this),false);b.addEventListener("keyup",this.keyup.bind(this),false)}}else{b.removeEventListener("keydown",this.keydown.bind(this),false);b.removeEventListener("keyup",this.keyup.bind(this),false)}this.keyboardInitialized=e};a.prototype.enableMouseEvent=function(e,f){if(e){VideoMngr.getScreenCanvas().addEventListener("click",this.onMouseEvent.bind(this),false);this.mouseEventCB=f}else{VideoMngr.getScreenCanvas().removeEventListener("click",this.onMouseEvent.bind(this),false)}};a.prototype.enableGyroscopicEvent=function(e,f){if(b.sys.gyro){b.ondevicemotion=e?this.onGyroEvent.bind(this):null;this.gyroEventCB=e?f:null}};b.jTB.inputMngr=new a()})(window);(function(d,f){var a=Math.min,e=Math.max;function b(g,j,i,h){jTB.Rectangle.call(this,new Vector2d(g,j),i-g,h-j);this.limits=new Vector2d(this.width,this.height);this.deadzone=new Vector2d(this.width/3,this.height/3)}b.prototype=new jTB.Rectangle();b.prototype.reset=function(){this.pos.set(0,0)};b.prototype.setBounds=function(g,h){this.limits.set(g,h)};b.prototype.follow=function(g){if((g.x-this.pos.x)>(this.width-this.deadzone.x)){this.pos.x=a(g.x-(this.width-this.deadzone.x),this.limits.x-this.width)}else{if((g.x-this.pos.x)<(this.deadzone.x)){this.pos.x=e(g.x-this.deadzone.x,0)}}if((g.y-this.pos.y)>(this.height-this.deadzone.y)){this.pos.y=a(g.y-(this.height-this.deadzone.y),this.limits.y-this.height)}else{if((g.y-this.pos.y)<(this.deadzone.y)){this.pos.y=e(g.y-this.deadzone.y,0)}}};b.prototype.getWidth=function(){return this.width};b.prototype.getHeight=function(){return this.height};b.prototype.getCenterX=function(){return this.width*0.5};b.prototype.getCenterY=function(){return this.height*0.5};b.prototype.setCenter=function(j,i){var h=j-this.getCenterX();var g=i-this.getCenterY();this.pos.x+=h;this.pos.y+=g};b.prototype.offsetCenter=function(g,h){this.setCenter(this.getCenterX()+g,this.getCenterY()+h)};d.jTB.Viewport=b})(window);(function(e,h){var b=Math.min;var a={entityClass:{},init:function(){},add:function(j,i){this.entityClass[j]=i},newIstanceOf:function(i){if(!this.entityClass[i.name]){alert("cannot instance entity of type '"+i.name+"': Class not found!");return null}return new this.entityClass[i.name](i.x,i.y,i)}};function g(i,j){if(!i){return}SpriteObject.call(this,0,0,jTB.loader.getImage(i));this.lastx=0;this.startx=0;this.scrollspeed=1;this.vp=jTB.GameMngr.viewport}g.prototype=new jTB.SpriteObject();g.prototype.draw=function(j,i,l){var k;if((jTB.inputMngr.isKeyPressed("right"))&&(this.lastx!=i)){this.startx+=this.scrollspeed*FPS.tick;if(this.startx>this.spriteWidth){this.startx=this.scrollspeed*FPS.tick}this.lastx=i}else{if((jTB.inputMngr.isKeyPressed("left"))&&(this.lastx!=i)){this.startx-=this.scrollspeed*FPS.tick;if(this.startx<0){this.startx=this.spriteWidth-this.scrollspeed*FPS.tick}this.lastx=i}}this.drawParallax(j,i,l)};g.prototype.drawParallax=function(m,i,q){var o=0;var l=0;var k=b(this.spriteWidth-this.startx,this.vp.width);var j=this.startx;do{if(k!=0){m.drawImage(this.image,j,0,k,this.spriteHeight,l,q,k,this.spriteHeight)}o+=k;l+=k-1;j=0;k=b(this.spriteWidth,this.vp.width-k)}while(o<this.vp.width)};function f(i,l,k,j){if(i==h){return}this.anim=[];this.current;jTB.AnimatedSpriteObject.call(this,i,l,k,j);this.addAnimation("default",null);this.setCurrentAnimation("default")}f.prototype=new jTB.AnimatedSpriteObject();f.prototype.addAnimation=function(k,m){this.anim[k]={frame:[],idx:0,length:0};if(m==null){for(var l=0;l<this.spritecount;l++){this.anim[k].frame[l]=l*this.spriteWidth}}else{var j=0;for(var l=0;l<m.length;l++){this.anim[k].frame[j]=m[l]*this.spriteWidth;j++}}this.anim[k].length=this.anim[k].frame.length};f.prototype.setCurrentAnimation=function(i,j){this.current=this.anim[i];this.currentSpriteOff=this.current.frame[this.current.idx]};f.prototype.setCurrentSprite=function(i){this.current.idx=i;this.currentSpriteOff=this.current.frame[i]};f.prototype.update=function(){if(this.visible&&(this.fpscount++>this.animationspeed)){this.setCurrentSprite(++this.current.idx<this.current.length?this.current.idx:0);this.fpscount=0;return true}return false};function d(i,l,k,j){if(i==h){return}f.call(this,i,l,jTB.loader.getImage(k),j);this.pos.set(i,l-this.spriteHeight);this.vel=new Vector2d();this.accel=new Vector2d();this.gravity=0.98;this.isEntity=true;this.falling=false;this.jumping=false;this.jumpspeed=0;this.slopeaddy=0;this.onslope=false;this.onladder=false;this.collidable=false;this.collectable=false;this.collisionMap=jTB.GameMngr.collisionMap}d.prototype=new f();d.prototype.setVelocity=function(i,j){this.accel.x=(i!=0)?i:this.accel.x;this.accel.y=(i!=0)?j:this.accel.y};d.prototype.doWalk=function(i){this.flipX(i);this.vel.x=(i)?-this.accel.x*FPS.tick:this.accel.x*FPS.tick};d.prototype.doClimb=function(i){if(this.onladder){this.vel.y=(i)?-this.accel.x*FPS.tick:this.accel.x*FPS.tick}};d.prototype.doJump=function(){if(!this.jumping&&!this.falling){this.jumpspeed=this.accel.y;this.jumping=true;if(this.onslope){this.vel.y-=this.slopeaddy}}};d.prototype.checkSlope=function(i){this.vel.y=i.tile.pos.y-this.pos.y-this.displayHeight;this.slopeaddy=this.pos.x+this.collisionBox.colPos.x+this.collisionBox.hWidth+this.vel.x-i.tile.pos.x;if(i.yprop.isLeftSlope||i.xprop.isLeftSlope){this.slopeaddy=i.tile.height-this.slopeaddy;this.vel.y+=this.slopeaddy}else{if(i.yprop.isRightSlope||i.xprop.isRightSlope){this.vel.y+=this.slopeaddy}}};d.prototype.updateMovement=function(){if(this.jumping){this.jumpspeed-=this.gravity*FPS.tick;if(this.jumspeed<=0){this.jumping=false;this.falling=true}else{this.vel.y=-this.jumpspeed*FPS.tick}}else{if(!this.onladder){this.falling=true;this.vel.y+=this.gravity*FPS.tick}}var i=this.collisionMap.checkCollision(this.collisionBox,this.vel);if(i.y){this.onslope=i.yprop.isSlope;if(this.vel.y>0){if(this.onslope){this.checkSlope(i);this.falling=false;this.jumping=false}else{if(i.yprop.isSolid||(i.yprop.isPlatform&&(this.pos.y+this.displayHeight<=i.tile.pos.y))){this.vel.y=i.tile.pos.y-this.pos.y-this.displayHeight;this.falling=false;this.jumping=false}}}else{if(this.vel.y<0){if(!i.yprop.isPlatform&&!i.yprop.isLadder){this.jumping=false;this.falling=true;this.vel.y=0}}}}this.onladder=false;if(i.x){this.onladder=i.xprop.isLadder;if(i.xprop.isSlope||this.onslope){if(!this.onslope){this.checkSlope(i);this.onslope=true}}else{if(!i.xprop.isPlatform&&!i.xprop.isLadder){this.vel.x=0}}}if((this.vel.x!=0)||(this.vel.y!=0)){this.pos.add(this.vel);if((this.onslope&&!this.jumping)||this.onladder){this.vel.y=0}return true}return false};e.jTB.EntityPool=a;e.jTB.ParallaxEntity=g;e.jTB.ObjectEntity=d})(window);(function(e,g){removepath=/^.*(\\|\/|\:)/;removeext=/\.[^\.]*$/;function d(i,m,j,k,l){jTB.Rectangle.call(this,new Vector2d(i*j,m*k),j,k);this.tileId=l;this.row=i;this.col=m}d.prototype=new jTB.Rectangle();function b(k,l,j,o,m,i){this.name=k;this.tilewidth=l;this.tileheight=j;this.spacing=o;this.margin=m;this.image=(i)?jTB.loader.getImage(i.replace(removepath,"").replace(removeext,"")):null;this.type={SOLID:"solid",PLATFORM:"platform",L_SLOPE:"lslope",R_SLOPE:"rslope",LADDER:"ladder"};this.TileProperties=[];if(this.image){this.hTileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing));this.vTileCount=~~((this.image.height-this.margin)/(this.tileheight+this.spacing))}}b.prototype.getPropertyList=function(){return{isCollectable:false,isCollidable:false,isSolid:false,isPlatform:false,isSlope:false,isLeftSlope:false,isRightSlope:false,isLadder:false}};b.prototype.getTileProperties=function(i){return this.TileProperties[i]};b.prototype.isTileCollidable=function(i){return this.TileProperties[i].isCollidable};b.prototype.isTileCollectable=function(i){return this.TileProperties[i].isCollectable};b.prototype.drawTile=function(j,i,o,m){var l=this.margin+(this.spacing+this.tilewidth)*(m%this.hTileCount);var k=this.margin+(this.spacing+this.tileheight)*~~(m/this.hTileCount);j.drawImage(this.image,l,k,this.tilewidth,this.tileheight,i,o,this.tilewidth,this.tileheight)};function h(i,j,k,l){this.width=i;this.height=j;this.z=l;this.name=null;this.visible=false;this.layerData=null;this.xLUT={};this.yLUT={};this.tileset=k;if(k){this.tilewidth=k.tilewidth;this.tileheight=k.tileheight}else{this.tilewidth=0;this.tileheight=0}this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight}h.prototype.initArray=function(j){this.layerData=new Array(this.width);for(var i=0;i<this.width+1;i++){this.layerData[i]=new Array(this.height);for(var k=0;k<this.height+1;k++){this.layerData[i][k]=g}}if(j){for(var i=0;i<this.width*this.tilewidth;i++){this.xLUT[i]=~~(i/this.tilewidth)}for(var k=0;k<this.height*this.tileheight;k++){this.yLUT[k]=~~(k/this.tileheight)}}};h.prototype.getTileId=function(i,j){tile=this.layerData[this.xLUT[~~i]][this.yLUT[~~j]];return tile?tile.tileId:null};h.prototype.getTile=function(i,j){return this.layerData[this.xLUT[~~i]][this.yLUT[~~j]]};h.prototype.setTile=function(i,k,j){this.layerData[i][k]=new d(i,k,this.tilewidth,this.tileheight,j)};h.prototype.checkCollision=function(m,k){var i=(k.x<0)?m.pos.x+m.colPos.x+k.x:m.pos.x+m.colPos.x+m.width+k.x-1;var o=(k.y<0)?m.pos.y+m.colPos.y+k.y:m.pos.y+m.colPos.y+m.height+k.y;var l={x:false,y:false,tile:g,xprop:{},yprop:{}};var j;if(i<=0||i>=this.realwidth){l.x=true}else{j=this.getTile(i,m.pos.y+m.colPos.y+m.height-1);if(j&&this.tileset.isTileCollidable(j.tileId)){l.x=true;l.tile=j;l.xprop=this.tileset.getTileProperties(j.tileId)}else{j=this.getTile(i,m.pos.y+m.colPos.y);if(j&&this.tileset.isTileCollidable(j.tileId)){l.x=true;l.tile=j;l.xprop=this.tileset.getTileProperties(j.tileId)}}}j=this.getTile(m.pos.x+m.colPos.x,o);if(j&&this.tileset.isTileCollidable(j.tileId)){l.y=true;l.tile=j;l.yprop=this.tileset.getTileProperties(j.tileId)}else{j=this.getTile(m.pos.x+m.colPos.x+m.width-1,o);if(j&&this.tileset.isTileCollidable(j.tileId)){l.y=true;l.tile=j;l.yprop=this.tileset.getTileProperties(j.tileId)}}return l};h.prototype.update=function(){return false};function a(i,j){this.pos=new Vector2d(i,j);this.z=0;this.width=0;this.height=0;this.realwidth=-1;this.realheight=-1;this.tilewidth=0;this.tileheight=0;this.tileset=[];this.mapLayers=[];this.objectGroups=[]}a.prototype.getObjectGroupByName=function(i){return this.objectGroups[i]};a.prototype.getObjectGroups=function(){return this.objectGroups};a.prototype.getLayerByName=function(j){layer=null;for(var k=this.mapLayers.length;k--;){if(this.mapLayers[k].name.toLowerCase()==j.toLowerCase()){layer=this.mapLayers[k];break}}return layer};a.prototype.addTo=function(j){if(this.visible){j.add(this)}for(var k=this.mapLayers.length;k--;){if(this.mapLayers[k].visible){j.add(this.mapLayers[k])}}};a.prototype.update=function(){return false};var f={levels:{},currentlevel:0,reset:function(){},addLevel:function(i){console.log("no level loader defined")},addTMXLevel:function(i,j){this.levels[i]=new jTB.TMXTileMap(i,0,0);if(j){j()}},loadLevel:function(i){if(this.levels[i]===g){console.log("level %s not found",i);return}if(this.levels[i] instanceof jTB.TMXTileMap){jTB.GameMngr.reset();jTB.GameMngr.loadTMXLevel(this.levels[i])}else{console.log("no level loader defined")}},reloadLevel:function(){return this.loadlevel(this.currentLevel)},nextLevel:function(){if(this.currentLevel+1<this.levels.length){return this.loadLevel(this.currentLevel+1)}else{return false}},previousLevel:function(){if(this.currentLevel-1>=0){return this.loadLevel(this.currentLevel-1)}else{return false}},goToLevel:function(i){this.loadLevel(i)},};e.jTB.Tile=d;e.jTB.TileSet=b;e.jTB.TiledLayer=h;e.jTB.TileMap=a;e.jTB.LevelDirector=f})(window);(function(f,d){function k(m){m=(m.charAt(0)=="#")?m.substring(1,7):m;rgb="rgb("+parseInt(m.substring(0,2),16);rgb+=","+parseInt(m.substring(2,4),16);rgb+=","+parseInt(m.substring(4,6),16)+")";return rgb}var j={COLLISION_MAP:"collision",TAG_MAP:"map",TAG_NAME:"name",TAG_VALUE:"value",TAG_VERSION:"version",TAG_ORIENTATION:"orientation",TAG_WIDTH:"width",TAG_HEIGHT:"height",TAG_TILEWIDTH:"tilewidth",TAG_TILEHEIGHT:"tileheight",TAG_FIRSTGID:"firstgid",TAG_GID:"gid",TAG_TILE:"tile",TAG_ID:"id",TAG_DATA:"data",TAG_COMPRESSION:"compression",TAG_ENCODING:"encoding",TAG_ATTR_BASE64:"base64",TAG_SPACING:"spacing",TAG_MARGIN:"margin",TAG_PROPERTIES:"properties",TAG_PROPERTY:"property",TAG_IMAGE:"image",TAG_SOURCE:"source",TAG_VISIBLE:"visible",TAG_TILESET:"tileset",TAG_LAYER:"layer",TAG_OBJECTGROUP:"objectgroup",TAG_OBJECT:"object",TAG_X:"x",TAG_Y:"y",TAG_WIDTH:"width",TAG_HEIGHT:"height",};function g(t,s){var o=s.getElementsByTagName(j.TAG_PROPERTIES)[0];if(o){var m=o.getElementsByTagName(j.TAG_PROPERTY);for(var q=0;q<m.length;q++){h(t,m[q])}}}function h(m,s){var q=jTB.XMLParser.getStringAttribute(s,j.TAG_NAME);var o=jTB.XMLParser.getStringAttribute(s,j.TAG_VALUE);if(!o||o.isBoolean()){o=o?(o=="true"):true}else{if(o.isNumeric()){o=parseInt(o)}}m[q]=o}function e(o,m,q){jTB.TileMap.call(this,m,q);this.xmlfile=o;this.version="";this.orientation="";this.tileMapCanvas=null;this.load()}e.prototype=new jTB.TileMap();e.prototype.load=function(){var u=0;var t=jTB.loader.getXML(this.xmlfile);if(!t){alert(this.xmlfile+"map not found");return}jTB.XMLParser.parseFromString(t);var s=jTB.XMLParser.getAllTagElements();for(var q=0;q<s.length;q++){var o=s.item(q).nodeName;switch(o){case j.TAG_MAP:var v=s.item(q);this.version=jTB.XMLParser.getStringAttribute(v,j.TAG_VERSION);this.orientation=jTB.XMLParser.getStringAttribute(v,j.TAG_ORIENTATION);this.width=jTB.XMLParser.getIntAttribute(v,j.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(v,j.TAG_HEIGHT);this.tilewidth=jTB.XMLParser.getIntAttribute(v,j.TAG_TILEWIDTH);this.tileheight=jTB.XMLParser.getIntAttribute(v,j.TAG_TILEHEIGHT);this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight;this.z=u++;if(this.orientation!="orthogonal"){alert("%s type tilemap not supported!",this.orientation);return}g(this,v);if(this.background_color){this.visible=true;this.background_color=k(this.background_color)}else{this.visible=false}break;case j.TAG_TILESET:this.tileset.push(new b(s.item(q)));break;case j.TAG_LAYER:this.mapLayers.push(new a(s.item(q),this.tileset,u++));break;case j.TAG_OBJECTGROUP:var m=jTB.XMLParser.getStringAttribute(s.item(q),j.TAG_NAME);this.objectGroups.push(new l(m,s.item(q),u++));break}}jTB.XMLParser.free()};e.prototype.draw=function(m){jTB.VideoMngr.clearSurface(m,this.background_color)};function b(q){this.firstgid=jTB.XMLParser.getIntAttribute(q,j.TAG_FIRSTGID);jTB.TileSet.call(this,jTB.XMLParser.getStringAttribute(q,j.TAG_NAME),jTB.XMLParser.getIntAttribute(q,j.TAG_TILEWIDTH),jTB.XMLParser.getIntAttribute(q,j.TAG_TILEHEIGHT),jTB.XMLParser.getIntAttribute(q,j.TAG_SPACING,0),jTB.XMLParser.getIntAttribute(q,j.TAG_MARGIN,0),q.getElementsByTagName(j.TAG_IMAGE)[0].getAttribute(j.TAG_SOURCE));var m=q.getElementsByTagName(j.TAG_TILE);for(var s=0;s<m.length;s++){var t=jTB.XMLParser.getIntAttribute(m[s],j.TAG_ID);var o=this.getPropertyList();g(o,m[s]);o.isSolid=o.type?o.type.toLowerCase()==this.type.SOLID:false;o.isPlatform=o.type?o.type.toLowerCase()==this.type.PLATFORM:false;o.isLeftSlope=o.type?o.type.toLowerCase()==this.type.L_SLOPE:false;o.isRightSlope=o.type?o.type.toLowerCase()==this.type.R_SLOPE:false;o.isLadder=o.type?o.type.toLowerCase()==this.type.LADDER:false;o.isSlope=o.isLeftSlope||o.isRightSlope;o.isCollidable=o.isSolid||o.isPlatform||o.isSlope||o.isLadder;this.TileProperties[t]=o}}b.prototype=new jTB.TileSet();function a(o,u,s){jTB.TiledLayer.call(this,jTB.XMLParser.getIntAttribute(o,j.TAG_WIDTH),jTB.XMLParser.getIntAttribute(o,j.TAG_HEIGHT),u[0],s);this.parallax=null;this.parallaxEntity=null;this.layerInvalidated=true;this.name=jTB.XMLParser.getStringAttribute(o,j.TAG_NAME);this.visible=(jTB.XMLParser.getIntAttribute(o,j.TAG_VISIBLE,1)==1);g(this,o);this.isCollisionMap=(this.name==j.COLLISION_MAP);if(this.isCollisionMap){this.visible=false;if(u[1]){this.tileset=u[1]}}this.vp=jTB.GameMngr.viewport;if(this.parallax){this.draw=this.drawParallax;this.parallaxEntity=new jTB.ParallaxEntity(this.imagesrc)}else{var t=o.getElementsByTagName(j.TAG_DATA)[0];var q=jTB.XMLParser.getStringAttribute(t,j.TAG_ENCODING);var m=jTB.XMLParser.getStringAttribute(t,j.TAG_COMPRESSION);if(this.visible||this.isCollisionMap){this.layerSurface=jTB.VideoMngr.createCanvasSurface(this.width*this.tilewidth,this.height*this.tileheight);this.layerCanvas=this.layerSurface.canvas;this.draw=this.drawTiled;this.initArray(this.isCollisionMap);this.fillArray(t,q,m)}else{this.draw=function(){}}}}a.prototype=new jTB.TiledLayer();a.prototype.fillArray=function(v,t,q){if(q!=null){alert(q+" compressed tilemap not supported!");return}if(t==j.TAG_ATTR_BASE64){var u=jTB.Utils.decodeNumeric_base64(v.childNodes[0].nodeValue)}else{var u=v.getElementsByTagName(j.TAG_TILE)}var o=0;for(var w=0;w<this.height;w++){for(var m=0;m<this.width;m++){if(t==j.TAG_ATTR_BASE64){var s=u[o]|u[o+1]<<8|u[o+2]<<16|u[o+3]<<24;o+=4}else{var s=jTB.XMLParser.getIntAttribute(u[o++],j.TAG_GID)}if(s>0){this.setTile(m,w,s-this.tileset.firstgid);if(this.visible){this.tileset.drawTile(this.layerSurface,m*this.tilewidth,w*this.tileheight,this.layerData[m][w].tileId)}}else{}}}};a.prototype.drawTiled=function(o,m,q){o.drawImage(this.layerCanvas,this.vp.pos.x,this.vp.pos.y,this.vp.width,this.vp.height,m,q,this.vp.width,this.vp.height)};a.prototype.drawParallax=function(o,m,q){this.parallaxEntity.draw(o,this.vp.pos.x-m,q)};function l(o,m,t){this.objects=[];this.name=o;this.width=jTB.XMLParser.getIntAttribute(m,j.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(m,j.TAG_HEIGHT);this.z=t;var s=m.getElementsByTagName(j.TAG_OBJECT);for(var q=0;q<s.length;q++){this.objects.push(new i(s[q],t))}}l.prototype.getObjectCount=function(){return this.objects.length};l.prototype.getObjectByIndex=function(m){return this.objects[m]};function i(m,o){this.name=jTB.XMLParser.getStringAttribute(m,j.TAG_NAME);this.x=jTB.XMLParser.getIntAttribute(m,j.TAG_X);this.y=jTB.XMLParser.getIntAttribute(m,j.TAG_Y);this.z=o;this.width=jTB.XMLParser.getIntAttribute(m,j.TAG_WIDTH,0);this.height=jTB.XMLParser.getIntAttribute(m,j.TAG_HEIGHT,0);g(this,m)}i.prototype.getObjectPropertyByName=function(m){return this[m]};f.jTB.TMXTileMap=e})(window);