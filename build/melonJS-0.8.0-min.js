/*!
 * @module me
 * MelonJS Game Engine
 * or... my humble attempt to create a game/app engine :)
 *
 * Minified version
 *
 * Copyright (C) 2011, Olivier BIOT
 * http://www.melonjs.org
 * 
 * melonJS is licensed under a Creative Commons 
 * Attribution-NonCommercial-NoDerivs 3.0 Unported License.
 * http://creativecommons.org/licenses/by-nc-nd/3.0/
 *
 * @author Olivier Biot 2011
 *
 */
(function(h,b){var l=h.document;me={mod:"melonJS",nocache:"",sys:{ua:navigator.userAgent.toLowerCase(),sound:false,storage:false,gyro:(h.DeviceMotionEvent!==b),fps:60,interpolation:false,scale:1,useNativeAnimFrame:false},debug:{displayFPS:false,renderHitBox:false},audio:null,video:null,timer:null,input:null,state:null,game:null,entityPool:null,levelDirector:null,XMLParser:null,loadingScreen:null,TMXTileMap:null};h.me=me;var i=false;var j=false,k=false,o=[];function d(){if(!k){if(!l.body){return setTimeout(d,13)}if(l.removeEventListener){l.removeEventListener("DOMContentLoaded",d,false)}else{h.removeEventListener("load",d,false)}k=true;for(var q=0;q<o.length;q++){o[q].call(h,[])}o=[]}}function g(){if(j){return}j=true;if(l.addEventListener){l.addEventListener("DOMContentLoaded",d,false)}h.addEventListener("load",d,false)}onReady=function(q){g();if(k){q.call(h,[])}else{o.push(function(){return q.call(h,[])})}return this};h.onReady(function(){a()});var f=false,m=/xyz/.test(function(){xyz})?/\bparent\b/:/.*/;Object.extend=function(v){var t=this.prototype;f=true;var u=new this();f=false;for(var s in v){u[s]=typeof v[s]=="function"&&typeof t[s]=="function"&&m.test(v[s])?(function(w,x){return function(){var z=this.parent;this.parent=t[w];var y=x.apply(this,arguments);this.parent=z;return y}})(s,v[s]):v[s]}function q(){if(!f&&this.init){this.init.apply(this,arguments)}}q.prototype=u;q.constructor=q;q.extend=arguments.callee;return q};if(typeof Object.create!=="function"){Object.create=function(q){function s(){}s.prototype=q;return new s()}}if(!Function.bind){Function.prototype.bind=function(s){var q=this;return function(){return q.apply(s,arguments)}}}String.prototype.trim=function(){return(this.replace(/^\s+/,"")).replace(/\s+$/,"")};String.prototype.isNumeric=function(){return(this!=null&&!isNaN(this)&&this.trim()!="")};String.prototype.isBoolean=function(){return(this!=null&&("true"==this.trim()||"false"==this.trim()))};String.prototype.contains=function(q){return this.indexOf(q)>-1};function e(){var q={xmlDoc:null,parser:null,parseFromString:function(s){if(h.DOMParser){parser=new DOMParser();xmlDoc=parser.parseFromString(s,"text/xml")}else{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(s)}if(xmlDoc==null){console.log("xml "+xmlDoc+" not found!")}},getFirstElementByTagName:function(s){return xmlDoc?xmlDoc.getElementsByTagName(s)[0]:null},getAllTagElements:function(){return xmlDoc?xmlDoc.getElementsByTagName("*"):null},getStringAttribute:function(t,v,u){var s=t.getAttribute(v);return s?s.trim().toLowerCase():u},getIntAttribute:function(t,v,u){var s=this.getStringAttribute(t,v,u);return s?parseInt(s):u},getFloatAttribute:function(t,v,u){var s=this.getStringAttribute(t,v,u);return s?parseFloat(s):u},getBooleanAttribute:function(t,v,u){var s=this.getStringAttribute(t,v,u);return s?(s=="true"):u},free:function(){xmlDoc=null;parser=null}};return q}function a(){if(i){return}var q=l.createElement("audio");me.utils.setNocache(l.location.href.match(/\?nocache/));if(q.canPlayType){me.audio.capabilities.mp3=("no"!=q.canPlayType("audio/mpeg"))&&(""!=q.canPlayType("audio/mpeg"));me.audio.capabilities.ogg=("no"!=q.canPlayType('audio/ogg; codecs="vorbis"'))&&(""!=q.canPlayType('audio/ogg; codecs="vorbis"'));me.audio.capabilities.wav=("no"!=q.canPlayType('audio/wav; codecs="1"'))&&(""!=q.canPlayType('audio/wav; codecs="1"'));me.sys.sound=me.audio.capabilities.mp3||me.audio.capabilities.ogg||me.audio.capabilities.wav}if((me.sys.ua.search("iphone")>-1)||(me.sys.ua.search("ipod")>-1)||(me.sys.ua.search("ipad")>-1)||(me.sys.ua.search("android")>-1)){me.sys.sound=false}me.timer.init();me.XMLParser=new e();me.loadingScreen=new me.DefaultLoadingScreen();me.state.init();me.entityPool.init();me.levelDirector.reset();i=true}SpriteObject=Object.extend({pos:null,scale:null,lastflipX:false,lastflipY:false,z:0,currentSpriteOff:0,spriteWidth:0,spriteHeight:0,displayWidth:0,displayHeight:0,scaleFlag:false,autodestroy:true,visible:true,image:null,collisionBox:null,vp:null,init:function(q,t,s){this.pos=new me.Vector2d(q,t);this.scale=new me.Vector2d(1,1);if(s!=b){this.image=s;this.displayWidth=this.spriteWidth=this.image.width;this.displayHeight=this.spriteHeight=this.image.height}this.collisionBox=new me.Rect(this.pos,this.displayWidth,this.displayHeight);this.vp=me.game.viewport},flipX:function(q){if(q!=this.lastflipX){this.lastflipX=q;this.scale.x=-this.scale.x;this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1));this.collisionBox.flipX(this.spriteWidth)}},flipY:function(q){if(q!=this.lastflipY){this.lastflipY=q;this.scale.y=-this.scale.y;this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1));this.collisionBox.flipY(this.spriteHeight)}},update:function(){return false},draw:function(s){var q=this.pos.x-this.vp.pos.x,t=this.pos.y-this.vp.pos.y;if(this.scaleFlag){s.scale(this.scale.x,this.scale.y);q=(q*this.scale.x)-(this.scale.x<0?this.spriteWidth:0);t=(t*this.scale.y)-(this.scale.y<0?this.spriteHeight:0)}s.drawImage(this.image,this.currentSpriteOff,0,this.spriteWidth,this.spriteHeight,~~q,~~t,this.displayWidth,this.displayHeight);if(this.scaleFlag){s.setTransform(1,0,0,1,0,0)}if(me.debug.renderHitBox){this.collisionBox.draw(s)}},destroy:function(){this.onDestroyEvent();if(this.autodestroy){this.image=null;me.game.remove(this)}},onDestroyEvent:function(){},});h.me.SpriteObject=SpriteObject;AnimatedSpriteObject=SpriteObject.extend({type:0,currentSprite:0,collidable:false,fpscount:0,init:function(q,u,t,s){this.parent(q,u,t);this.animationspeed=me.sys.fps/10;if(this.image!=b){this.displayWidth=this.spriteWidth=s||this.image.width;this.spritecount=~~(this.image.width/this.spriteWidth)}else{this.spritecount=1}this.collisionBox.set(this.pos,this.displayWidth,this.displayHeight);this.currentSpriteOff=0},setCurrentSprite:function(q){this.currentSprite=q;this.currentSpriteOff=this.spriteWidth*q},updateColRect:function(q,s,u,t){this.collisionBox.adjustSize(q,s,u,t)},update:function(){if(this.visible&&(this.fpscount++>this.animationspeed)){this.setCurrentSprite(++thiscurrentSprite%this.spritecount);this.fpscount=0;return true}return false},checkCollision:function(s){var q=this.collisionBox.collideVsAABB(s.collisionBox);if(q.x!=0||q.y!=0){this.onCollision(q,s);q.type=this.type;return q}return null},onCollision:function(q){if(this.collidable&&(this.type==me.game.COLLECTABLE_OBJECT)){this.destroy()}}});h.me.AnimatedSpriteObject=AnimatedSpriteObject;game=(function(){var w={};var C=0;var z=0;var B=null;var v=[];var q=0;var A=false;var u=true;var t=false;var s=[];w.viewport=null;w.HUD=null;w.collisionMap=null;w.currentLevel=null;w.NO_OBJECT=0;w.ENEMY_OBJECT=1;w.COLLECTABLE_OBJECT=2;w.ACTION_OBJECT=3;w.init=function(E,G,F,D){if(!t){E=E||0;G=G||0;var F=F||me.video.getWidth();var D=D||me.video.getHeight();spriteCanvasSurface=me.video.createCanvasSurface(F,D);w.viewport=new me.Viewport(0,0,F,D);B=me.video.getScreenFrameBuffer();t=true}};w.reset=function(){if(!t){w.init()}w.removeAll();if(w.viewport){w.viewport.reset()}u=true};w.loadTMXLevel=function(E){w.currentLevel=E;w.collisionMap=w.currentLevel.getLayerByName("collision");if(!w.collisionMap||!w.collisionMap.isCollisionMap){alert("WARNING : no collision map detected")}w.currentLevel.addTo(me.game);w.viewport.setBounds(w.currentLevel.realwidth,w.currentLevel.realheight);var x=w.currentLevel.getObjectGroups();for(var D=0;D<x.length;D++){for(var y=0;y<x[D].objects.length;y++){w.addEntity(x[D].objects[y],x[D].z)}}w.sort()};w.addEntity=function(x,y){w.add(me.entityPool.newIstanceOf(x),y)};w.addHUD=function(D,H,E,G,F){if(w.HUD==null){w.HUD=new me.HUD_Object(D,H,E,G,F)}};w.disableHUD=function(){if(w.HUD!=null){w.HUD=null}};w.add=function(x,y){x.z=(y)?y:x.z;v.push(x);if(x.mouseEvent){s.push(x)}q=v.length};w.mouseEvent=function(D,F){for(var E=s.length;E--;){s[E].mouseEvent(D,F)}};w.update=function(){me.timer.update();for(var x=q,y;x--,y=v[x];){if(y.update()){u=true}if(y.isEntity&&!y.flickering){y.visible=w.viewport.isVisible(y.collisionBox)}}u=w.viewport.update(u)};w.remove=function(x){v.splice(v.indexOf(x),1);if(x.mouseEvent){s.splice(s.indexOf(x),1)}q=v.length;u=true};w.removeAll=function(){q=0;v=[];s=[];u=true};w.sort=function(){v.sort(function(y,x){return(x.z-y.z)});u=true};w.collide=function(y){var x=null;for(var D=q,E;D--,E=v[D];){if(E.visible&&E.collidable&&E.isEntity){if(x=E.checkCollision(y)){break}}}return x};w.repaint=function(){u=true};w.draw=function(){if(u){for(var x=q,y;x--,y=v[x];){if(y.visible){y.draw(spriteCanvasSurface,C,z)}}if(w.HUD!=null){w.HUD.draw(spriteCanvasSurface,C,z)}w.viewport.draw(spriteCanvasSurface);B.drawImage(spriteCanvasSurface.canvas,C,z);u=false}};return w})();ScreenObject=Object.extend({visible:true,actionKey:null,init:function(q){this.nextState=q||null;this.actionKey=me.input.KEY.ENTER},reset:function(q){me.game.reset();me.game.add(this,999);this.onResetEvent(q);me.game.sort();if(this.actionKey){me.input.bindKey(this.actionKey,"enter")}},destroy:function(){if(this.actionKey){me.input.unbindKey(this.actionKey,"enter")}this.onDestroyEvent()},update:function(){if(this.actionKey&&me.input.isKeyPressed("enter")){me.state.change(this.nextState)}return true},onUpdateFrame:function(){me.game.update();me.game.draw();me.video.blitSurface()},draw:function(q){},onResetEvent:function(){},onDestroyEvent:function(){}});h.me.ScreenObject=ScreenObject;window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(s,q){return window.setTimeout(s,~~(1000/me.sys.fps))}})();state=(function(){var w={};var u=-1;var A=-1;var x={};var q={color:"",duration:0};var t=null;var y=null;function v(){if(A==-1){me.timer.reset();if(me.sys.useNativeAnimFrame){A=window.requestAnimFrame(B)}else{A=setInterval(function(){x[u].screen.onUpdateFrame()},~~(1000/me.sys.fps))}}}function B(){x[u].screen.onUpdateFrame();if(A!=-1){A=window.requestAnimFrame(B)}}function s(){if(A!=-1){if(me.sys.useNativeAnimFrame){clearTimeout(A)}else{clearInterval(A)}A=-1}}function z(C){s();if(x[u]){x[u].screen.destroy()}x[C].screen.reset(y);u=C;v();if(t){t()}}w.LOADING=0;w.MENU=1;w.READY=2;w.PLAY=3;w.GAMEOVER=4;w.GAME_END=5;w.SCORE=6;w.CREDITS=7;w.SETTINGS=8;w.init=function(){w.set(w.LOADING,me.loadingScreen);h.addEventListener("blur",function(){if(u!=w.LOADING){w.pause(true)}},false);h.addEventListener("focus",function(){if(u!=w.LOADING){w.resume(true)}},false)};w.pause=function(C){s();if(C){me.audio.pauseTrack()}};w.resume=function(C){v(u);if(C){me.audio.resumeTrack()}};w.set=function(C,D){x[C]={};x[C].screen=D;x[C].transition=true};w.transition=function(D,C,E){if(D=="fade"){q.color=C;q.duration=E}};w.setTransition=function(D,C){x[D].transition=C};w.change=function(C){switch(C){case w.LOADING:case w.MENU:case w.PLAY:case w.READY:case w.GAMEOVER:case w.GAME_END:case w.SCORE:case w.CREDITS:case w.SETTINGS:y=arguments[1]||null;if(q.duration&&x[C].transition){t=function(){me.game.viewport.fadeOut(q.color,q.duration)};me.game.viewport.fadeIn(q.color,q.duration,function(){z(C)})}else{z(C)}break;default:break}};w.isCurrent=function(C){return u==C};return w})();h.me.state=state;h.me.game=game})(window);(function(b,d){var a=me.ScreenObject.extend({init:function(){this.parent();this.logo1=new me.Font("century gothic",32,"white");this.logo2=new me.Font("century gothic",32,"#89b002");this.logo2.bold()},onResetEvent:function(){this.actionKey=null},onDestroyEvent:function(){this.logo1=this.logo2=null},draw:function(e){var g=e.canvas.height/2;me.video.clearSurface(e,"black");logo1_width=this.logo1.measureText(e,"melon").width;logo_width=logo1_width+this.logo2.measureText(e,"JS").width;this.logo1.draw(e,"melon",((e.canvas.width-logo_width)/2),(e.canvas.height+60)/2);this.logo2.draw(e,"JS",((e.canvas.width-logo_width)/2)+logo1_width,(e.canvas.height+60)/2);g+=40;var f=Math.floor(me.loader.getLoadProgress()*e.canvas.width);e.strokeStyle="silver";e.strokeRect(0,g,e.canvas.width,6);e.fillStyle="#89b002";e.fillRect(2,g+2,f-4,2)},});loader=(function(){var k={};var g=[];var e=[];var m=0;var i=0;var j=0;function h(){if(i==m){for(var q in e){if(e[q].isTMX){me.levelDirector.addTMXLevel(q)}}if(k.onload){j=setTimeout(k.onload,300)}else{alert("no load callback defined")}}else{j=setTimeout(h,100)}}function l(q){console.log("Failing loading image")}function o(q){g.push(q.name);g[q.name]=new Image();g[q.name].onload=k.onRessourceLoaded.bind(k);g[q.name].onerror=l.bind(this);g[q.name].src=q.src+me.nocache}function f(s,q){if(b.XMLHttpRequest){xmlhttp=new XMLHttpRequest();if(xmlhttp.overrideMimeType){xmlhttp.overrideMimeType("text/xml")}}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.open("GET",s.src+me.nocache,false);xmlhttp.onload=k.onRessourceLoaded.bind(k);xmlhttp.send();e[s.name]={};e[s.name].xml=xmlhttp.responseText;e[s.name].isTMX=q||false}k.onload=d;k.onRessourceLoaded=function(q){i++};k.preload=function(s){me.audio.setLoadCallback(k.onRessourceLoaded.bind(k));for(var q=0;q<s.length;q++){switch(s[q].type){case"image":o(s[q]);m+=1;break;case"audio":if(me.audio.isAudioEnable()){me.audio.load(s[q]);m+=1}break;case"tmx":f(s[q],true);m+=1;break;default:alert("error : unknow ressource type : %s",s[q].type);break}}h()};k.getXML=function(q){if(e!=null){return e[q].xml}else{return null}};k.getImage=function(q){if(g!=null){return g[q]}else{return null}};k.getLoadProgress=function(){return i/m};return k})();b.me.loader=loader;b.me.DefaultLoadingScreen=a})(window);(function(a,b){Vector2d=Object.extend({x:0,y:0,init:function(d,e){this.x=d||0;this.y=e||0},set:function(d,e){this.x=d;this.y=e},setZero:function(){this.set(0,0)},setV:function(d){this.x=d.x;this.y=d.y},add:function(d){this.x+=d.x;this.y+=d.y},sub:function(d){this.x-=d.x;this.y-=d.y},scale:function(d){this.x*=d.x;this.y*=d.y},negate:function(){return new Vector2d(-this.x,-this.y)},div:function(d){this.x/=d;this.y/=d},copy:function(d){this.x=d.x;this.y=d.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var d=this.length();this.x/=d;this.y/=d},dotProduct:function(d){return this.x*d.x+this.y*d.y},distance:function(d){return Math.sqrt((this.x-d.x)*(this.x-d.x)+(this.y-d.y)*(this.y-d.y))},clone:function(){return new Vector2d(this.x,this.y)},toString:function(){return"x:"+this.x+"y:"+this.y},});Rect=Object.extend({pos:null,colPos:null,width:0,height:0,hWidth:0,hHeight:0,tthis:null,trect:null,init:function(e,d,f){this.pos=e;this.colPos=new Vector2d();this.width=d;this.height=f;this.hWidth=~~(d/2);this.hHeight=~~(f/2);this.tthis=new Vector2d();this.trect=new Vector2d();this.__defineGetter__("left",function(){return this.pos.x+this.colsPos.x});this.__defineGetter__("right",function(){return this.pos.x+this.colsPos.x+this.width});this.__defineGetter__("top",function(){return this.pos.y+this.colPos.y});this.__defineGetter__("bottom",function(){return this.pos.y+this.colPos.y+this.height})},set:function(e,d,f){this.pos=e;this.width=d;this.height=f;this.hWidth=~~(d/2);this.hHeight=~~(f/2)},adjustSize:function(d,e,g,f){if(d!=-1){this.colPos.x=d;this.width=e;this.hWidth=~~(this.width/2)}if(g!=-1){this.colPos.y=g;this.height=f;this.hHeight=~~(this.height/2)}},flipX:function(d){this.colPos.x=d-this.width-this.colPos.x;this.hWidth=~~(this.width/2)},flipY:function(d){this.colPos.y=d-this.height-this.colPos.y;this.hHeight=~~(this.height/2)},checkAxisAligned:function(d){this.tthis.x=this.pos.x+this.colPos.x;this.tthis.y=this.pos.y+this.colPos.y;this.trect.x=d.pos.x+d.colPos.x;this.trect.y=d.pos.y+d.colPos.y;return(this.tthis.x<this.trect.x+d.width&&this.trect.x<this.tthis.x+this.width&&this.tthis.y<this.trect.y+d.height&&this.trect.y<this.tthis.y+this.height)},collideVsAABB:function(f){p=new Vector2d(0,0);if(this.checkAxisAligned(f)){var e=this.tthis.x+this.hWidth-this.trect.x-f.hWidth;var d=this.tthis.y+this.hHeight-this.trect.y-f.hHeight;p.x=(f.hWidth+this.hWidth)-(e<0?-e:e);p.y=(f.hHeight+this.hHeight)-(d<0?-d:d);if(p.x<p.y){p.y=0;p.x=e<0?-p.x:p.x}else{p.x=0;p.y=d<0?-p.y:p.y}}return p},draw:function(d){d.strokeStyle="red";d.strokeRect(this.pos.x+this.colPos.x-me.game.viewport.pos.x,this.pos.y+this.colPos.y-me.game.viewport.pos.y,this.width,this.height)}});a.me.Vector2d=Vector2d;a.me.Rect=Rect})(window);(function(a,b){Font=Object.extend({ALIGN:{LEFT:"left",CENTER:"center",RIGHT:"right"},font:null,height:null,color:null,align:null,init:function(e,f,d,g){this.set(e,f,d,g)},bold:function(){this.font="bold "+this.font},italic:function(){this.font="italic "+this.font},set:function(e,f,d,g){this.font=""+f+"px "+e;this.height=f;this.color=d;this.align=g||"top"},measureText:function(d,e){d.font=this.font;d.fillStyle=this.color;d.textBaseLine=this.align;dim=d.measureText(e);dim.height=this.height;return dim},draw:function(e,f,d,g){e.font=this.font;e.fillStyle=this.color;e.textBaseLine=this.align;e.fillText(f,~~d,~~g)}});BitmapFont=Font.extend({size:null,sSize:null,scale:1,firstChar:32,init:function(d,e,g,f){this.parent(d,null,null);this.size=new me.Vector2d(e,0);this.sSize=new me.Vector2d();this.scale=g||1;this.firstChar=f||32;this.loadFontMetrics(d);this.align=this.ALIGN.RIGHT},loadFontMetrics:function(d){this.font=me.loader.getImage(d);this.size.y=this.font.height||0;this.sSize.copy(this.size);this.sSize.x*=this.scale;this.sSize.y*=this.scale},set:function(e,d){this.align=e;if(d){this.sSize.copy(this.size);this.sSize.x*=this.scale;this.sSize.y*=this.scale}},measureText:function(d){return{width:d.length*this.sSize.x,height:this.sSize.y}},draw:function(f,g,d,h){if(typeof(g)!="string"){g=g.toString()}if(this.align==this.ALIGN.RIGHT){d-=g.length*this.sSize.x}for(var e=0;e<g.length;e++){f.drawImage(this.font,(g.charCodeAt(e)-this.firstChar)*this.size.x,0,this.sSize.x,this.sSize.y,~~d,~~h,this.size.x,this.size.y);d+=this.sSize.x}}});a.me.Font=Font;a.me.BitmapFont=BitmapFont})(window);(function(b,d){var a=me.AnimatedSpriteObject.extend({isClickable:true,updated:false,init:function(e,h,g,f){this.parent(this,e,h,g,f)},update:function(){if(this.updated){this.updated=false;return true}return false},clicked:function(){return false},mouseEvent:function(e,f){if((e>this.pos.x)&&(e<this.pos.x+this.displayWidth)&&(f>this.pos.y)&&(f<this.pos.y+this.displayHeight)){if(this.isClickable){this.updated=this.clicked()}}return this.updated}});b.me.GUI_Object=a})(window);(function(b,d){HUD_Item=Object.extend({init:function(e,g,f){this.pos=new me.Vector2d(e||0,g||0);this.visible=true;this.defaultvalue=f||0;this.value=f||0;this.updated=true},reset:function(){this.value=this.defaultvalue;this.updated=true},update:function(e){this.value+=e;this.updated=true;return this.updated},draw:function(f,e,g){if(this.updated){this.updated=false}}});function a(e,j,f,i,g){this.pos=new me.Vector2d(e||0,j||0);this.width=f||me.video.getWidth();this.height=i||me.video.getHeight();this.bgcolor=g;this.HUDItems={};this.HUDobj=[];this.visible=true;this.HUD_invalidated=true;HUDCanvasSurface=me.video.createCanvasSurface(this.width,this.height);this.z=999;this.objCount=0}a.prototype.addItem=function(e,f){this.HUDItems[e]=f;this.HUDobj.push(this.HUDItems[e]);this.objCount++;this.HUD_invalidated=true};a.prototype.updateItemValue=function(e,f){if(this.HUDItems[e]&&(this.HUDItems[e].update(f)==true)){this.HUD_invalidated=true}};a.prototype.getItemValue=function(e){return(this.HUDItems[e])?this.HUDItems[e].value:0};a.prototype.update=function(){return this.HUD_invalidated};a.prototype.reset=function(e){if(this.HUDItems[e]){this.HUDItems[e].reset()}this.HUD_invalidated=true};a.prototype.resetAll=function(){for(var e=this.objCount,f;e--,f=this.HUDobj[e];){f.reset()}this.HUD_invalidated=true};a.prototype.draw=function(g,e,j){if(this.HUD_invalidated){if(this.bgcolor){me.video.clearSurface(HUDCanvasSurface,this.bgcolor)}else{HUDCanvasSurface.canvas.width=HUDCanvasSurface.canvas.width}for(var f=this.objCount,h;f--,h=this.HUDobj[f];){if(h.visible){h.draw(HUDCanvasSurface,e,j)}}}g.drawImage(HUDCanvasSurface.canvas,this.pos.x,this.pos.y);this.HUD_invalidated=false};b.me.HUD_Item=HUD_Item;b.me.HUD_Object=a})(window);(function(a,b){audio=(function(){var k={};var u=[];var d=["mp3","ogg","wav"];var h=null;var t=-1;var f=null;var m=null;var l=true;var s=0;function i(){var v=0;if(!me.sys.sound){l=false;return}if((h.search(/mp3/i)!=-1)&&k.capabilities.mp3){return d[v]}if((h.search(/ogg/i)!=-1)&&k.capabilities.ogg){return d[++v]}if((h.search(/wav/i)!=-1)&&k.capabilities.wav){return d[++v]}l=false;return -1}function g(w){var v=u[w];for(var x=0,y;y=v[x++];){if(y.ended||!y.currentTime){y.currentTime=s;return y}}v[0].pause();v[0].currentTime=s;return v[0]}function o(v){u[v][0].load()}function e(v,x){if(x>1){var w=u[v][0];for(channel=1;channel<x;channel++){u[v][channel]=w.cloneNode(true);u[v][channel].load()}}if(f){f()}}function q(w,v,y){var x=g(w);x.loop=v||false;x.play();if(y&&!v){x.addEventListener("ended",function(z){x.removeEventListener("ended",arguments.callee,false);y()},false)}}function j(w,v,x){if(x&&!v){setTimeout(x,2000)}}k.capabilities={mp3:false,ogg:false,ma4:false,wav:false,};k.init=function(v){if(v){h=new String(v)}else{h=new String("mp3")}t=i();if(l){k.play=q}else{k.play=j}return l};k.setLoadCallback=function(v){f=v};k.isAudioEnable=function(){return l};k.enable=function(){l=me.sys.sound;if(l){k.play=q}else{k.play=j}};k.disable=function(){l=false;k.play=j};k.load=function(w){if(t==-1){return 0}var v=new Audio(w.src+w.name+"."+t+me.nocache);v.preload="auto";v.addEventListener("canplaythrough",function(x){this.removeEventListener("canplaythrough",arguments.callee,false);e(w.name,w.channel)},false);v.addEventListener("error",function(x){o(w.name)},false);v.src=w.src+w.name+"."+t+me.nocache;v.load();u[w.name]=[v];return 1};k.stop=function(v){if(l){var w=u[v];for(channel_id=w.length;channel_id--;){w[channel_id].pause();w[channel_id].currentTime=s}}};k.pause=function(v){if(l){var w=u[v];for(channel_id=w.length;channel_id--;){w[channel_id].pause()}}};k.playTrack=function(v){if(l){if(m!=null){k.stopTrack()}m=g(v);if(m){m.loop=true;m.play()}}};k.stopTrack=function(){if(l&&m){m.pause();m=null}};k.pauseTrack=function(){if(l&&m){m.pause()}};k.resumeTrack=function(){if(l&&m){m.play()}};return k})();a.me.audio=audio})(window);(function(a,b){timer=(function(){var h={};var o=null;var d=false;var i=0;var j=0;var f=0;var m=0;var e=0;var l=0;var g=Math.ceil(1000/me.sys.fps);var q=(1000/me.sys.fps)*1.25;function k(){o.replaceChild(document.createTextNode("("+f+"/"+me.sys.fps+" fps)"),o.firstChild)}h.tick=1;h.init=function(){o=document.getElementById("framecounter");d=(o!==null);h.reset()};h.reset=function(){e=m=new Date().getTime();j=0;i=0};h.getTime=function(){return e};h.update=function(){m=e;e=new Date().getTime();l=(e-m);if(d){i++;j+=l;if(i%10==0){f=Math.ceil((1000*i)/j);k();j=0;i=0}}h.tick=(l>q&&me.sys.interpolation)?l/g:1};return h})();video=(function(){var g={};var f=null;var j=null;var k=null;var i=null;var e=null;var l=false;var h=0;var d=0;g.init=function(q,t,o,m,s){l=m;me.sys.scale=l===true?s:1;h=t*me.sys.scale;d=o*me.sys.scale;e=document.getElementById(q);f=document.createElement("canvas");f.setAttribute("width",(h)+"px");f.setAttribute("height",(d)+"px");f.setAttribute("border","0px solid black");e.appendChild(f);if(f.getContext){j=f.getContext("2d");if(l){i=g.createCanvasSurface(t,o);k=i.canvas}else{i=j;k=j.canvas}}else{return false}return true};g.getWrapper=function(){return e};g.getWidth=function(){return k.width};g.getHeight=function(){return k.height};g.createCanvasSurface=function(o,m){var q=document.createElement("canvas");q.width=o||k.width;q.height=m||k.height;return q.getContext("2d")};g.getScreenCanvas=function(){return f};g.getScreenFrameBuffer=function(){return i};g.updateDisplaySize=function(m){if(l){if(m){me.sys.scale=m}else{me.sys.scale=document.getElementById("screen size").value}h=k.width*me.sys.scale;d=k.height*me.sys.scale;f.width=h;f.height=d}};g.clearSurface=function(o,m){o.fillStyle=m;o.fillRect(0,0,o.canvas.width,o.canvas.height)};g.scale=function(m,o){m.translate(-(((m.canvas.width*o)-m.canvas.width)>>1),-(((m.canvas.height*o)-m.canvas.height)>>1));m.scale(o,o)};g.setAlpha=function(o,m){o.globalCompositeOperation=m?"source-over":"copy"};g.blitSurface=function(){if(l){g.blitSurface=function(){j.drawImage(k,0,0,k.width,k.height,0,0,h,d)}}else{g.blitSurface=function(){}}g.blitSurface()};g.applyEffect=function(x,s){var t=g.createCanvasSurface();var u=i.getImageData(0,0,k.width,k.height);var v=u.data;switch(x){case"b&w":for(var q=0,o=v.length;q<o;q+=4){var m=(3*v[q]+4*v[q+1]+v[q+2])>>>3;v[q]=m;v[q+1]=m;v[q+2]=m}break;case"brightness":var w=Math.abs(s);w=(w>1)?1:w;for(var q=0,o=v.length;q<o;q+=4){v[q]*=w;v[q+1]*=w;v[q+2]*=w}break;default:return null}t.putImageData(u,0,0);return t};return g})();a.me.timer=timer;a.me.video=video})(window);(function(a,b){input=(function(){var i={};var g=[];var l=[];var q=[];var e=[];var h=null;var k=null;var o=false;function s(u){if(u){if(!o){a.addEventListener("keydown",f,false);a.addEventListener("keyup",d,false)}}else{a.removeEventListener("keydown",f,false);a.removeEventListener("keyup",d,false)}o=u}function m(u){u.stopPropagation();if(u.preventDefault){u.preventDefault()}u.returnValue=false}function f(v){var u=g[v.keyCode||v.which];if(u){if(!e[u]){l[u]=true;e[u]=q[u]}m(v);return false}return true}function d(v){var u=g[v.keyCode||v.which];if(u){l[u]=false;e[u]=false;m(v);return false}return true}function j(v){var u=v.clientX-me.video.getScreenCanvas().offsetLeft;var w=v.clientY-me.video.getScreenCanvas().offsetTop;h(u,w)}function t(u){}i.KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,ESC:27,SPACE:32,"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,};i.isKeyPressed=function(u){if(l[u]){if(q[u]){e[u]=true;l[u]=false}return true}return false};i.keyStatus=function(u){return(e[u]===true)?true:l[u]};i.bindKey=function(u,w,v){if(!o){s(true)}g[u]=w;q[w]=v?v:false;e[w]=false};i.unbindKey=function(u){l[g[u]]=false;q[g[u]]=false;g[u]=null};i.enableMouseEvent=function(u,v){if(u){me.video.getScreenCanvas().addEventListener("click",j,false);h=v}else{me.video.getScreenCanvas().removeEventListener("click",j,false)}};i.enableGyroscopicEvent=function(u,v){if(a.sys.gyro){a.ondevicemotion=u?t:null;k=u?v:null}};return i})();a.me.input=input})(window);(function(b,d){var a=(function(){var g={};var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var h=null;function e(){if(h==null){h={};for(var j=0;j<f.length;j++){h[f[j]]=j}}}g.decodeNumBase64=function(i){e();i=i.replace(new RegExp("[^"+f.join("")+"=]","g"),"");p=(i.charAt(i.length-1)=="="?(i.charAt(i.length-2)=="="?"AA":"A"):"");r=[];i=i.substr(0,i.length-p.length)+p;for(c=0;c<i.length;c+=4){n=(h[i.charAt(c)]<<18)+(h[i.charAt(c+1)]<<12)+(h[i.charAt(c+2)]<<6)+h[i.charAt(c+3)];r.push((n>>>16)&255);r.push((n>>>8)&255);r.push(n&255)}return r};g.setNocache=function(i){me.nocache=i?"?"+parseInt(Math.random()*10000000):""};g.random=function(j,i){return(~~(Math.random()*(i-j+1))+j)};g.round=function(i,k){var j=Math.pow(10,k);return(Math.round(i*j)/j)};g.HexToRGB=function(j,i){j=(j.charAt(0)=="#")?j.substring(1,7):j;rgb=(i?"rgba(":"rgb(")+parseInt(j.substring(0,2),16);rgb+=","+parseInt(j.substring(2,4),16);rgb+=","+parseInt(j.substring(4,6),16)+(i?","+i+")":")");return rgb};return g})();b.me.utils=a})(window);(function(b,d){function a(e){this.defaultvalue=e||0;this.value=e||0;this.updated=true}a.prototype.reset=function(){this.value=this.defaultvalue;this.updated=true};a.prototype.update=function(e){this.value+=e;this.updated=true;return this.updated};gamestat=(function(){var g={};var f={};var h=[];var e=0;g.add=function(i,j){f[i]=new a(j);h.push(f[i]);e++};g.updateValue=function(i,j){if(f[i]){f[i].update(j)}};g.getItemValue=function(i){return(f[i])?f[i].value:0};g.reset=function(i){if(i!=d){if(f[i]){f[i].reset()}}else{g.resetAll()}};g.resetAll=function(){for(var j=e,k;j--,k=h[j];){k.reset()}};return g})();b.me.gamestat=gamestat})(window);(function(b,e){var a=Math.min,d=Math.max;ViewportEntity=me.Rect.extend({AXIS:null,limits:null,target:null,follow_axis:0,_shake:null,_fadeIn:null,_fadeOut:null,init:function(f,k,j,i,g,h){this.parent(new me.Vector2d(f,k),j-f,i-k);this.limits=new me.Vector2d(g||this.width,h||this.height);this.setDeadzone(this.width/6,this.height/3);this.target=null;this.AXIS={NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3};this.follow_axis=this.AXIS.NONE;this._shake={intensity:0,duration:0,axis:this.AXIS.BOTH,onComplete:null};this._fadeOut={color:0,alpha:0,duration:0,onComplete:null};this._fadeIn={color:0,alpha:0,duration:0,onComplete:null}},_followH:function(f){if((f.x-this.pos.x)>(this.width-this.deadzone.x)){this.pos.x=a((~~f.x)-(this.width-this.deadzone.x),this.limits.x-this.width)}else{if((f.x-this.pos.x)<(this.deadzone.x)){this.pos.x=d((~~f.x)-this.deadzone.x,0)}}},_followV:function(f){if((f.y-this.pos.y)>(this.height-this.deadzone.y)){this.pos.y=a((~~f.y)-(this.height-this.deadzone.y),this.limits.y-this.height)}else{if((f.y-this.pos.y)<(this.deadzone.y)){this.pos.y=d((~~f.y)-this.deadzone.y,0)}}},reset:function(f,g){this.pos.x=f||0;this.pos.y=g||0;this.target=null;this.follow_axis=null},setDeadzone:function(f,g){this.deadzone=new me.Vector2d((this.width-f)/2,(this.height-g)/2-g*0.25)},setBounds:function(f,g){this.limits.set(f,g)},follow:function(g,f){this.target=g;this.follow_axis=f||this.AXIS.NONE},move:function(f,g){newx=this.pos.x+f;newy=this.pos.y+g;if((newx>=0)&&(newx<=this.limits.x-this.width)){this.pos.x=newx}if((newy>=0)&&(newy<=this.limits.y-this.height)){this.pos.y=newy}},update:function(h){if(this.target&&(h||(this._shake.duration>0))){switch(this.follow_axis){case this.AXIS.NONE:break;case this.AXIS.HORIZONTAL:this._followH(this.target);break;case this.AXIS.VERTICAL:this._followV(this.target);break;case this.AXIS.BOTH:this._followH(this.target);this._followV(this.target);break;default:break}}if(this._shake.duration>0){this._shake.duration-=me.timer.tick;if(this._shake.duration<0){if(this._shake.onComplete){this._shake.onComplete()}}else{if((this._shake.axis==this.AXIS.BOTH)||(this._shake.axis==this.AXIS.HORIZONTAL)){var g=(Math.random()*this._shake.intensity);if(this.pos.x+this.width+g<this.limits.x){this.pos.x+=~~g}else{this.pos.x-=~~g}}if((this._shake.axis==this.AXIS.BOTH)||(this._shake.axis==this.AXIS.VERTICAL)){var f=(Math.random()*this._shake.intensity);if(this.pos.y+this.height+f<this.limits.y){this.pos.y+=~~f}else{this.pos.y-=~~f}}h=true}}if(this._fadeIn.alpha<1){this._fadeIn.alpha+=me.timer.tick/this._fadeIn.duration;if(this._fadeIn.alpha>=1){this._fadeIn.alpha=1;if(this._fadeIn.onComplete){this._fadeIn.onComplete()}}h=true}if(this._fadeOut.alpha>0){this._fadeOut.alpha-=me.timer.tick/this._fadeOut.duration;if(this._fadeOut.alpha<=0){this._fadeOut.alpha=0;if(this._fadeOut.onComplete){this._fadeOut.onComplete()}}h=true}return h},shake:function(f,i,g,h){g=g||this.AXIS.BOTH;if(g==this.AXIS.BOTH){if(this.width==this.limits.x){g=this.AXIS.VERTICAL}else{if(this.height==this.limits.y){g=this.AXIS.HORIZONTAL}}}if((g==this.AXIS.HORIZONTAL)&&(this.width==this.limits.x)){return}if((g==this.AXIS.VERTICAL)&&(this.height==this.limits.y)){return}this._shake.intensity=f;this._shake.duration=i;this._shake.axis=g;this._shake.onComplete=h||null},fadeOut:function(f,h,g){this._fadeOut.color=f;this._fadeOut.duration=h||30;this._fadeOut.alpha=1;this._fadeOut.onComplete=g||null},fadeIn:function(f,h,g){this._fadeIn.color=f;this._fadeIn.duration=h||30;this._fadeIn.alpha=0;this._fadeIn.onComplete=g||null},getWidth:function(){return this.width},getHeight:function(){return this.height},focusOn:function(f){this.pos.x=f.x-this.width*0.5;this.pos.y=f.y-this.height*0.5},isVisible:function(f){return this.checkAxisAligned(f)},draw:function(f){if(this._fadeIn.alpha<1){me.video.clearSurface(f,me.utils.HexToRGB(this._fadeIn.color,this._fadeIn.alpha))}if(this._fadeOut.alpha>0){me.video.clearSurface(f,me.utils.HexToRGB(this._fadeOut.color,this._fadeOut.alpha))}}});b.me.Viewport=ViewportEntity})(window);(function(e,g){var b=Math.min;var a=(function(){var i={};var h={};i.init=function(){i.add("me.LevelEntity",LevelEntity)};i.add=function(k,j){h[k.toLowerCase()]=j};i.newIstanceOf=function(j){if(!h[j.name]){alert("cannot instance entity of type '"+j.name+"': Class not found!");return null}return new h[j.name](j.x,j.y,j)};return i})();e.me.entityPool=a;function f(h,j,i){this.image=me.loader.getImage(h);this.spriteWidth=this.image.width;this.spriteHeight=this.image.height;this.baseOffset=0;this.z=i||0;this.scrollspeed=j;this.vp_width=me.game.viewport.width}f.prototype.draw=function(k,h,l){var j=0;var i=b(this.spriteWidth-h,this.vp_width);do{k.drawImage(this.image,h,0,i,this.spriteHeight,j,l,i,this.spriteHeight);j+=i;h=0;i=b(this.spriteWidth,this.vp_width-j)}while((j<this.vp_width))};function d(h){this.name="parallaxBackgroundEntity";this.visible=true;this.z=h||0;this.vp=me.game.viewport.pos;this.lastx=this.vp.x;this.parallaxLayers=[];this.parallaxLayersCount=0;this.addLayer=function(i,k,j){this.parallaxLayers.push(new f(i,k,j));this.parallaxLayersCount=0};this.clearTile=function(i,j){};this.update=function(){return false};this.draw=function(m,j,o){j=this.vp.x;if(j>this.lastx){for(var l=0,k;k=this.parallaxLayers[l++];){k.baseOffset=(k.baseOffset+k.scrollspeed*me.timer.tick)%k.spriteWidth;k.draw(m,~~k.baseOffset,o);this.lastx=j}return}else{if(j<this.lastx){for(var l=0,k;k=this.parallaxLayers[l++];){k.baseOffset=(k.spriteWidth+(k.baseOffset-k.scrollspeed*me.timer.tick))%k.spriteWidth;k.draw(m,~~k.baseOffset,o);this.lastx=j}return}}for(var l=0,k;k=this.parallaxLayers[l++];){k.draw(m,~~k.baseOffset,o);this.lastx=j}}}e.me.ParallaxBackgroundEntity=d;AnimationSheet=me.AnimatedSpriteObject.extend({init:function(h,k,j,i){this.anim=[];this.resetAnim=null;this.current=null;this.parent(h,k,j,i);if(this.image==g){this.visible=false}else{if(this.image.width==i){this.update=function(){return false}}else{this.addAnimation("default",null);this.setCurrentAnimation("default")}}},addAnimation:function(j,l){this.anim[j]={name:null,frame:[],idx:0,length:0};if(l==null){for(var k=0;k<this.spritecount;k++){this.anim[j].frame[k]=k*this.spriteWidth}}else{var h=0;for(var k=0;k<l.length;k++){this.anim[j].frame[h]=l[k]*this.spriteWidth;h++}}this.anim[j].name=j;this.anim[j].length=this.anim[j].frame.length},setCurrentAnimation:function(h,i){this.current=this.anim[h];this.resetAnim=i||null;this.currentSpriteOff=this.current.frame[this.current.idx]},isCurrentAnimation:function(h){return(this.current.name==h)},setCurrentSprite:function(h){this.current.idx=h;this.currentSpriteOff=this.current.frame[h]},update:function(){if(this.visible&&(this.fpscount++>this.animationspeed)){this.setCurrentSprite(++this.current.idx%this.current.length);if((this.current.idx==0)&&this.resetAnim){this.setCurrentAnimation(this.resetAnim)}this.fpscount=0;return true}return false}});e.me.AnimationSheet=AnimationSheet;ObjectEntity=AnimationSheet.extend({init:function(h,j,i){this.parent(h,j,(typeof i.image=="string")?me.loader.getImage(i.image):i.image,i.spritewidth);this.pos.set(h,j+me.game.currentLevel.tileheight-this.spriteHeight);this.vel=new me.Vector2d();this.accel=new me.Vector2d();this.gravity=0.98;this.isEntity=true;this.canBreakTile=false;this.alive=true;this.falling=false;this.jumping=false;this.jumpspeed=0;this.slopeY=0;this.onslope=false;this.onladder=false;this.collidable=false;this.collectable=false;this.flickering=false;this.flickerTimer=-1;this.flickercb=null;this.collisionMap=me.game.collisionMap;this.onTileBreak=null},setVelocity:function(h,i){this.accel.x=(h!=0)?h:this.accel.x;this.accel.y=(h!=0)?i:this.accel.y},doWalk:function(h){this.flipX(h);this.vel.x=(h)?-this.accel.x*me.timer.tick:this.accel.x*me.timer.tick},doClimb:function(h){if(this.onladder){this.vel.y=(h)?-this.accel.x*me.timer.tick:this.accel.x*me.timer.tick;return true}return false},doJump:function(){if(!this.jumping&&!this.falling){this.jumpspeed=this.accel.y;this.jumping=true;if(this.onslope){console.log("jump on slope")}return true}return false},forceJump:function(){this.jumping=false;this.falling=false;this.doJump()},checkSlope:function(h,i){this.vel.y=h.pos.y-this.pos.y-this.displayHeight;this.slopeY=this.pos.x+(this.displayWidth>>1)+this.vel.x-h.pos.x;if(this.slopeY>h.height){this.slopeY=h.height}this.vel.y+=i?h.height-this.slopeY:this.slopeY;console.log(this.vel.y)},updateMovement:function(){if(this.jumping){this.jumpspeed-=this.gravity;if((this.jumpspeed<0)){this.jumping=false;this.falling=true;this.vel.y=0}else{this.vel.y=-this.jumpspeed}}else{if(!this.onladder){this.falling=true;this.vel.y+=this.gravity*me.timer.tick}}var h=this.collisionMap.checkCollision(this.collisionBox,this.vel);this.onladder=h.xprop.isLadder;this.onslope=h.yprop.isSlope||h.xprop.isSlope;if(h.y){if(this.vel.y>0){if(h.yprop.isSolid||(h.yprop.isPlatform&&(~~this.pos.y+this.displayHeight<=h.ytile.pos.y))){this.vel.y=(this.falling)?h.ytile.pos.y-this.pos.y-this.displayHeight:0;console.log("solid");this.falling=false}else{if(h.yprop.isSlope){console.log("yslope");this.checkSlope(h.ytile,h.yprop.isLeftSlope);this.falling=false}else{if(h.yprop.isBreakable&&this.canBreakTile){me.game.currentLevel.clearTile(h.ytile.row,h.ytile.col);if(this.onTileBreak){this.onTileBreak()}}}}}else{if(this.vel.y<0){if(!h.yprop.isPlatform&&!h.yprop.isLadder){this.jumping=false;this.falling=true;this.vel.y=0}}}}if(h.x){if(this.onslope){if(!h.yprop.isSlope&&this.falling){this.checkSlope(h.xtile,h.xprop.isLeftSlope);console.log("xslope")}}else{if(!h.xprop.isPlatform&&!h.xprop.isLadder){if(h.xprop.isBreakable&&this.canBreakTile){me.game.currentLevel.clearTile(h.xtile.row,h.xtile.col);if(this.onTileBreak){this.onTileBreak()}}else{this.vel.x=0}}}}this.updateFlickering();if((this.vel.x!=0)||(this.vel.y!=0)){this.pos.add(this.vel);if((this.onslope&&!this.jumping)||this.onladder){this.vel.y=0}return true}return false},updateFlickering:function(){if(this.flickering){this.flickerTimer-=me.timer.tick;if(this.flickerTimer<0){if(this.flickercb){this.flickercb()}this.flicker(-1)}else{this.visible=!this.visible;return true}}return false},flicker:function(h,i){this.flickerTimer=h;if(this.flickerTimer<0){this.flickering=false;this.visible=true;this.flickercb=null}else{if(!this.flickering){this.flickercb=i;this.flickering=true}}}});e.me.ObjectEntity=ObjectEntity;CollectableEntity=ObjectEntity.extend({init:function(h,j,i){this.parent(h,j,i);this.collisionEnable=true;this.collidable=true;this.type=me.game.COLLECTABLE_OBJECT}});e.me.CollectableEntity=CollectableEntity;InvisibleEntity=ObjectEntity.extend({init:function(h,j,i){i.image=g;this.parent(h,j,i);this.pos=new me.Vector2d(h,j);this.collisionBox=new me.Rect(this.pos,i.width,i.height);this.collidable=true;this.isEntity=true},draw:function(h){if(me.debug.renderHitBox){this.collisionBox.draw(h)}},update:function(){return false}});e.me.InvisibleEntity=InvisibleEntity;LevelEntity=InvisibleEntity.extend({init:function(h,j,i){this.parent(h,j,i);this.nextlevel=i.to},goTo:function(i){var h=i||this.nextlevel;me.levelDirector.loadLevel(h)},onCollision:function(){this.goTo()}});e.me.LevelEntity=LevelEntity})(window);(function(g,e){removepath=/^.*(\\|\/|\:)/;removeext=/\.[^\.]*$/;var b={COLLISION_MAP:"collision",PARALLAX_MAP:"parallax",};var i=me.Rect.extend({init:function(k,q,l,m,o){this.parent(new me.Vector2d(k*l,q*m),l,m);this.tileId=o;this.row=k;this.col=q}});function j(m,o,l,s,q,k){this.name=m;this.tilewidth=o;this.tileheight=l;this.spacing=s;this.margin=q;this.image=(k)?me.loader.getImage(k.replace(removepath,"").replace(removeext,"")):null;this.type={SOLID:"solid",PLATFORM:"platform",L_SLOPE:"lslope",R_SLOPE:"rslope",LADDER:"ladder",BREAKABLE:"breakable"};this.TileProperties=[];if(this.image){this.hTileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing));this.vTileCount=~~((this.image.height-this.margin)/(this.tileheight+this.spacing))}}j.prototype.getPropertyList=function(){return{isCollidable:false,isSolid:false,isPlatform:false,isSlope:false,isLeftSlope:false,isRightSlope:false,isLadder:false,isBreakable:false}};j.prototype.getTileProperties=function(k){return this.TileProperties[k]};j.prototype.isTileCollidable=function(k){return this.TileProperties[k].isCollidable};j.prototype.getTileImage=function(l){var k=me.video.createCanvasSurface(this.tilewidth,this.tileheight);this.drawTile(k,0,0,l);return k.canvas};j.prototype.drawTile=function(l,k,s,q){var o=this.margin+(this.spacing+this.tilewidth)*(q%this.hTileCount);var m=this.margin+(this.spacing+this.tileheight)*~~(q/this.hTileCount);l.drawImage(this.image,o,m,this.tilewidth,this.tileheight,k,s,this.tilewidth,this.tileheight)};function h(k,l){this.realwidth=k;this.realheight=l;this.isCollisionMap=true}h.prototype.checkCollision=function(o,l){var k=(l.x<0)?o.pos.x+o.colPos.x+l.x:o.pos.x+o.colPos.x+o.width+l.x-1;var q=(l.y<0)?o.pos.y+o.colPos.y+l.y:o.pos.y+o.colPos.y+o.height+l.y;var m={x:false,y:false,tile:e,xprop:{},yprop:{}};if(k<=0||k>=this.realwidth){m.x=true}if(q<=0||q>=this.realheight){m.y=true}return m};function d(k,l,m,o){this.width=k;this.height=l;this.z=o;this.name=null;this.visible=false;this.layerData=null;this.xLUT={};this.yLUT={};this.tileset=m;if(m){this.tilewidth=m.tilewidth;this.tileheight=m.tileheight}else{this.tilewidth=0;this.tileheight=0}this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight}d.prototype.initArray=function(l){this.layerData=[];for(var k=0;k<this.width+1;k++){this.layerData[k]=[];for(var m=0;m<this.height+1;m++){this.layerData[k][m]=null}}if(l){for(var k=0;k<this.width*this.tilewidth;k++){this.xLUT[k]=~~(k/this.tilewidth)}for(var m=0;m<this.height*this.tileheight;m++){this.yLUT[m]=~~(m/this.tileheight)}}};d.prototype.getTileId=function(k,m){var l=this.layerData[this.xLUT[~~k]][this.yLUT[~~m]];return l?l.tileId:null};d.prototype.getTile=function(k,l){return this.layerData[this.xLUT[~~k]][this.yLUT[~~l]]};d.prototype.setTile=function(k,m,l){this.layerData[k][m]=new i(k,m,this.tilewidth,this.tileheight,l)};d.prototype.clearTile=function(k,l){this.layerData[k][l]=null};d.prototype.checkCollision=function(o,l){var k=(l.x>0)?o.pos.x+o.colPos.x+o.width+l.x-1:o.pos.x+o.colPos.x+l.x;var q=(l.y>0)?o.pos.y+o.colPos.y+o.height+l.y:o.pos.y+o.colPos.y+l.y;var m={x:false,xtile:e,xprop:{},y:false,ytile:e,yprop:{}};console.log(o.colPos.x);if(k<=0||k>=this.realwidth){m.x=true}else{m.xtile=this.getTile(k,o.pos.y+o.colPos.y+o.height-1);if(m.xtile&&this.tileset.isTileCollidable(m.xtile.tileId)){m.x=true;m.xprop=this.tileset.getTileProperties(m.xtile.tileId)}else{m.xtile=this.getTile(k,o.pos.y+o.colPos.y);if(m.xtile&&this.tileset.isTileCollidable(m.xtile.tileId)){m.x=true;m.xprop=this.tileset.getTileProperties(m.xtile.tileId)}}}m.ytile=this.getTile(o.pos.x+l.x+o.colPos.x,q);if(m.ytile&&this.tileset.isTileCollidable(m.ytile.tileId)){m.y=true;m.yprop=this.tileset.getTileProperties(m.ytile.tileId)}else{m.ytile=this.getTile(o.pos.x+ +l.x+o.colPos.x+o.width,q);if(m.ytile&&this.tileset.isTileCollidable(m.ytile.tileId)){m.y=true;m.yprop=this.tileset.getTileProperties(m.ytile.tileId)}}return m};d.prototype.update=function(){return false};function f(k,l){this.pos=new me.Vector2d(k,l);this.z=0;this.width=0;this.height=0;this.realwidth=-1;this.realheight=-1;this.tilewidth=0;this.tileheight=0;this.tileset=[];this.mapLayers=[];this.objectGroups=[];this.initialized=false}f.prototype.reset=function(){this.tileset=[];this.mapLayers=[];this.objectGroups=[];this.initialized=false};f.prototype.getObjectGroupByName=function(k){return this.objectGroups[k]};f.prototype.getObjectGroups=function(){return this.objectGroups};f.prototype.getLayerByName=function(k){var m=null;k=k.trim().toLowerCase();for(var l=this.mapLayers.length;l--;){if(this.mapLayers[l].name.contains(k)){m=this.mapLayers[l];break}}if((k.contains(b.COLLISION_MAP))&&(m==null)){m=new h(me.game.currentLevel.realwidth,me.game.currentLevel.realheight)}return m};f.prototype.clearTile=function(k,m){for(var l=this.mapLayers.length;l--;){if(this.mapLayers[l].visible||this.mapLayers[l].isCollisionMap){this.mapLayers[l].clearTile(k,m)}}};f.prototype.addTo=function(k){if(this.visible){k.add(this)}for(var l=this.mapLayers.length;l--;){if(this.mapLayers[l].visible){k.add(this.mapLayers[l])}}};f.prototype.update=function(){return false};var a=(function(){var m={};var k={};var l=null;m.reset=function(){};m.addLevel=function(o){console.log("no level loader defined")};m.addTMXLevel=function(o,q){if(k[o]==null){k[o]=new me.TMXTileMap(o,0,0)}if(q){q()}};m.loadLevel=function(o){if(k[o]===e){console.log("level %s not found",o);return}if(k[o] instanceof me.TMXTileMap){me.state.pause();me.game.reset();k[o].reset();k[o].load();l=o;me.game.loadTMXLevel(k[l]);me.state.resume()}else{console.log("no level loader defined")}};m.getCurrentLevelId=function(){return l},m.reloadLevel=function(){return m.loadLevel(l)},m.nextLevel=function(){if(l+1<k.length){return m.loadLevel(l+1)}else{return false}};m.previousLevel=function(){if(l-1>=0){return m.loadLevel(l-1)}else{return false}};m.goToLevel=function(o){m.loadLevel(o)};return m})();g.me.Tile=i;g.me.TileSet=j;g.me.TiledLayer=d;g.me.TileMap=f;g.me.LevelConstants=b;g.me.levelDirector=a})(window);(function(B,l){var R="map",C="name",w="value",G="version",O="orientation",J="width",H="height",F="opacity",q="tilewidth",a="tileheight",s="firstgid",h="gid",x="tile",y="id",o="data",u="compression",k="encoding",e="base64",Q="spacing",P="margin",v="properties",m="property",N="image",g="source",j="visible",E="tileset",M="layer",K="objectgroup",t="object",A="x",z="y",J="width",H="height";function f(W,V){var T=V.getElementsByTagName(v)[0];if(T){var S=T.getElementsByTagName(m);for(var U=0;U<S.length;U++){L(W,S[U])}}}function L(S,V){var U=me.XMLParser.getStringAttribute(V,C);var T=me.XMLParser.getStringAttribute(V,w);if(!T||T.isBoolean()){T=T?(T=="true"):true}else{if(T.isNumeric()){T=parseInt(T)}}S[U]=T}function I(T,S,U){me.TileMap.call(this,S,U);this.xmlMap=me.loader.getXML(T);if(!this.xmlMap){alert(T+" map not found");return}this.version="";this.orientation="";this.tileMapCanvas=null}I.prototype=new me.TileMap();I.prototype.load=function(){if(this.initialized){return}var X=0,Z=1;me.XMLParser.parseFromString(this.xmlMap);var aa=me.XMLParser.getAllTagElements();for(var Y=0;Y<aa.length;Y++){var V=aa.item(Y).nodeName;switch(V){case R:var T=aa.item(Y);this.version=me.XMLParser.getStringAttribute(T,G);this.orientation=me.XMLParser.getStringAttribute(T,O);this.width=me.XMLParser.getIntAttribute(T,J);this.height=me.XMLParser.getIntAttribute(T,H);this.tilewidth=me.XMLParser.getIntAttribute(T,q);this.tileheight=me.XMLParser.getIntAttribute(T,a);this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight;this.z=X++;if(this.orientation!="orthogonal"){alert("%s type tilemap not supported!",this.orientation);return}f(this,T);if(this.background_color){this.visible=true;this.background_color=me.utils.HexToRGB(this.background_color)}else{this.visible=false}break;case E:this.tileset.push(new D(aa.item(Y)));break;case M:var U=me.XMLParser.getStringAttribute(aa.item(Y),C);if(U.contains(me.LevelConstants.COLLISION_MAP)){this.mapLayers.push(new d(aa.item(Y),this.tileset,X++))}else{if(U.contains(me.LevelConstants.PARALLAX_MAP)){var W=(me.XMLParser.getIntAttribute(aa.item(Y),j,1)==1);if(W){var ab={};f(ab,aa.item(Y));parallax_layer=this.getLayerByName(me.LevelConstants.PARALLAX_MAP);if(!parallax_layer){parallax_layer=new me.ParallaxBackgroundEntity(X);this.mapLayers.push(parallax_layer)}parallax_layer.addLayer(ab.imagesrc,Z++,X++)}}else{this.mapLayers.push(new d(aa.item(Y),this.tileset,X++));X++}}break;case K:var S=me.XMLParser.getStringAttribute(aa.item(Y),C);this.objectGroups.push(new i(S,aa.item(Y),this.tileset[0],X++));break}}me.XMLParser.free();this.initialized=true};I.prototype.draw=function(S){me.video.clearSurface(S,this.background_color)};function D(T){this.firstgid=me.XMLParser.getIntAttribute(T,s);me.TileSet.call(this,me.XMLParser.getStringAttribute(T,C),me.XMLParser.getIntAttribute(T,q),me.XMLParser.getIntAttribute(T,a),me.XMLParser.getIntAttribute(T,Q,0),me.XMLParser.getIntAttribute(T,P,0),T.getElementsByTagName(N)[0].getAttribute(g));var S=T.getElementsByTagName(x);for(var U=0;U<S.length;U++){var V=me.XMLParser.getIntAttribute(S[U],y)+this.firstgid;this.TileProperties[V]={};tileProp=this.TileProperties[V];f(tileProp,S[U]);tileProp.isSolid=tileProp.type?tileProp.type.toLowerCase()===this.type.SOLID:false;tileProp.isPlatform=tileProp.type?tileProp.type.toLowerCase()===this.type.PLATFORM:false;tileProp.isLeftSlope=tileProp.type?tileProp.type.toLowerCase()===this.type.L_SLOPE:false;tileProp.isRightSlope=tileProp.type?tileProp.type.toLowerCase()===this.type.R_SLOPE:false;tileProp.isBreakable=tileProp.type?tileProp.type.toLowerCase()===this.type.BREAKABLE:false;tileProp.isLadder=tileProp.type?tileProp.type.toLowerCase()===this.type.LADDER:false;tileProp.isSlope=tileProp.isLeftSlope||tileProp.isRightSlope;tileProp.isCollidable=tileProp.isSolid||tileProp.isPlatform||tileProp.isSlope||tileProp.isLadder||tileProp.isBreakable}}D.prototype=new me.TileSet();function d(T,X,V){me.TiledLayer.call(this,me.XMLParser.getIntAttribute(T,J),me.XMLParser.getIntAttribute(T,H),X[0],V);this.layerInvalidated=true;this.name=me.XMLParser.getStringAttribute(T,C);this.visible=(me.XMLParser.getIntAttribute(T,j,1)==1);this.opacity=me.XMLParser.getFloatAttribute(T,F,1);f(this,T);this.isCollisionMap=(this.name.contains(me.LevelConstants.COLLISION_MAP));if(this.isCollisionMap){this.visible=false;if(X[1]){this.tileset=X[1]}}this.vp=me.game.viewport;var W=T.getElementsByTagName(o)[0];var U=me.XMLParser.getStringAttribute(W,k);var S=me.XMLParser.getStringAttribute(W,u);if(this.visible||this.isCollisionMap){this.layerSurface=me.video.createCanvasSurface(this.width*this.tilewidth,this.height*this.tileheight);this.layerCanvas=this.layerSurface.canvas;if(this.opacity>0&&this.opacity<1){this.layerSurface.globalAlpha=this.opacity}this.initArray(this.isCollisionMap);this.fillArray(W,U,S)}}d.prototype=new me.TiledLayer();d.prototype.fillArray=function(Y,W,U){if(U!=null){alert(U+" compressed tilemap not supported!");return}if(W==e){var X=me.utils.decodeNumBase64(Y.childNodes[0].nodeValue)}else{var X=Y.getElementsByTagName(x)}var T=0;for(var Z=0;Z<this.height;Z++){for(var S=0;S<this.width;S++){if(W==e){var V=X[T]|X[T+1]<<8|X[T+2]<<16|X[T+3]<<24;T+=4}else{var V=me.XMLParser.getIntAttribute(X[T++],h)}if(V>0){this.setTile(S,Z,V);if(this.visible){this.tileset.drawTile(this.layerSurface,S*this.tilewidth,Z*this.tileheight,this.layerData[S][Z].tileId-this.tileset.firstgid)}}else{}}}};d.prototype.clearTile=function(S,T){me.TiledLayer.prototype.clearTile.call(this,S,T);this.layerSurface.clearRect(S*this.tilewidth,T*this.tileheight,this.tilewidth,this.tileheight)};d.prototype.draw=function(T,S,U){T.drawImage(this.layerCanvas,this.vp.pos.x,this.vp.pos.y,this.vp.width,this.vp.height,S,U,this.vp.width,this.vp.height)};function i(T,S,W,X){this.objects=[];this.name=T;this.width=me.XMLParser.getIntAttribute(S,J);this.height=me.XMLParser.getIntAttribute(S,H);this.z=X;var V=S.getElementsByTagName(t);for(var U=0;U<V.length;U++){this.objects.push(new b(V[U],W,X))}}i.prototype.getObjectCount=function(){return this.objects.length};i.prototype.getObjectByIndex=function(S){return this.objects[S]};function b(T,S,U){this.name=me.XMLParser.getStringAttribute(T,C);this.x=me.XMLParser.getIntAttribute(T,A);this.y=me.XMLParser.getIntAttribute(T,z);this.z=U;this.gid=me.XMLParser.getIntAttribute(T,h,null);if(this.gid){this.width=S.tilewidth;this.height=S.tileheight;this.spritewidth=this.width;this.y-=this.height;this.image=S.getTileImage(this.gid-S.firstgid)}else{this.width=me.XMLParser.getIntAttribute(T,J,0);this.height=me.XMLParser.getIntAttribute(T,H,0)}f(this,T)}b.prototype.getObjectPropertyByName=function(S){return this[S]};B.me.TMXTileMap=I})(window);
/*!
 * Tween JS
 * https://github.com/sole/Tween.js
 *
 * author sole / http://soledadpenades.com
 * author mr.doob / http://mrdoob.com
 * author Robert Eisele / http://www.xarg.org
 * author Philippe / http://philippe.elsass.me
 * author Robert Penner / http://www.robertpenner.com/easing_terms_of_use.html
 */
(function(a,b){Tween=function(g){var o=g,m={},j={},k={},h=1000,l=0,d=null,q=Tween.Easing.Linear.EaseNone,f=null,i=null,e=null;this.to=function(s,u){if(u!==null){h=u}for(var t in s){if(o[t]===null){continue}k[t]=s[t]}return this};this.start=function(){me.game.add(this,999);d=me.timer.getTime()+l;for(var s in k){if(o[s]===null){continue}m[s]=o[s];j[s]=k[s]-o[s]}return this};this.stop=function(){this.destroy();return this};this.delay=function(s){l=s;return this};this.easing=function(s){q=s;return this};this.chain=function(s){f=s};this.onUpdate=function(s){i=s;return this};this.onComplete=function(s){e=s;return this};this.update=function(){var u,s,t;var v=me.timer.getTime();if(v<d){return true}s=(v-d)/h;s=s>1?1:s;t=q(s);for(u in j){o[u]=m[u]+j[u]*t}if(i!==null){i.call(o,t)}if(s==1){this.destroy();if(e!==null){e.call(o)}if(f!==null){f.start()}return false}return true};this.destroy=function(){me.game.remove(this)}};Tween.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}};Tween.Easing.Linear.EaseNone=function(d){return d};Tween.Easing.Quadratic.EaseIn=function(d){return d*d};Tween.Easing.Quadratic.EaseOut=function(d){return -d*(d-2)};Tween.Easing.Quadratic.EaseInOut=function(d){if((d*=2)<1){return 0.5*d*d}return -0.5*(--d*(d-2)-1)};Tween.Easing.Cubic.EaseIn=function(d){return d*d*d};Tween.Easing.Cubic.EaseOut=function(d){return --d*d*d+1};Tween.Easing.Cubic.EaseInOut=function(d){if((d*=2)<1){return 0.5*d*d*d}return 0.5*((d-=2)*d*d+2)};Tween.Easing.Quartic.EaseIn=function(d){return d*d*d*d};Tween.Easing.Quartic.EaseOut=function(d){return -(--d*d*d*d-1)};Tween.Easing.Quartic.EaseInOut=function(d){if((d*=2)<1){return 0.5*d*d*d*d}return -0.5*((d-=2)*d*d*d-2)};Tween.Easing.Quintic.EaseIn=function(d){return d*d*d*d*d};Tween.Easing.Quintic.EaseOut=function(d){return(d=d-1)*d*d*d*d+1};Tween.Easing.Quintic.EaseInOut=function(d){if((d*=2)<1){return 0.5*d*d*d*d*d}return 0.5*((d-=2)*d*d*d*d+2)};Tween.Easing.Sinusoidal.EaseIn=function(d){return -Math.cos(d*Math.PI/2)+1};Tween.Easing.Sinusoidal.EaseOut=function(d){return Math.sin(d*Math.PI/2)};Tween.Easing.Sinusoidal.EaseInOut=function(d){return -0.5*(Math.cos(Math.PI*d)-1)};Tween.Easing.Exponential.EaseIn=function(d){return d==0?0:Math.pow(2,10*(d-1))};Tween.Easing.Exponential.EaseOut=function(d){return d==1?1:-Math.pow(2,-10*d)+1};Tween.Easing.Exponential.EaseInOut=function(d){if(d==0){return 0}if(d==1){return 1}if((d*=2)<1){return 0.5*Math.pow(2,10*(d-1))}return 0.5*(-Math.pow(2,-10*(d-1))+2)};Tween.Easing.Circular.EaseIn=function(d){return -(Math.sqrt(1-d*d)-1)};Tween.Easing.Circular.EaseOut=function(d){return Math.sqrt(1- --d*d)};Tween.Easing.Circular.EaseInOut=function(d){if((d/=0.5)<1){return -0.5*(Math.sqrt(1-d*d)-1)}return 0.5*(Math.sqrt(1-(d-=2)*d)+1)};Tween.Easing.Elastic.EaseIn=function(e){var f,d=0.1,g=0.4;if(e==0){return 0}if(e==1){return 1}if(!g){g=0.3}if(!d||d<1){d=1;f=g/4}else{f=g/(2*Math.PI)*Math.asin(1/d)}return -(d*Math.pow(2,10*(e-=1))*Math.sin((e-f)*(2*Math.PI)/g))};Tween.Easing.Elastic.EaseOut=function(e){var f,d=0.1,g=0.4;if(e==0){return 0}if(e==1){return 1}if(!g){g=0.3}if(!d||d<1){d=1;f=g/4}else{f=g/(2*Math.PI)*Math.asin(1/d)}return(d*Math.pow(2,-10*e)*Math.sin((e-f)*(2*Math.PI)/g)+1)};Tween.Easing.Elastic.EaseInOut=function(e){var f,d=0.1,g=0.4;if(e==0){return 0}if(e==1){return 1}if(!g){g=0.3}if(!d||d<1){d=1;f=g/4}else{f=g/(2*Math.PI)*Math.asin(1/d)}if((e*=2)<1){return -0.5*(d*Math.pow(2,10*(e-=1))*Math.sin((e-f)*(2*Math.PI)/g))}return d*Math.pow(2,-10*(e-=1))*Math.sin((e-f)*(2*Math.PI)/g)*0.5+1};Tween.Easing.Back.EaseIn=function(d){var e=1.70158;return d*d*((e+1)*d-e)};Tween.Easing.Back.EaseOut=function(d){var e=1.70158;return(d=d-1)*d*((e+1)*d+e)+1};Tween.Easing.Back.EaseInOut=function(d){var e=1.70158*1.525;if((d*=2)<1){return 0.5*(d*d*((e+1)*d-e))}return 0.5*((d-=2)*d*((e+1)*d+e)+2)};Tween.Easing.Bounce.EaseIn=function(d){return 1-Tween.Easing.Bounce.EaseOut(1-d)};Tween.Easing.Bounce.EaseOut=function(d){if((d/=1)<(1/2.75)){return 7.5625*d*d}else{if(d<(2/2.75)){return 7.5625*(d-=(1.5/2.75))*d+0.75}else{if(d<(2.5/2.75)){return 7.5625*(d-=(2.25/2.75))*d+0.9375}else{return 7.5625*(d-=(2.625/2.75))*d+0.984375}}}};Tween.Easing.Bounce.EaseInOut=function(d){if(d<0.5){return Tween.Easing.Bounce.EaseIn(d*2)*0.5}return Tween.Easing.Bounce.EaseOut(d*2-1)*0.5+0.5};a.me.Tween=Tween})(window);