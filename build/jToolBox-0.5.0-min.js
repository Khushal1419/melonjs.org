/*
 * jToolBox JavaScript Library
 * or... my humble attempt to create a game/app framework :)
 *
 * Minified version
 *
 * Copyright (C) 2010, Olivier BIOT
 * http://olivierbiot.wordpress.com/
 * 
 * Author:Olivier Biot
 * Date:January 2010
 */
(function(e,f){var n=e.document;e.jTB=this;e.jTB.mod="jToolBox";e.sys={ua:navigator.userAgent.toLowerCase(),sound:false,storage:false,gyro:(e.DeviceMotionEvent!==f),fps:60,scale:1,};var v={mp3:false,ogg:false,ma4:false,wav:false,};e.jTB.XMLParser=null;var r=false,o=false,l=[];function j(){if(!o){if(!n.body){setTimeout(j,10)}else{o=true;for(var w=0;w<l.length;w++){l[w].call(e,[])}l=[]}}}function u(){if(r){return}r=true;if(n.addEventListener){n.addEventListener("DOMContentLoaded",j,false)}e.addEventListener("load",j,false)}onReady=function(w){u();if(o){w.call(e,[])}else{l.push(function(){return w.call(e,[])})}return this};u();if(!Function.bind){Function.prototype.bind=function(x){var w=this;return function(){return w.apply(x,arguments)}}}String.prototype.trim=function(){return(this.replace(/^\s+/,"")).replace(/\s+$/,"")};String.prototype.isNumeric=function(){return(this!=null&&!isNaN(this)&&this.trim()!="")};String.prototype.isBoolean=function(){return(this!=null&&("true"==this.trim()||"false"==this.trim()))};function p(){var w={xmlDoc:null,parser:null,parseFromString:function(x){if(e.DOMParser){parser=new DOMParser();xmlDoc=parser.parseFromString(x,"text/xml")}else{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(x)}if(xmlDoc==null){console.log("xml "+xmlDoc+" not found!")}},getFirstElementByTagName:function(x){return xmlDoc?xmlDoc.getElementsByTagName(x)[0]:null},getStringAttribute:function(y,A,z){var x=y.getAttribute(A);return x?x.trim().toLowerCase():z},getIntAttribute:function(y,A,z){var x=this.getStringAttribute(y,A,z);return x?parseInt(x):z},getBooleanAttribute:function(y,A,z){var x=this.getStringAttribute(y,A,z);return x?(x=="true"):z}};return w}var b={random:function(x,w){return(~~(Math.random()*(w-x+1))+x)},round:function(w,y){var x=Math.pow(10,y);return(Math.round(w*x)/x)},};function t(){if(n.addEventListener){n.removeEventListener("DOMContentLoaded",j,false)}var w=n.createElement("audio");if(w.canPlayType){e.sys.sound=true;v.mp3=("no"!=w.canPlayType("audio/mpeg"))&&(""!=w.canPlayType("audio/mpeg"));v.ogg=("no"!=w.canPlayType('audio/ogg; codecs="vorbis"'))&&(""!=w.canPlayType('audio/ogg; codecs="vorbis"'));v.wav=("no"!=w.canPlayType('audio/wav; codecs="1"'))&&(""!=w.canPlayType('audio/wav; codecs="1"'))}if((e.sys.ua.search("iphone")>-1)||(e.sys.ua.search("ipod")>-1)||(e.sys.ua.search("ipad")>-1)||(e.sys.ua.search("android")>-1)){e.sys.sound=false}d.init();a.init();jTB.EntityPool.init();XMLParser=new p()}e.onReady(function(){t()});var d={_htmlFPSCounter:null,framecount:0,_fps:60,_lastTime:null,_gameTick:0,debug:false,init:function(){_htmlFPSCounter=n.getElementById("framecounter");debug=(_htmlFPSCounter!==null);_lastTime=new Date();_fps=e.sys.fps},update:function(){var w=new Date();_gameTick=w.getTime()-_lastTime.getTime();if(_gameTick>999){_fps=d.framecount;d.framecount=0;_lastTime=w}d.framecount++;if(debug){_htmlFPSCounter.innerHTML="("+_fps+"/"+e.sys.fps+" fps)"}},getTickCount:function(){return 1000/_gameTick}};var m={_canvas:null,_context2D:null,_backBufferCanvas:null,_backBufferContext2D:null,_wrapper:null,_double_buffering:false,_game_width_zoom:0,_game_height_zoom:0,_font:{image:null,size:-1,firstChar:-1},init:function(y,C,x,z,B){var D=this._wrapper,w=this._game_width_zoom,A=this._game_height_zoom;_double_buffering=z;e.sys.scale=_double_buffering===true?B:1;w=C*e.sys.scale;A=x*e.sys.scale;D=n.getElementById(y);canvas=n.createElement("canvas");canvas.setAttribute("width",(w)+"px");canvas.setAttribute("height",(A)+"px");canvas.setAttribute("border","0px solid black");D.appendChild(canvas);if(canvas.getContext){this._context2D=canvas.getContext("2d");if(_double_buffering){this._backBufferContext2D=m.createCanvasSurface(C,x);this._backBufferCanvas=this._backBufferContext2D.canvas}else{this._backBufferContext2D=this._context2D}this._canvas=canvas}else{return false}return true},getWrapper:function(){return _wrapper},getWidth:function(){return this._canvas.width},getHeight:function(){return this._canvas.height},createCanvasSurface:function(x,w){var y=n.createElement("canvas");y.width=x;y.height=w;return y.getContext("2d")},getScreenCanvas:function(){return this._canvas},getScreenFrameBuffer:function(){return this._backBufferContext2D},updateDisplaySize:function(w){if(_double_buffering){if(w){e.sys.scale=w}else{e.sys.scale=n.getElementById("screen size").value}this._game_width_zoom=this._backBufferCanvas.width*e.sys.scale;this._game_height_zoom=this._backBufferCanvas.height*e.sys.scale;this._canvas.width=this._game_width_zoom;this._canvas.height=this._game_height_zoom}},clearSurface:function(x,w){x.fillStyle=w;x.fillRect(0,0,x.canvas.width,x.canvas.height)},scale:function(w,x){w.translate(-(((w.canvas.width*x)-w.canvas.width)>>1),-(((w.canvas.height*x)-w.canvas.height)>>1));w.scale(x,x)},setAlpha:function(x,w){x.globalCompositeOperation=w?"source-over":"copy"},blitSurface:function(){if(_double_buffering){this.blitSurface=function(){d.update();this._context2D.drawImage(this._backBufferCanvas,0,0,this._backBufferCanvas.width,this._backBufferCanvas.height,0,0,this._game_width_zoom,this._game_height_zoom)}}else{this.blitSurface=function(){d.update()}}this.blitSurface()},setFont:function(w,x,y){this._font.image=w;this._font.size=x;this._font.firstChar=y},setSystemFont:function(y,x,z,w){y.fillStyle=w;y.font=x;y.textBaseline=z},drawFont:function(B,w,E,D){var z=w;var C;for(var A=D.length;A--;){C=(D.charAt(A)*this._font.size)+this._font.firstChar;B.drawImage(this._font.image,C,0,this._font.size,this._font.image.height,z,E,this._font.size,this._font.image.height);z-=this._font.size}}};var k={_audio_channels:[],_supportedFormat:["mp3","ogg","wav"],requestedFormat:null,_ActiveAudioExt:-1,_load_cb:null,sound_enable:true,init:function(w){if(w){this.requestedFormat=new String(w)}else{this.requestedFormat=new String("mp3")}this._ActiveAudioExt=this.getSupportedAudioFormat();return this.sound_enable},getSupportedAudioFormat:function(){var w=0;if(!e.sys.sound){this.sound_enable=false;return}if((this.requestedFormat.search(/mp3/i)!=-1)&&v.mp3){return this._supportedFormat[w]}if((this.requestedFormat.search(/ogg/i)!=-1)&&v.ogg){return this._supportedFormat[++w]}if((this.requestedFormat.search(/wav/i)!=-1)&&v.wav){return this._supportedFormat[++w]}this.sound_enable=false;return -1},setLoadCallback:function(w){this._load_cb=w},soundLoadError:function(w){this._audio_channels[w][0].load()},soundLoaded:function(w,z){if(z>1){var x=this._audio_channels[w][0];for(var y=1;y<z;y++){this._audio_channels[w][y]=x.cloneNode(true)}}if(this._load_cb){this._load_cb()}},load:function(x){if(this._ActiveAudioExt==-1){return 0}var w=n.createElement("audio");w.autobuffer=true;w.preload="auto";w.addEventListener("canplaythrough",function(y){w.removeEventListener("canplaythrough",arguments.callee,false);k.soundLoaded(x.name,x.channel)},false);w.addEventListener("error",function(y){k.soundLoadError(x.name)});w.src=x.src+x.name+"."+this._ActiveAudioExt;w.load();this._audio_channels[x.name]=[w];return 1},stop:function(x){if(this.sound_enable){var y=this._audio_channels[x];for(var w=y.length;w--;){y[w].pause();y[w].currentTime=0.01}}},pause:function(x){if(this.sound_enable){var y=this._audio_channels[x];for(var w=y.length;w--;){y[w].pause()}}},getSound:function(x){var w=this._audio_channels[x];for(var y=0,z;z=w[y++];){if(z.paused||z.ended){return z}}w[0].pause();w[0].currentTime=0.01;return w[0]},play:function(x,w,z){if(this.sound_enable){var y=this.getSound(x);y.loop=w;y.play();y.addEventListener("ended",function(A){y.removeEventListener("ended",arguments.callee,false);y.pause();y.currentTime=0.01;if(z&&!w){z()}},false)}else{if(z&&!w){setTimeout(z,2000)}}}};var h={_imageList:[],_xmlList:[],_ressourceCount:0,_loadCount:0,_loaded_cb:f,_timerId:0,preload:function(z,w,x,y){if(z){this.preloadImages(z)}if(w){this.preloadSounds(w)}if(x){this.preloadXML(x)}h._loaded_cb=y;this.checkLoadStatus()},checkLoadStatus:function(){if(h._loadCount==h._ressourceCount){h._timerId=setTimeout(this._loaded_cb.bind(this),500)}else{h._timerId=setTimeout(this.checkLoadStatus.bind(this),100)}},onRessourceLoaded:function(){h._loadCount++},onImageError:function(w){console.log("Failing loading image")},preloadImages:function(w){for(var x=0;x<w.length;x++){h._imageList.push(w[x].name);h._imageList[w[x].name]=new Image();h._imageList[w[x].name].onload=this.onRessourceLoaded.bind(this);h._imageList[w[x].name].onerror=this.onImageError.bind(this);h._imageList[w[x].name].src=w[x].src}h._ressourceCount+=w.length},preloadSounds:function(w){k.setLoadCallback(this.onRessourceLoaded.bind(this));for(var x=0;x<w.length;x++){h._ressourceCount+=k.load(w[x])}},preloadXML:function(x){for(var w=0;w<x.length;w++){if(e.XMLHttpRequest){xmlhttp=new XMLHttpRequest();if(xmlhttp.overrideMimeType){xmlhttp.overrideMimeType("text/xml")}}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.open("GET",x[w].src,false);xmlhttp.onload=this.onRessourceLoaded.bind(this);xmlhttp.send();h._xmlList[x[w].name]=xmlhttp.responseText}h._ressourceCount+=x.length},getXMLRessource:function(w){if(h._xmlList!=null){return h._xmlList[w]}else{return null}},getImageRessource:function(w){if(h._imageList!=null){return h._imageList[w]}else{return null}},getLoadProgress:function(){return h._loadCount/h._ressourceCount}};function g(w,B,A){this.x=w;this.y=B;this.z=0;this.currentSpriteOff=0;this.scale_x=1;this.scale_y=1;this.spriteWidth=0;this.spriteHeight=0;this.displayWidth=0;this.displayHeight=0;this.scaleFlag=false;this.autodestroy=true;this.visible=true;try{this.image=A;this.displayWidth=this.spriteWidth=this.image.width;this.displayHeight=this.spriteHeight=this.image.height}catch(z){}}g.prototype.flipX=function(w){if(w){this.scale_x=this.scale_x>0?-this.scale_x:this.scale_x}else{this.scale_x=this.scale_x<0?-this.scale_x:this.scale_x}this.scaleFlag=((this.scale_x!=1)||(this.scale_y!=1))};g.prototype.flipY=function(w){if(w){this.scale_y=this.scale_y>0?-this.scale_y:this.scale_y}else{this.scale_y=this.scale_y<0?-this.scale_y:this.scale_y}this.scaleFlag=((this.scale_x!=1)||(this.scale_y!=1))};g.prototype.update=function(){return false};g.prototype.draw=function(x){var w=this.x-jTB.GameMngr.viewport.minX,y=this.y-jTB.GameMngr.viewport.minY;if(this.scaleFlag){x.scale(this.scale_x,this.scale_y);w=(w*this.scale_x)-(this.scale_x<0?this.spriteWidth:0);y=(y*this.scale_y)-(this.scale_y<0?this.spriteHeight:0)}x.drawImage(this.image,this.currentSpriteOff,0,this.spriteWidth,this.spriteHeight,w,y,this.displayWidth,this.displayHeight);if(this.scaleFlag){x.setTransform(1,0,0,1,0,0)}};g.prototype.onDestroyEvent=function(){};g.prototype.destroy=function(){this.onDestroyEvent();if(this.autodestroy){this.image=null;i.remove(this)}};function q(w,B,z,A){g.call(this,w,B,z);this.type=0;this.currentSprite=0;this.collidable=false;if(A){this.spritecount=A}else{this.spritecount=1}this.fpscount=0;this.animationspeed=e.sys.fps/5;this.displayWidth=this.spriteWidth=this.spriteWidth/this.spritecount;this.updateColRect(0.4,0.4);this.setCurrentSprite(0)}q.prototype=new g();q.prototype.setCurrentSprite=function(w){this.currentSprite=w;this.currentSpriteOff=this.spriteWidth*w};q.prototype.updateColRect=function(x,w){this.col_width=this.spriteWidth*x;this.col_height=this.spriteHeight*w;this.col_x_off=(this.spriteWidth-this.col_width)/2;this.col_y_off=(this.spriteHeight-this.col_height)/2};q.prototype.update=function(){if(this.fpscount++>this.animationspeed){this.setCurrentSprite(++this.currentSprite<this.spritecount?this.currentSprite:0);this.fpscount=0;return true}return false};q.prototype.collide=function(w){var y=w.y+w.col_y_off;var x=this.y+this.col_y_off;if(((y+w.col_height)<x)||(y>(x+this.col_height))){return i.NO_OBJECT}y=w.x+w.col_x_off;x=this.x+this.col_x_off;if(((y+w.col_width)<x)||(y>(x+this.col_width))){return i.NO_OBJECT}return this.type};var i={NO_OBJECT:0,ENEMY_OBJECT:1,COLLECTABLE_OBJECT:2,ACTION_OBJECT:3,x:0,y:0,frameBuffer:null,gameObjects:[],parentCanvas:null,canvas_invalidated:true,viewport:null,collisionMap:null,currentLevel:null,registeredMouseEventObj:[],init:function(z,B,A,x){this.spriteCanvasSurface=jTB.VideoMngr.createCanvasSurface(A,x);this.viewport=new jTB.Viewport(0,0,A,x);this.frameBuffer=jTB.VideoMngr.getScreenFrameBuffer()},reset:function(){this.removeAll();if(this.viewport){this.viewport.reset()}},loadTMXlevel:function(y){this.currentLevel=new jTB.TMXTileMap(y,0,0);for(var w=0;w<this.currentLevel.mapLayers.length;w++){if(this.currentLevel.mapLayers[w].isCollisionMap){this.collisionMap=this.currentLevel.mapLayers[w]}}this.add(this.currentLevel,0);this.viewport.setBounds(this.currentLevel.realwidth,this.currentLevel.realheight);var x=this.currentLevel.getObjectGroupByName(jTB.TMXConstants.ENTITIES);if(x!=null){for(var w=0;w<x.objects.length;w++){this.addEntity(x.objects[w],1)}}this.sort()},addEntity:function(x,y){console.log(x);var w=jTB.EntityPool.newIstanceOf(x.name,x.x,x.y,x.getObjectPropertyByName(jTB.TMXConstants.SPRITESHEET),x.getObjectPropertyByName(jTB.TMXConstants.SPRITECOUNT));if(x.name==jTB.TMXConstants.PLAYERSPAWN){w.bindOnUpdatePos(this.viewport.follow.bind(this.viewport))}this.add(w,y)},add:function(w,x){w.z=(x)?x:w.z;this.gameObjects.push(w);if(w.mouseEvent){this.registeredMouseEventObj.push(w)}},mouseEvent:function(w,A){for(var z=this.registeredMouseEventObj.length;z--;){this.registeredMouseEventObj[z].mouseEvent(w,A)}},update:function(){for(var w=this.gameObjects.length;w--;){if(this.gameObjects[w].update()){this.canvas_invalidated=true}}},remove:function(w){this.gameObjects.splice(this.gameObjects.indexOf(w),1);if(w.mouseEvent){this.registeredMouseEventObj.splice(this.registeredMouseEventObj.indexOf(w),1)}},removeAll:function(){this.gameObjects=[];this.registeredMouseEventObj=[]},sort:function(){this.gameObjects.sort(function(x,w){return(w.z-x.z)});this.canvas_invalidated=true},collide:function(z,C){var A=this.gameObjects;var w;for(var B=A.length;B--;){if(A[B].collidable){w=A[B].collide(z,C);switch(w){case i.NO_OBJECT:break;case i.COLLECTABLE_OBJECT:A[B].destroy();return w;break;case i.ENEMY_OBJECT:return w;break}}}return w},draw:function(){if(this.canvas_invalidated){for(var w=this.gameObjects.length;w--;){this.gameObjects[w].draw(this.spriteCanvasSurface)}this.canvas_invalidated=false;this.frameBuffer.drawImage(this.spriteCanvasSurface.canvas,this.x,this.y)}}};function c(w,B,A,z){q.call(this,w,B,A,z);this.isClickable=true;this.updated=false}c.prototype=new q();c.prototype.update=function(){if(this.updated){this.updated=false;return true}return false};c.prototype.clicked=function(){return false};c.prototype.mouseEvent=function(w,z){if((w>this.x)&&(w<this.x+this.displayWidth)&&(z>this.y)&&(z<this.y+this.displayHeight)){if(this.isClickable){this.updated=this.clicked()}}return this.updated};function s(w){this.nextState=w;this.actionKey=jTB.inputMngr.KEY.ENTER;this._frameBuffer=m.getScreenFrameBuffer();this.reset=function(){this.onResetEvent();i.reset();i.add(this);if(this.actionKey){jTB.inputMngr.bindKey(this.actionKey,"enter")}},this.destroy=function(){this.onDestroyEvent()};this.update=function(){if(this.actionKey&&jTB.inputMngr.isKeyPressed("enter")){a.setState(this.nextState)}return true},this.draw=function(x){},this.onUpdateFrame=function(){this.update();this.draw(this._frameBuffer);m.blitSurface()}}s.prototype.onResetEvent=function(){};s.prototype.onDestroyEvent=function(){};var a={STATE_LOADING:0,STATE_MENU:1,STATE_READY:2,STATE_PLAY:3,STATE_GAMEOVER:4,STATE_GAME_END:5,STATE_SCORE:6,_state:-1,_intervalId:-1,_screenObject:[null,null,null,null,null,null,null,null,null,],_loadingLogo:null,init:function(){this.setScreenObject(this.STATE_LOADING,this);e.addEventListener("blur",function(){if(a._state==a.STATE_PLAY){a._stopRunLoop()}},false);e.addEventListener("focus",function(){if(a._state==a.STATE_PLAY){a._startRunLoop(a.STATE_PLAY)}},false)},reset:function(){},destroy:function(){},setScreenObject:function(w,x){this._screenObject[w]=x},setSplashScreen:function(w){this._loadingLogo=new Image();this._loadingLogo.src=w},setState:function(w){switch(w){case this.STATE_LOADING:case this.STATE_MENU:case this.STATE_PLAY:case this.STATE_GAMEOVER:case this.STATE_GAME_END:case this.STATE_SCORE:this._stopRunLoop();if(this._screenObject[this._state]){this._screenObject[this._state].destroy()}this._screenObject[w].reset();this._startRunLoop(w);this._state=w;break;default:break}},_startRunLoop:function(w){if(this._intervalId==-1){this._intervalId=setInterval(this._screenObject[w].onUpdateFrame.bind(this._screenObject[w]),1000/e.sys.fps)}},_stopRunLoop:function(){if(this._intervalId!=-1){clearInterval(this._intervalId);this._intervalId=-1}},onUpdateFrame:function(){var w=m.getScreenFrameBuffer();var A=w.canvas.height/2;m.clearSurface(w,"black");if(this._loadingLogo){w.drawImage(this._loadingLogo,(w.canvas.width-this._loadingLogo.width)/2,(w.canvas.height-this._loadingLogo.height)/2);A+=this._loadingLogo.height/2+20}var x=Math.floor(h.getLoadProgress()*w.canvas.width);w.strokeStyle="gray";w.strokeRect(0,A,w.canvas.width,20);w.fillStyle="gray";w.fillRect(0,A,x,20);m.setSystemFont(w,"bold 14px Courier","top","white");var z=w.measureText("Loading...");w.fillText("Loading...",((w.canvas.width-z.width)/2),(A)+1);m.blitSurface()},};e.jTB.FPS=d;e.jTB.XMLParser=XMLParser;e.jTB.Utils=b;e.jTB.VideoMngr=m;e.jTB.ScreenObject=s;e.jTB.SpriteObject=g;e.jTB.GUI_Object=c;e.jTB.AnimatedSpriteObject=q;e.jTB.RessourceMngr=h;e.jTB.SoundMngr=k;e.jTB.AppMngr=a;e.jTB.GameMngr=i})(window);(function(c,d){var a=c.document;function b(){this.KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,PAUSE:19,ESC:27,SPACE:32,CTRL:17,X:88};this.KeyBinding=[];this.keyStatus=[];this.mouseEventCB=null;this.gyroEventCB=null;this.keyboardInitialized=false}b.prototype.isKeyPressed=function(e){return this.keyStatus[e]};b.prototype.bindKey=function(e,f){if(!this.keyboardInitialized){this.enableKeyboardEvent(true)}this.KeyBinding[e]=f};b.prototype.keydown=function(e){var f=this.KeyBinding[e.keyCode];if(f){this.keyStatus[f]=true;e.stopPropagation();e.preventDefault()}};b.prototype.keyup=function(e){var f=this.KeyBinding[e.keyCode];if(f){this.keyStatus[f]=false;e.preventDefault();if(e.stopPropagation){e.stopPropagation()}e.cancelBubble=true}};b.prototype.onMouseEvent=function(g){var f=g.clientX-VideoMngr.getScreenCanvas().offsetLeft;var h=g.clientY-VideoMngr.getScreenCanvas().offsetTop;this.mouseEventCB(f,h)};b.prototype.onGyroEvent=function(e){};b.prototype.enableKeyboardEvent=function(e){if(e){if(!this.keyboardInitialized){c.addEventListener("keydown",this.keydown.bind(this),false);c.addEventListener("keyup",this.keyup.bind(this),false)}}else{c.removeEventListener("keydown",this.keydown.bind(this),false);c.removeEventListener("keyup",this.keyup.bind(this),false)}this.keyboardInitialized=e};b.prototype.enableMouseEvent=function(e,f){if(e){VideoMngr.getScreenCanvas().addEventListener("click",this.onMouseEvent.bind(this),false);this.mouseEventCB=f}else{VideoMngr.getScreenCanvas().removeEventListener("click",this.onMouseEvent.bind(this),false)}};b.prototype.enableGyroscopicEvent=function(e,f){if(c.sys.gyro){c.ondevicemotion=e?this.onGyroEvent.bind(this):null;this.gyroEventCB=e?f:null}};c.jTB.inputMngr=new b()})(window);(function(d,b){var g=d.document;var a={entityClass:{},init:function(){this.entityClass[jTB.TMXConstants.PLAYERSPAWN]=jTB.PlayerEntity;this.entityClass[jTB.TMXConstants.STATIC_OBJECT]=jTB.StaticEntity},add:function(k,j){this.entityClass[k]=j},newIstanceOf:function(k,j,n,l,m){if(!this.entityClass[k]){alert("cannot instance entity of type"+k+": Class not found!");return null}return new this.entityClass[k](j,n,l,m)}};function f(j,k){SpriteObject.call(this,j,k,null);this.realwidth=-1;this.realheight=-1}f.prototype=new jTB.SpriteObject();function h(j,m,l,k){this.minX=j;this.minY=m;this.width=l-j;this.height=k-m;this.realwidth=this.width;this.realheight=this.height;this.deadzone=this.width/3}h.prototype.reset=function(){var k=this.getWidth();var j=this.getHeight();this.setViewport=(0,0,k,j)};h.prototype.setBounds=function(j,k){this.realwidth=j;this.realheight=k};h.prototype.follow=function(k,j){if((k-this.minX)>(this.width-this.deadzone)){this.minX=Math.min(k-(this.width-this.deadzone),this.realwidth-this.width)}else{if((k-this.minX)<(this.deadzone)){this.minX=Math.max(k-this.deadzone,0)}}if((j-this.minY)>(this.height-this.deadzone)){this.minY=Math.min(j-(this.height-this.deadzone),this.realheight-this.height)}else{if((j-this.minY)<(this.deadzone)){this.minY=Math.max(j-this.deadzone,0)}}};h.prototype.getWidth=function(){return this.width};h.prototype.getHeight=function(){return this.height};h.prototype.getCenterX=function(){return this.width*0.5};h.prototype.getCenterY=function(){return this.height*0.5};h.prototype.setCenter=function(m,l){var k=m-this.getCenterX();var j=l-this.getCenterY();this.minX+=k;this.minY+=j};h.prototype.offsetCenter=function(j,k){this.setCenter(this.getCenterX()+j,this.getCenterY()+k)};function c(j,m,k,l){jTB.AnimatedSpriteObject.call(this,j,m,RessourceMngr.getImageRessource(k),l);this.setPos(j,m);this.collidable=false;this.collectable=false;this.GRAVITY=0.98}c.prototype=new jTB.AnimatedSpriteObject();c.prototype.setPos=function(j,k){this.x=j;this.y=k-this.spriteHeight};function e(j,m,k,l){c.call(this,j,m,k,l);this.collisionEnable=true;this.collidable=true;this.type=GameMngr.COLLECTABLE_OBJECT;this.updateColRect(0.3,0.4);this.onDestroyEvent=function(){}}e.prototype=new c();function i(j,m,k,l){c.call(this,j,m,k,l);this.speed=2;this.VELOCITY=12;this.goLeft=false;this.falling=false;this.grounded=true;this.groundHeight=0;this.minHeight=0;this.yvelocity=0;this.dying=false;this.updateColRect(0.75,0.8);this.animationspeed=6;this.updateViewportCB=null;jTB.inputMngr.bindKey(jTB.inputMngr.KEY.LEFT,"left");jTB.inputMngr.bindKey(jTB.inputMngr.KEY.RIGHT,"right");jTB.inputMngr.bindKey(jTB.inputMngr.KEY.X,"jump")}i.prototype=new c();i.prototype.die=function(){if(!this.dying){}};i.prototype.stopdying=function(){this.dying=false};i.prototype.bindOnUpdatePos=function(j){this.updateViewportCB=j;this.updateViewportCB(this.x,this.y)};i.prototype.update=function(){var j=false;if(jTB.inputMngr.isKeyPressed("left")){this.flipX(true);this.goLeft=true;this.x-=this.speed;j=true;if(GameMngr.collisionMap.isTileCollidable(this.x+6,this.y+this.spriteHeight-1)){this.x+=this.speed;j=false}else{if(this.grounded&&!GameMngr.collisionMap.isTileCollidable(this.x-12+this.spriteWidth,this.y+this.spriteHeight)){this.yvelocity=this.VELOCITY;this.grounded=false;this.falling=true}}}else{if(jTB.inputMngr.isKeyPressed("right")){this.flipX(false);this.goLeft=false;this.x+=this.speed;j=true;if(GameMngr.collisionMap.isTileCollidable(this.x-6+this.spriteWidth,this.y+this.spriteHeight-1)){this.x-=this.speed;j=false}else{if(this.grounded&&!GameMngr.collisionMap.isTileCollidable(this.x+12,this.y+this.spriteHeight)){this.yvelocity=this.VELOCITY;this.grounded=false;this.falling=true}}}}if(jTB.inputMngr.isKeyPressed("jump")&&this.grounded){this.grounded=false;this.falling=false;this.yvelocity=this.VELOCITY}if(!this.grounded){if(this.goLeft){this.groundHeight=GameMngr.collisionMap.minGroundHeigth(this.x+12,this.y+this.spriteHeight)}else{this.groundHeight=GameMngr.collisionMap.minGroundHeigth(this.x-12+this.spriteWidth,this.y+this.spriteHeight)}if(this.falling){this.yvelocity+=this.GRAVITY;this.y+=~~(this.yvelocity)}else{this.yvelocity-=this.GRAVITY;this.y-=~~(this.yvelocity)}if((this.y+this.spriteHeight)>=this.groundHeight){this.y=this.groundHeight-this.spriteHeight;this.grounded=true;this.falling=false}j=true}if(j){if(this.updateViewportCB){this.updateViewportCB(this.x,this.y)}if(this.grounded){c.prototype.update.call(this)}}if(GameMngr.collide(this)==GameMngr.ENEMY_OBJECT){this.die()}return j};d.jTB.EntityPool=a;d.jTB.Viewport=h;d.jTB.LevelEntity=f;d.jTB.StaticEntity=e;d.jTB.PlayerEntity=i})(window);(function(e,c){var i=e.document;removepath=/^.*(\\|\/|\:)/;removeext=/\.[^\.]*$/;var h={ENTITIES:"entities",STATIC_OBJECT:"staticobjectspawn",PLAYERSPAWN:"playerspawnpoint",SPRITESHEET:"spritesheet",SPRITECOUNT:"spritecount",COLLIDABLE:"collidable",COLLECTABLE:"collectable",COLLISION_MAP:"collision",TAG_MAP:"map",TAG_NAME:"name",TAG_VALUE:"value",TAG_VERSION:"version",TAG_ORIENTATION:"orientation",TAG_WIDTH:"width",TAG_HEIGHT:"height",TAG_TILEWIDTH:"tilewidth",TAG_TILEHEIGHT:"tileheight",TAG_FIRSTGID:"firstgid",TAG_GID:"gid",TAG_TILE:"tile",TAG_ID:"id",TAG_DATA:"data",TAG_ENCODING:"encoding",TAG_SPACING:"spacing",TAG_MARGIN:"margin",TAG_PROPERTIES:"properties",TAG_PROPERTY:"property",TAG_IMAGE:"image",TAG_SOURCE:"source",TAG_VISIBLE:"visible",TAG_TILESET:"tileset",TAG_LAYER:"layer",TAG_OBJECTGROUP:"objectgroup",TAG_OBJECT:"object",TAG_X:"x",TAG_Y:"y",TAG_ATTR_BASE64:"base64",};function f(k,n){var m=jTB.XMLParser.getStringAttribute(n,h.TAG_NAME);var l=jTB.XMLParser.getStringAttribute(n,h.TAG_VALUE);if(l.isNumeric()){l=parseInt(l)}else{if(l.isBoolean()){l=(l=="true")}}k[m]=l}function d(l,k,m){LevelEntity.call(this,k,m);this.xmlfile=l;this.version="";this.orientation="";this.width=0;this.height=0;this.tilewidth=0;this.tileheight=0;this.tileset=null;this.mapLayers=[];this.mapObjectGroup=[];this.tileMapCanvas=null;this.load()}d.prototype=new jTB.LevelEntity();d.prototype.load=function(){jTB.XMLParser.parseFromString(jTB.RessourceMngr.getXMLRessource(this.xmlfile));var o=jTB.XMLParser.getFirstElementByTagName(h.TAG_MAP);this.version=jTB.XMLParser.getStringAttribute(o,h.TAG_VERSION);this.orientation=jTB.XMLParser.getStringAttribute(o,h.TAG_ORIENTATION);this.width=jTB.XMLParser.getIntAttribute(o,h.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(o,h.TAG_HEIGHT);this.tilewidth=jTB.XMLParser.getIntAttribute(o,h.TAG_TILEWIDTH);this.tileheight=jTB.XMLParser.getIntAttribute(o,h.TAG_TILEHEIGHT);this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight;if(this.orientation!="orthogonal"){alert("Tilemap format %s not supported!",this.orientation);return}this.tileset=new a(o.getElementsByTagName(h.TAG_TILESET)[0]);var n=o.getElementsByTagName(h.TAG_LAYER);for(var m=0;m<n.length;m++){this.mapLayers[m]=new b(n[m],this.tileset)}var k=o.getElementsByTagName(h.TAG_OBJECTGROUP);for(var m=0;m<k.length;m++){var l=jTB.XMLParser.getStringAttribute(k[m],h.TAG_NAME);this.mapObjectGroup[l]=new j(l,k[m])}};d.prototype.getObjectGroupByName=function(k){return this.mapObjectGroup[k]};d.prototype.update=function(){return false};d.prototype.draw=function(l){for(var k=0;k<this.mapLayers.length;k++){this.mapLayers[k].draw(l,this.x,this.y)}};function a(m){this.TileProperties=[];this.firstgid=jTB.XMLParser.getIntAttribute(m,h.TAG_FIRSTGID);this.name=jTB.XMLParser.getStringAttribute(m,h.TAG_NAME);this.tilewidth=jTB.XMLParser.getIntAttribute(m,h.TAG_TILEWIDTH);this.tileheight=jTB.XMLParser.getIntAttribute(m,h.TAG_TILEHEIGHT);this.spacing=jTB.XMLParser.getIntAttribute(m,h.TAG_SPACING,0);this.margin=jTB.XMLParser.getIntAttribute(m,h.TAG_MARGIN,0);this.image=jTB.RessourceMngr.getImageRessource(m.getElementsByTagName(h.TAG_IMAGE)[0].getAttribute(h.TAG_SOURCE).replace(removepath,"").replace(removeext,""));this.tileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing));var k=m.getElementsByTagName(h.TAG_TILE);for(var n=0;n<k.length;n++){var o=jTB.XMLParser.getIntAttribute(k[n],h.TAG_ID);var l=k[n].getElementsByTagName(h.TAG_PROPERTIES)[0].getElementsByTagName(h.TAG_PROPERTY);if(l){this.TileProperties[o]=new Object();f(this.TileProperties[o],l[0])}}}a.prototype.isTileCollidable=function(k){return(this.TileProperties[k]?this.TileProperties[k][h.COLLIDABLE]:false)};a.prototype.isTileCollectable=function(k){return(this.TileProperties[k]?this.TileProperties[k][h.COLLECTABLE]:false)};a.prototype.getTileProperty=function(k){return this.TileProperties[k]};a.prototype.drawTile=function(l,k,p,m){var o=this.margin+(this.spacing+this.tilewidth)*(m%this.tileCount);var n=this.margin+(this.spacing+this.tileheight)*~~(m/this.tileCount);l.drawImage(this.image,o,n,this.tilewidth,this.tileheight,k,p,this.tilewidth,this.tileheight)};function b(l,o){this.tileset=o;this.layerData=[];this.name=jTB.XMLParser.getStringAttribute(l,h.TAG_NAME);this.width=jTB.XMLParser.getIntAttribute(l,h.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(l,h.TAG_HEIGHT);this.visible=(jTB.XMLParser.getIntAttribute(l,h.TAG_VISIBLE,1)==1);this.isCollisionMap=(this.name==h.COLLISION_MAP);if(this.isCollisionMap){this.visible=false}this.layerInvalidated=true;if(this.visible){this.layerCanvas=jTB.VideoMngr.createCanvasSurface(this.width*this.tileset.tilewidth,this.height*this.tileset.tileheight)}this.layerData=new Array(this.width);for(var k=0;k<this.width;k++){this.layerData[k]=new Array(this.height);for(var p=0;p<this.height;p++){this.layerData[k][p]=0}}var n=l.getElementsByTagName(h.TAG_DATA)[0];var m=jTB.XMLParser.getStringAttribute(n,h.TAG_ENCODING);this.fillArray(n,m)}b.prototype.fillArray=function(p,o){if(o==null){var l=0;var n=p.getElementsByTagName(h.TAG_TILE);for(var q=0;q<this.height;q++){for(var k=0;k<this.width;k++){var m=jTB.XMLParser.getIntAttribute(n[l++],h.TAG_GID);if(m>0){this.setTile(k,q,m-this.tileset.firstgid)}else{}}}}else{alert("Tilemap Encoding type "+o+" not supported!")}};b.prototype.isTileCollidable=function(k,l){return this.tileset.isTileCollidable(this.getTile(k,l))};b.prototype.minGroundHeigth=function(k,m){var l=~~((m<0?0:m)/this.tileset.tileheight);do{if(this.tileset.isTileCollidable(this.layerData[~~(k/this.tileset.tilewidth)][l])){break}l++}while(1);return(l<<5)};b.prototype.getTile=function(k,l){return this.layerData[~~(k/this.tileset.tilewidth)][~~(l/this.tileset.tileheight)]};b.prototype.setTile=function(k,m,l){this.layerData[k][m]=l;if(this.visible){this.tileset.drawTile(this.layerCanvas,k*this.tileset.tilewidth,m*this.tileset.tileheight,this.layerData[k][m])}};b.prototype.draw=function(m,k,n){if(this.visible){var l=jTB.GameMngr.viewport;m.drawImage(this.layerCanvas.canvas,l.minX,l.minY,l.width,l.height,k,n,l.width,l.height)}};function j(l,k){this.objects=[];this.name=l;this.width=jTB.XMLParser.getIntAttribute(k,h.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(k,h.TAG_HEIGHT);var n=k.getElementsByTagName(h.TAG_OBJECT);for(var m=0;m<n.length;m++){this.objects.push(new g(n[m]))}}j.prototype.getObjectCount=function(){return this.objects.length};j.prototype.getObjectByIndex=function(k){return this.objects[k]};function g(l){this.name=jTB.XMLParser.getStringAttribute(l,h.TAG_NAME);this.x=jTB.XMLParser.getIntAttribute(l,h.TAG_X);this.y=jTB.XMLParser.getIntAttribute(l,h.TAG_Y);this.objProperties={};var k=l.getElementsByTagName(h.TAG_PROPERTIES)[0].getElementsByTagName(h.TAG_PROPERTY);for(var m=0;m<k.length;m++){f(this,k[m])}}g.prototype.getObjectPropertyByName=function(k){return this[k]};e.jTB.TMXTileMap=d;e.jTB.TMXConstants=h})(window);