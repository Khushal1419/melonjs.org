/*
 * jToolBox JavaScript Library
 * or... my humble attempt to create a game/app framework :)
 *
 * Minified version
 *
 * Copyright (C) 2010, Olivier BIOT
 * http://olivierbiot.wordpress.com/
 * 
 * Author:Olivier Biot
 * Date:January 2010
 */
(function(g,b){document=g.document;g.jTB=this;g.jTB.mod="jToolBox";g.sys={ua:navigator.userAgent.toLowerCase(),sound:false,storage:false,gyro:(g.DeviceMotionEvent!==b),fps:60,scale:1,};audio={mp3:false,ogg:false,ma4:false,wav:false,};g.jTB.XMLParser=null;g.jTB.loadingScreen=null;readyBound=false,isReady=false,readyList=[];function d(){if(!isReady){if(!document.body){setTimeout(d,10)}else{isReady=true;for(var s=0;s<readyList.length;s++){readyList[s].call(g,[])}readyList=[]}}}function h(){if(readyBound){return}readyBound=true;if(document.addEventListener){document.addEventListener("DOMContentLoaded",d,false)}g.addEventListener("load",d,false)}onReady=function(s){h();if(isReady){s.call(g,[])}else{readyList.push(function(){return s.call(g,[])})}return this};h();if(!Function.bind){Function.prototype.bind=function(t){var s=this;return function(){return s.apply(t,arguments)}}}String.prototype.trim=function(){return(this.replace(/^\s+/,"")).replace(/\s+$/,"")};String.prototype.isNumeric=function(){return(this!=null&&!isNaN(this)&&this.trim()!="")};String.prototype.isBoolean=function(){return(this!=null&&("true"==this.trim()||"false"==this.trim()))};function f(){var s={xmlDoc:null,parser:null,parseFromString:function(t){if(g.DOMParser){parser=new DOMParser();xmlDoc=parser.parseFromString(t,"text/xml")}else{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(t)}if(xmlDoc==null){console.log("xml "+xmlDoc+" not found!")}},getFirstElementByTagName:function(t){return xmlDoc?xmlDoc.getElementsByTagName(t)[0]:null},getStringAttribute:function(u,w,v){var t=u.getAttribute(w);return t?t.trim().toLowerCase():v},getIntAttribute:function(u,w,v){var t=this.getStringAttribute(u,w,v);return t?parseInt(t):v},getBooleanAttribute:function(u,w,v){var t=this.getStringAttribute(u,w,v);return t?(t=="true"):v},free:function(){xmlDoc=null}};return s}base64={base64chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),base64inv:{},init:function(){for(var s=0;s<this.base64chars.length;s++){this.base64inv[this.base64chars[s]]=s}},decodeNumeric:function(t){t=t.replace(new RegExp("[^"+this.base64chars.join("")+"=]","g"),"");p=(t.charAt(t.length-1)=="="?(t.charAt(t.length-2)=="="?"AA":"A"):"");r=[];t=t.substr(0,t.length-p.length)+p;for(c=0;c<t.length;c+=4){n=(this.base64inv[t.charAt(c)]<<18)+(this.base64inv[t.charAt(c+1)]<<12)+(this.base64inv[t.charAt(c+2)]<<6)+this.base64inv[t.charAt(c+3)];r.push((n>>>16)&255);r.push((n>>>8)&255);r.push(n&255)}return r},};var k={random:function(t,s){return(~~(Math.random()*(s-t+1))+t)},round:function(s,u){var t=Math.pow(10,u);return(Math.round(s*t)/t)},decodeNumeric_base64:function(t){return base64.decodeNumeric(t)},};function e(){if(document.addEventListener){document.removeEventListener("DOMContentLoaded",d,false)}var s=document.createElement("audio");if(s.canPlayType){g.sys.sound=true;audio.mp3=("no"!=s.canPlayType("audio/mpeg"))&&(""!=s.canPlayType("audio/mpeg"));audio.ogg=("no"!=s.canPlayType('audio/ogg; codecs="vorbis"'))&&(""!=s.canPlayType('audio/ogg; codecs="vorbis"'));audio.wav=("no"!=s.canPlayType('audio/wav; codecs="1"'))&&(""!=s.canPlayType('audio/wav; codecs="1"'))}if((g.sys.ua.search("iphone")>-1)||(g.sys.ua.search("ipod")>-1)||(g.sys.ua.search("ipad")>-1)||(g.sys.ua.search("android")>-1)){g.sys.sound=false}FPS.init();jTB.XMLParser=new f();base64.init();jTB.loadingScreen=new jTB.DefaultLoadingScreen();q.init();jTB.EntityPool.init();jTB.LevelDirector.reset()}g.onReady(function(){e()});FPS={_htmlCounter:null,framecount:0,_fps:60,_lastTime:null,_dt:0,_gameTick:0,debug:false,init:function(){_htmlCounter=document.getElementById("framecounter");debug=(_htmlCounter!==null);_lastTime=new Date();_fps=g.sys.fps;_string=null},update:function(){var s=new Date();_dt=s.getTime()-_lastTime.getTime();if(_dt>999){this._gameTick=_dt/1000;_fps=FPS.framecount;FPS.framecount=0;_lastTime=s}FPS.framecount++;if(debug){_htmlCounter.replaceChild(document.createTextNode("("+_fps+"/"+g.sys.fps+" fps)"),_htmlCounter.firstChild)}},getTickCount:function(){console.log(this._gameTick);return this._gameTick}};VideoMngr={_canvas:null,_context2D:null,_backBufferCanvas:null,_backBufferContext2D:null,_wrapper:null,_double_buffering:false,_game_width_zoom:0,_game_height_zoom:0,_font:{image:null,size:-1,firstChar:-1},init:function(t,w,s,u,v){this._double_buffering=u;g.sys.scale=u===true?v:1;this._game_width_zoom=w*g.sys.scale;this._game_height_zoom=s*g.sys.scale;this._wrapper=document.getElementById(t);this._canvas=document.createElement("canvas");this._canvas.setAttribute("width",(this._game_width_zoom)+"px");this._canvas.setAttribute("height",(this._game_height_zoom)+"px");this._canvas.setAttribute("border","0px solid black");this._wrapper.appendChild(this._canvas);if(this._canvas.getContext){this._context2D=this._canvas.getContext("2d");if(u){this._backBufferContext2D=VideoMngr.createCanvasSurface(w,s);this._backBufferCanvas=this._backBufferContext2D.canvas}else{this._backBufferContext2D=this._context2D;this._backBufferCanvas=this._context2D.canvas}}else{return false}return true},getWrapper:function(){return _wrapper},getWidth:function(){return this._backBufferCanvas.width},getHeight:function(){return this._backBufferCanvas.height},createCanvasSurface:function(t,s){var u=document.createElement("canvas");u.width=t;u.height=s;return u.getContext("2d")},getScreenFrameBuffer:function(){return this._backBufferContext2D},updateDisplaySize:function(s){if(this._double_buffering){if(s){g.sys.scale=s}else{g.sys.scale=document.getElementById("screen size").value}this._game_width_zoom=this._backBufferCanvas.width*g.sys.scale;this._game_height_zoom=this._backBufferCanvas.height*g.sys.scale;this._canvas.width=this._game_width_zoom;this._canvas.height=this._game_height_zoom}},clearSurface:function(t,s){t.fillStyle=s;t.fillRect(0,0,t.canvas.width,t.canvas.height)},scale:function(s,t){s.translate(-(((s.canvas.width*t)-s.canvas.width)>>1),-(((s.canvas.height*t)-s.canvas.height)>>1));s.scale(t,t)},setAlpha:function(t,s){t.globalCompositeOperation=s?"source-over":"copy"},blitSurface:function(){if(this._double_buffering){this.blitSurface=function(){FPS.update();this._context2D.drawImage(this._backBufferCanvas,0,0,this._backBufferCanvas.width,this._backBufferCanvas.height,0,0,this._game_width_zoom,this._game_height_zoom)}}else{this.blitSurface=function(){FPS.update()}}this.blitSurface()},setFont:function(s,t,u){this._font.image=s;this._font.size=t;this._font.firstChar=u},setSystemFont:function(u,t,v,s){u.fillStyle=s;u.font=t;u.textBaseline=v},drawFont:function(u,s,z,w){var t=s,v;for(i=w.length;i--;){v=(w.charAt(i)*this._font.size)+this._font.firstChar;u.drawImage(this._font.image,v,0,this._font.size,this._font.image.height,t,z,this._font.size,this._font.image.height);t-=this._font.size}}};SoundMngr={_audio_channels:[],_supportedFormat:["mp3","ogg","wav"],requestedFormat:null,_ActiveAudioExt:-1,_load_cb:null,sound_enable:true,init:function(s){if(s){this.requestedFormat=new String(s)}else{this.requestedFormat=new String("mp3")}this._ActiveAudioExt=this.getSupportedAudioFormat();return this.sound_enable},getSupportedAudioFormat:function(){var s=0;if(!g.sys.sound){this.sound_enable=false;return}if((this.requestedFormat.search(/mp3/i)!=-1)&&audio.mp3){return this._supportedFormat[s]}if((this.requestedFormat.search(/ogg/i)!=-1)&&audio.ogg){return this._supportedFormat[++s]}if((this.requestedFormat.search(/wav/i)!=-1)&&audio.wav){return this._supportedFormat[++s]}this.sound_enable=false;return -1},setLoadCallback:function(s){this._load_cb=s},soundLoadError:function(s){this._audio_channels[s][0].load()},soundLoaded:function(s,u){if(u>1){var t=this._audio_channels[s][0];for(channel=1;channel<u;channel++){this._audio_channels[s][channel]=t.cloneNode(true)}}if(this._load_cb){this._load_cb()}},load:function(t){if(this._ActiveAudioExt==-1){return 0}var s=document.createElement("audio");s.autobuffer=true;s.preload="auto";s.addEventListener("canplaythrough",function(u){s.removeEventListener("canplaythrough",arguments.callee,false);SoundMngr.soundLoaded(t.name,t.channel)},false);s.addEventListener("error",function(u){SoundMngr.soundLoadError(t.name)});s.src=t.src+t.name+"."+this._ActiveAudioExt;s.load();this._audio_channels[t.name]=[s];return 1},stop:function(s){if(this.sound_enable){var t=this._audio_channels[s];for(channel_id=t.length;channel_id--;){t[channel_id].pause();t[channel_id].currentTime=0.01}}},pause:function(s){if(this.sound_enable){var t=this._audio_channels[s];for(channel_id=t.length;channel_id--;){t[channel_id].pause()}}},getSound:function(t){var s=this._audio_channels[t];for(var u=0,v;v=s[u++];){if(v.paused||v.ended){return v}}s[0].pause();s[0].currentTime=0.01;return s[0]},play:function(t,s,v){if(this.sound_enable){var u=this.getSound(t);u.loop=s;u.play();u.addEventListener("ended",function(w){u.removeEventListener("ended",arguments.callee,false);u.pause();u.currentTime=0.01;if(v&&!s){v()}},false)}else{if(v&&!s){setTimeout(v,2000)}}}};function o(s,u,t){if(s===b){return}this.pos=new jTB.Vector2d(s,u);this.scale=new jTB.Vector2d(1,1);this.z=0;this.currentSpriteOff=0;this.spriteWidth=0;this.spriteHeight=0;this.displayWidth=0;this.displayHeight=0;this.scaleFlag=false;this.autodestroy=true;this.visible=true;if(t!=b){this.image=t;this.displayWidth=this.spriteWidth=this.image.width;this.displayHeight=this.spriteHeight=this.image.height}this.collisionBox=new jTB.Rectangle(this.pos,this.displayWidth,this.displayHeight)}o.prototype.flipX=function(s){if(s){this.scale.x=this.scale.x>0?-this.scale.x:this.scale.x}else{this.scale.x=this.scale.x<0?-this.scale.x:this.scale.x}this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))};o.prototype.flipY=function(s){if(s){this.scale.y=this.scale.y>0?-this.scale.y:this.scale.y}else{this.scale.y=this.scale.y<0?-this.scale.y:this.scale.y}this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))};o.prototype.update=function(){return false};o.prototype.draw=function(t){var s=this.pos.x-jTB.GameMngr.viewport.pos.x,u=this.pos.y-jTB.GameMngr.viewport.pos.y;if(this.scaleFlag){t.scale(this.scale.x,this.scale.y);s=(s*this.scale.x)-(this.scale.x<0?this.spriteWidth:0);u=(u*this.scale.y)-(this.scale.y<0?this.spriteHeight:0)}t.drawImage(this.image,this.currentSpriteOff,0,this.spriteWidth,this.spriteHeight,s,u,this.displayWidth,this.displayHeight);if(this.scaleFlag){t.setTransform(1,0,0,1,0,0)}};o.prototype.destroy=function(){this.onDestroyEvent();if(this.autodestroy){this.image=null;l.remove(this)}};o.prototype.onDestroyEvent=function(){};function j(s,v,t,u){if(s==b){return}o.call(this,s,v,t);this.type=0;this.currentSprite=0;this.collidable=false;this.spritecount=(u)?u:1;this.fpscount=0;this.animationspeed=g.sys.fps/5;this.displayWidth=this.spriteWidth=this.spriteWidth/this.spritecount;this.collisionBox.set(this.pos,this.displayWidth,this.displayHeight);this.setCurrentSprite(0)}j.prototype=new o();j.prototype.setCurrentSprite=function(t){this.currentSprite=t;this.currentSpriteOff=this.spriteWidth*t};j.prototype.updateColRect=function(s,t,v,u){this.collisionBox.adjustSize(s,t,v,u)};j.prototype.update=function(){if(this.visible&&(this.fpscount++>this.animationspeed)){this.setCurrentSprite(++this.currentSprite<this.spritecount?this.currentSprite:0);this.fpscount=0;return true}return false};j.prototype.checkCollision=function(t){var s=this.collisionBox.collideVsAABB(t.collisionBox);if(s.x!=0||s.y!=0){this.onCollision();return this.type}return l.NO_OBJECT};j.prototype.onCollision=function(){};var l={NO_OBJECT:0,ENEMY_OBJECT:1,COLLECTABLE_OBJECT:2,ACTION_OBJECT:3,x:0,y:0,frameBuffer:null,gameObjects:[],canvas_invalidated:true,viewport:null,collisionMap:null,currentLevel:null,registeredMouseEventObj:[],init:function(t,v,u,s){this.x=t||0;this.y=v||0;var u=u||jTB.VideoMngr.getWidth();var s=s||jTB.VideoMngr.getHeight();this.spriteCanvasSurface=jTB.VideoMngr.createCanvasSurface(u,s);this.viewport=new jTB.Viewport(0,0,u,s);this.frameBuffer=jTB.VideoMngr.getScreenFrameBuffer()},reset:function(){this.removeAll();if(this.viewport){this.viewport.reset()}this.canvas_invalidated=true},loadTMXLevel:function(u){this.currentLevel=u;for(var s=0;s<this.currentLevel.mapLayers.length;s++){if(this.currentLevel.mapLayers[s].isCollisionMap){this.collisionMap=this.currentLevel.mapLayers[s]}}this.add(this.currentLevel,-1);this.viewport.reset();this.viewport.setBounds(this.currentLevel.realwidth,this.currentLevel.realheight);var t=this.currentLevel.getObjectGroupByName(jTB.TMXConstants.ENTITIES);if(t!=null){for(var s=0;s<t.objects.length;s++){this.addEntity(t.objects[s],1)}}this.sort()},addEntity:function(s,t){this.add(jTB.EntityPool.newIstanceOf(s),t)},add:function(s,t){s.z=(t)?t:s.z;this.gameObjects.push(s);if(s.mouseEvent){this.registeredMouseEventObj.push(s)}},mouseEvent:function(s,u){for(var t=this.registeredMouseEventObj.length;t--;){this.registeredMouseEventObj[t].mouseEvent(s,u)}},update:function(){for(var s=this.gameObjects.length,t;s--,t=this.gameObjects[s];){if(t.update()){this.canvas_invalidated=true}t.visible=this.viewport.checkAxisAligned(t.collisionBox)}},remove:function(s){this.gameObjects.splice(this.gameObjects.indexOf(s),1);if(s.mouseEvent){this.registeredMouseEventObj.splice(this.registeredMouseEventObj.indexOf(s),1)}},removeAll:function(){this.gameObjects=[];this.registeredMouseEventObj=[]},sort:function(){this.gameObjects.sort(function(t,s){return(s.z-t.z)});this.canvas_invalidated=true},collide:function(t){var s;for(var u=this.gameObjects.length,v;u--,v=this.gameObjects[u];){if(v.visible&&v.collidable){s=v.checkCollision(t);switch(s){case l.NO_OBJECT:break;case l.COLLECTABLE_OBJECT:v.destroy();return s;break;case l.ENEMY_OBJECT:return s;break}}}return s},draw:function(){if(this.canvas_invalidated){for(var s=this.gameObjects.length,t;s--,t=this.gameObjects[s];){if(t.visible){t.draw(this.spriteCanvasSurface)}}this.canvas_invalidated=false;this.frameBuffer.drawImage(this.spriteCanvasSurface.canvas,this.x,this.y)}}};function m(s,v,u,t){j.call(this,s,v,u,t);this.isClickable=true;this.updated=false}m.prototype=new j();m.prototype.update=function(){if(this.updated){this.updated=false;return true}return false};m.prototype.clicked=function(){return false};m.prototype.mouseEvent=function(s,t){if((s>this.pos.x)&&(s<this.pos.x+this.displayWidth)&&(t>this.pos.y)&&(t<this.pos.y+this.displayHeight)){if(this.isClickable){this.updated=this.clicked()}}return this.updated};function a(s){if(s==b){return}this.nextState=s;this.actionKey=jTB.inputMngr.KEY.ENTER;this._frameBuffer=null;this.reset=function(){this._frameBuffer=VideoMngr.getScreenFrameBuffer();this.onResetEvent();l.reset();l.add(this);if(this.actionKey){jTB.inputMngr.bindKey(this.actionKey,"enter")}},this.destroy=function(){this.onDestroyEvent()};this.update=function(){if(this.actionKey&&jTB.inputMngr.isKeyPressed("enter")){q.setState(this.nextState)}return true};this.onUpdateFrame=function(){this.update();this.draw(this._frameBuffer);VideoMngr.blitSurface()}}a.prototype.draw=function(s){};a.prototype.onResetEvent=function(){};a.prototype.onDestroyEvent=function(){};var q={STATE_LOADING:0,STATE_MENU:1,STATE_READY:2,STATE_PLAY:3,STATE_GAMEOVER:4,STATE_GAME_END:5,STATE_SCORE:6,_state:-1,_intervalId:-1,_screenObject:[null,null,null,null,null,null,null,null,null,],init:function(){this.setScreenObject(this.STATE_LOADING,jTB.loadingScreen);g.addEventListener("blur",function(){if(q._state==q.STATE_PLAY){q._stopRunLoop()}},false);g.addEventListener("focus",function(){if(q._state==q.STATE_PLAY){q._startRunLoop(q.STATE_PLAY)}},false)},setScreenObject:function(s,t){this._screenObject[s]=t},setState:function(s){switch(s){case this.STATE_LOADING:case this.STATE_MENU:case this.STATE_PLAY:case this.STATE_GAMEOVER:case this.STATE_GAME_END:case this.STATE_SCORE:this._stopRunLoop();if(this._screenObject[this._state]){this._screenObject[this._state].destroy()}this._screenObject[s].reset();this._startRunLoop(s);this._state=s;break;default:break}},_startRunLoop:function(s){if(this._intervalId==-1){this._intervalId=setInterval(this._screenObject[s].onUpdateFrame.bind(this._screenObject[s]),1000/g.sys.fps)}},_stopRunLoop:function(){if(this._intervalId!=-1){clearInterval(this._intervalId);this._intervalId=-1}},};g.jTB.FPS=FPS;g.jTB.XMLParser=XMLParser;g.jTB.Utils=k;g.jTB.VideoMngr=VideoMngr;g.jTB.ScreenObject=a;g.jTB.SpriteObject=o;g.jTB.GUI_Object=m;g.jTB.AnimatedSpriteObject=j;g.jTB.SoundMngr=SoundMngr;g.jTB.AppMngr=q;g.jTB.GameMngr=l})(window);(function(b,d){function a(){jTB.ScreenObject.call(this,AppMngr.STATE_PLAY);this.loadingLogo=null,this.setLoadingLogo=function(f){this._loadingLogo=new Image();this._loadingLogo.src=f},this.onResetEvent=function(){this.actionKey=null},this.onDestroyEvent=function(){if(this._loadingLogo){this._loadingLogo=null}};this.draw=function(f){var j=f.canvas.height/2;VideoMngr.clearSurface(f,"black");if(this._loadingLogo){f.drawImage(this._loadingLogo,(f.canvas.width-this._loadingLogo.width)/2,(f.canvas.height-this._loadingLogo.height)/2);j+=this._loadingLogo.height/2+20}var g=Math.floor(jTB.loader.getLoadProgress()*f.canvas.width);f.strokeStyle="gray";f.strokeRect(0,j,f.canvas.width,20);f.fillStyle="gray";f.fillRect(0,j,g,20);VideoMngr.setSystemFont(f,"bold 14px Courier","top","white");var h=f.measureText("Loading...");f.fillText("Loading...",((f.canvas.width-h.width)/2),(j)+1)}}a.prototype=new jTB.ScreenObject();var e={_imageList:[],_xmlList:[],_ressourceCount:0,_loadCount:0,_timerId:0,onload:d,checkLoadStatus:function(){if(this._loadCount==this._ressourceCount){if(this.onload){this._timerId=setTimeout(this.onload,500)}else{alert("no load callback defined")}}else{this._timerId=setTimeout(this.checkLoadStatus.bind(this),100)}},onRessourceLoaded:function(){this._loadCount++},onImageError:function(f){console.log("Failing loading image")},preloadImages:function(f){for(var g=0;g<f.length;g++){this._imageList.push(f[g].name);this._imageList[f[g].name]=new Image();this._imageList[f[g].name].onload=this.onRessourceLoaded.bind(this);this._imageList[f[g].name].onerror=this.onImageError.bind(this);this._imageList[f[g].name].src=f[g].src}this._ressourceCount+=f.length},preloadSounds:function(f){SoundMngr.setLoadCallback(this.onload);for(var g=0;g<f.length;g++){this._ressourceCount+=SoundMngr.load(f[g])}},preloadXML:function(g){for(var f=0;f<g.length;f++){if(b.XMLHttpRequest){xmlhttp=new XMLHttpRequest();if(xmlhttp.overrideMimeType){xmlhttp.overrideMimeType("text/xml")}}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.open("GET",g[f].src,false);xmlhttp.onload=this.onRessourceLoaded.bind(this);xmlhttp.send();this._xmlList[g[f].name]=xmlhttp.responseText}this._ressourceCount+=g.length},preload:function(h,f,g){if(h){this.preloadImages(h)}if(f){this.preloadSounds(f)}if(g){this.preloadXML(g)}this.checkLoadStatus()},getXMLRessource:function(f){if(this._xmlList!=null){return this._xmlList[f]}else{return null}},getImageRessource:function(f){if(this._imageList!=null){return this._imageList[f]}else{return null}},getLoadProgress:function(){return this._loadCount/this._ressourceCount}};b.jTB.loader=e;b.jTB.DefaultLoadingScreen=a})(window);(function(d,e){function b(f,g){this.x=f||0;this.y=g||0}b.prototype.set=function(f,g){this.x=f;this.y=g};b.prototype.setZero=function(){this.set(0,0)};b.prototype.setV=function(f){this.x=f.x;this.y=f.y};b.prototype.add=function(f){this.x+=f.x;this.y+=f.y};b.prototype.sub=function(f){this.x-=f.x;this.y-=f.y};b.prototype.scale=function(f){this.x*=f.x;this.y*=f.y};b.prototype.negate=function(){return new b(-this.x,-this.y)};b.prototype.div=function(f){this.x/=f;this.y/=f};b.prototype.copy=function(f){this.x=f.x;this.y=f.y};b.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};b.prototype.normalize=function(){var f=this.length();this.x/=f;this.y/=f};b.prototype.dotProduct=function(f){return this.x*f.x+this.y*f.y};b.prototype.distance=function(f){return Math.sqrt((this.x-f.x)*(this.x-f.x)+(this.y-f.y)*(this.y-f.y))};b.prototype.clone=function(){return new b(this.x,this.y)};b.prototype.toString=function(){return"x:"+this.x+"y:"+this.y};function a(g,f,j){this.pos=g;this.colPos=new b();this.width=f;this.height=j;this.fWidth=f;this.fHeight=j;this.hWidth=~~(f/2);this.hHeight=~~(j/2);this.recPoints=[];this.tthis=new b();this.trect=new b()}a.prototype.set=function(g,f,j){this.pos=g;this.width=f;this.height=j;this.fWidth=f;this.fHeight=j;this.hWidth=~~(f/2);this.hHeight=~~(j/2)};a.prototype.adjustSize=function(f,g,k,j){if(f!=0){this.colPos.x=f;this.width=g;this.hWidth=~~(this.width/2)}if(k!=0){this.colPos.y=k;this.height=j;this.hHeight=~~(this.height/2)}};a.prototype.checkAxisAligned=function(f){this.tthis.x=this.pos.x+this.colPos.x;this.tthis.y=this.pos.y+this.colPos.y;this.trect.x=f.pos.x+f.colPos.x;this.trect.y=f.pos.y+f.colPos.y;return(this.tthis.x<this.trect.x+f.width&&this.trect.x<this.tthis.x+this.width&&this.tthis.y<this.trect.y+f.height&&this.trect.y<this.tthis.y+this.height)};a.prototype.collideVsAABB=function(h){p=new b(0,0);if(this.checkAxisAligned(h)){var g=this.tthis.x+this.hWidth-this.trect.x-h.hWidth;var f=this.tthis.y+this.hHeight-this.trect.y-h.hHeight;p.x=(h.hWidth+this.hWidth)-(g<0?-g:g);p.y=(h.hHeight+this.hHeight)-(f<0?-f:f);if(p.x<p.y){p.y=0;p.x=g<0?-p.x:p.x}else{p.x=0;p.y=f<0?-p.y:p.y}}return p};a.prototype.draw=function(f){f.strokeStyle="red";f.strokeRect(this.pos.x+this.colPos.x-jTB.GameMngr.viewport.pos.x,this.pos.y+this.colPos.y-jTB.GameMngr.viewport.pos.y,this.width,this.height)};d.jTB.Vector2d=b;d.jTB.Rectangle=a})(window);(function(b,d){function a(){this.KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,PAUSE:19,ESC:27,SPACE:32,CTRL:17,X:88};this.KeyBinding=[];this.keyStatus=[];this.mouseEventCB=null;this.gyroEventCB=null;this.keyboardInitialized=false}a.prototype.isKeyPressed=function(e){return this.keyStatus[e]};a.prototype.bindKey=function(e,f){if(!this.keyboardInitialized){this.enableKeyboardEvent(true)}this.KeyBinding[e]=f};a.prototype.keydown=function(e){var f=this.KeyBinding[e.keyCode];if(f){this.keyStatus[f]=true;e.stopPropagation();e.preventDefault()}};a.prototype.keyup=function(e){var f=this.KeyBinding[e.keyCode];if(f){this.keyStatus[f]=false;e.preventDefault();if(e.stopPropagation){e.stopPropagation()}e.cancelBubble=true}};a.prototype.onMouseEvent=function(g){var f=g.clientX-VideoMngr.getScreenCanvas().offsetLeft;var h=g.clientY-VideoMngr.getScreenCanvas().offsetTop;this.mouseEventCB(f,h)};a.prototype.onGyroEvent=function(e){};a.prototype.enableKeyboardEvent=function(e){if(e){if(!this.keyboardInitialized){b.addEventListener("keydown",this.keydown.bind(this),false);b.addEventListener("keyup",this.keyup.bind(this),false)}}else{b.removeEventListener("keydown",this.keydown.bind(this),false);b.removeEventListener("keyup",this.keyup.bind(this),false)}this.keyboardInitialized=e};a.prototype.enableMouseEvent=function(e,f){if(e){VideoMngr.getScreenCanvas().addEventListener("click",this.onMouseEvent.bind(this),false);this.mouseEventCB=f}else{VideoMngr.getScreenCanvas().removeEventListener("click",this.onMouseEvent.bind(this),false)}};a.prototype.enableGyroscopicEvent=function(e,f){if(b.sys.gyro){b.ondevicemotion=e?this.onGyroEvent.bind(this):null;this.gyroEventCB=e?f:null}};b.jTB.inputMngr=new a()})(window);(function(d,f){var a=Math.min,e=Math.max;function b(g,k,j,h){jTB.Rectangle.call(this,new Vector2d(g,k),j-g,h-k);this.limits=new Vector2d(this.width,this.height);this.deadzone=new Vector2d(this.width/3,this.height/3)}b.prototype=new jTB.Rectangle();b.prototype.reset=function(){this.pos.set(0,0)};b.prototype.setBounds=function(g,h){this.limits.set(g,h)};b.prototype.follow=function(g){if((g.x-this.pos.x)>(this.width-this.deadzone.x)){this.pos.x=a(g.x-(this.width-this.deadzone.x),this.limits.x-this.width)}else{if((g.x-this.pos.x)<(this.deadzone.x)){this.pos.x=e(g.x-this.deadzone.x,0)}}if((g.y-this.pos.y)>(this.height-this.deadzone.y)){this.pos.y=a(g.y-(this.height-this.deadzone.y),this.limits.y-this.height)}else{if((g.y-this.pos.y)<(this.deadzone.y)){this.pos.y=e(g.y-this.deadzone.y,0)}}};b.prototype.getWidth=function(){return this.width};b.prototype.getHeight=function(){return this.height};b.prototype.getCenterX=function(){return this.width*0.5};b.prototype.getCenterY=function(){return this.height*0.5};b.prototype.setCenter=function(k,j){var h=k-this.getCenterX();var g=j-this.getCenterY();this.pos.x+=h;this.pos.y+=g};b.prototype.offsetCenter=function(g,h){this.setCenter(this.getCenterX()+g,this.getCenterY()+h)};d.jTB.Viewport=b})(window);(function(f,d){var k=Math.min,e=Math.max;var a={entityClass:{},init:function(){},add:function(m,l){this.entityClass[m]=l},newIstanceOf:function(l){if(!this.entityClass[l.name]){alert("cannot instance entity of type '"+l.name+"': Class not found!");return null}return new this.entityClass[l.name](l.x,l.y,l)}};function h(l,m){if(!l){return}SpriteObject.call(this,0,0,jTB.loader.getImageRessource(l));this.lastx=0;this.startx=0;this.scrollspeed=1;this.vp=jTB.GameMngr.viewport}h.prototype=new jTB.SpriteObject();h.prototype.draw=function(m,l,q){var o;if((jTB.inputMngr.isKeyPressed("right"))&&(this.lastx!=l)){this.startx+=this.scrollspeed;if(this.startx>this.spriteWidth){this.startx=this.scrollspeed}this.lastx=l}else{if((jTB.inputMngr.isKeyPressed("left"))&&(this.lastx!=l)){this.startx-=this.scrollspeed;if(this.startx<0){this.startx=this.spriteWidth-this.scrollspeed}this.lastx=l}}this.drawParallax(m,l,q)};h.prototype.drawParallax=function(s,l,u){var t=0;var q=0;var o=k(this.spriteWidth-this.startx,this.vp.width);var m=this.startx;do{if(o!=0){s.drawImage(this.image,m,0,o,this.spriteHeight,q,u,o,this.spriteHeight)}t+=o;q+=o;m=0;o=k(this.spriteWidth,this.vp.width-o)}while(t<this.vp.width)};function j(l,q,o,m){jTB.Rectangle.call(this,new Vector2d(l,q),o-l,m-q);this.limits=new Vector2d(this.width,this.height);this.deadzone=new Vector2d(this.width/3,this.height/3)}j.prototype=new jTB.Rectangle();j.prototype.reset=function(){this.pos.set(0,0)};j.prototype.setBounds=function(l,m){this.limits.set(l,m)};j.prototype.follow=function(l){if((l.x-this.pos.x)>(this.width-this.deadzone.x)){this.pos.x=k(l.x-(this.width-this.deadzone.x),this.limits.x-this.width)}else{if((l.x-this.pos.x)<(this.deadzone.x)){this.pos.x=e(l.x-this.deadzone.x,0)}}if((l.y-this.pos.y)>(this.height-this.deadzone.y)){this.pos.y=k(l.y-(this.height-this.deadzone.y),this.limits.y-this.height)}else{if((l.y-this.pos.y)<(this.deadzone.y)){this.pos.y=e(l.y-this.deadzone.y,0)}}};j.prototype.getWidth=function(){return this.width};j.prototype.getHeight=function(){return this.height};j.prototype.getCenterX=function(){return this.width*0.5};j.prototype.getCenterY=function(){return this.height*0.5};j.prototype.setCenter=function(q,o){var m=q-this.getCenterX();var l=o-this.getCenterY();this.pos.x+=m;this.pos.y+=l};j.prototype.offsetCenter=function(l,m){this.setCenter(this.getCenterX()+l,this.getCenterY()+m)};function g(l,q,m,o){}b.prototype=new jTB.AnimatedSpriteObject();function b(l,q,m,o){if(l==d){return}jTB.AnimatedSpriteObject.call(this,l,q,jTB.loader.getImageRessource(m),o);this.setPos(l,q);this.vel=new Vector2d();this.accel=new Vector2d();this.gravity=1;this.falling=false;this.jumping=false;this.jumpspeed=0;this.collidable=false;this.collectable=false}b.prototype=new jTB.AnimatedSpriteObject();b.prototype.setPos=function(l,m){this.pos.x=l;this.pos.y=m-this.spriteHeight};b.prototype.handleMovement=function(){if(this.jumping){this.vel.y=-this.jumpspeed;this.jumpspeed-=this.gravity;if(this.jumspeed==0){this.jumping=false;this.falling=true}}else{this.vel.y+=this.gravity}collision=GameMngr.collisionMap.checkCollision(this.collisionBox,this.vel);if(collision.y){if(this.vel.y>0){this.falling=false;this.jumping=false;this.pos.y=collision.tile.pos.y-this.displayHeight}else{if(this.vel.y<0){this.jumping=false;this.falling=true}}this.vel.y=0}if(collision.x){this.vel.x=0}if((this.vel.x!=0)||(this.vel.y!=0)){this.pos.add(this.vel);return true}return false};b.prototype.update=function(){return jTB.AnimatedSpriteObject.prototype.update.call(this)};f.jTB.EntityPool=a;f.jTB.Viewport=j;f.jTB.ParallaxEntity=h;f.jTB.ObjectEntity=b})(window);(function(e,g){removepath=/^.*(\\|\/|\:)/;removeext=/\.[^\.]*$/;function b(j,o,k,l,m){jTB.Rectangle.call(this,new Vector2d(j*k,o*l),k,l);this.tileId=m;this.row=j;this.col=o;this.nU=null;this.nD=null;this.nL=null;this.nR=null}b.prototype=new jTB.Rectangle();function a(l,m,k,q,o,j){this.name=l;this.tilewidth=m;this.tileheight=k;this.spacing=q;this.margin=o;this.image=(j)?jTB.loader.getImageRessource(j.replace(removepath,"").replace(removeext,"")):null;this.TileProperties=[];if(this.image){this.tileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing))}}a.prototype.drawTile=function(k,j,q,o){var m=this.margin+(this.spacing+this.tilewidth)*(o%this.tileCount);var l=this.margin+(this.spacing+this.tileheight)*~~(o/this.tileCount);k.drawImage(this.image,m,l,this.tilewidth,this.tileheight,j,q,this.tilewidth,this.tileheight)};a.prototype.getTileProperty=function(j){return this.TileProperties[j]};function h(j,k,l){this.width=j;this.height=k;this.layerData=[];this.xLUT=[];this.yLUT=[];this.collide={x:false,y:false,tile:null};this.tileset=l;if(l){this.tilewidth=l.tilewidth;this.tileheight=l.tileheight}else{this.tilewidth=0;this.tileheight=0}this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight}h.prototype.initArray=function(){this.layerData=new Array(this.width);for(var j=0;j<this.width;j++){this.layerData[j]=new Array(this.height);for(var k=0;k<this.height;k++){this.layerData[j][k]=0}}for(var j=0;j<this.width*this.tilewidth;j++){this.xLUT[j]=~~(j/this.tilewidth)}for(var k=0;k<this.height*this.tileheight;k++){this.yLUT[k]=~~(k/this.tileheight)}};h.prototype.getTileId=function(j,k){tile=this.layerData[this.xLUT[j]][this.yLUT[k]];return tile?tile.tileId:null};h.prototype.getTile=function(j,k){return this.layerData[this.xLUT[j]][this.yLUT[k]]};h.prototype.setTile=function(j,l,k){this.layerData[j][l]=new b(j,l,this.tilewidth,this.tileheight,k)};function d(j,k){SpriteObject.call(this,j||0,k||0,null);this.realwidth=-1;this.realheight=-1}d.prototype=new jTB.SpriteObject();var f={levels:{},currentlevel:0,reset:function(){},addLevel:function(j){console.log("no level loader defined")},addTMXLevel:function(j,k){this.levels[j]=new jTB.TMXTileMap(j,0,0);if(k){k()}},loadLevel:function(j){if(this.levels[j]===g){console.log("level %s not found",j);return}if(this.levels[j] instanceof jTB.TMXTileMap){jTB.GameMngr.reset();jTB.GameMngr.loadTMXLevel(this.levels[j])}else{console.log("no level loader defined")}},reloadLevel:function(){return this.loadlevel(this.currentLevel)},nextLevel:function(){if(this.currentLevel+1<this.levels.length){return this.loadLevel(this.currentLevel+1)}else{return false}},previousLevel:function(){if(this.currentLevel-1>=0){return this.loadLevel(this.currentLevel-1)}else{return false}},goToLevel:function(j){this.loadLevel(j)},};e.jTB.Tile=b;e.jTB.TileSet=a;e.jTB.TiledLayer=h;e.jTB.LevelEntity=d;e.jTB.LevelDirector=f})(window);(function(f,d){var k={ENTITIES:"entities",SPRITESHEET:"spritesheet",SPRITECOUNT:"spritecount",COLLIDABLE:"collidable",COLLECTABLE:"collectable",COLLISION_MAP:"collision",TAG_MAP:"map",TAG_NAME:"name",TAG_VALUE:"value",TAG_VERSION:"version",TAG_ORIENTATION:"orientation",TAG_WIDTH:"width",TAG_HEIGHT:"height",TAG_TILEWIDTH:"tilewidth",TAG_TILEHEIGHT:"tileheight",TAG_FIRSTGID:"firstgid",TAG_GID:"gid",TAG_TILE:"tile",TAG_ID:"id",TAG_DATA:"data",TAG_COMPRESSION:"compression",TAG_ENCODING:"encoding",TAG_ATTR_BASE64:"base64",TAG_SPACING:"spacing",TAG_MARGIN:"margin",TAG_PROPERTIES:"properties",TAG_PROPERTY:"property",TAG_IMAGE:"image",TAG_SOURCE:"source",TAG_VISIBLE:"visible",TAG_TILESET:"tileset",TAG_LAYER:"layer",TAG_OBJECTGROUP:"objectgroup",TAG_OBJECT:"object",TAG_X:"x",TAG_Y:"y",TAG_WIDTH:"width",TAG_HEIGHT:"height",};function g(t,s){var o=s.getElementsByTagName(k.TAG_PROPERTIES)[0];if(o){var m=o.getElementsByTagName(k.TAG_PROPERTY);for(var q=0;q<m.length;q++){h(t,m[q])}}}function h(m,s){var q=jTB.XMLParser.getStringAttribute(s,k.TAG_NAME);var o=jTB.XMLParser.getStringAttribute(s,k.TAG_VALUE);if(o.isNumeric()){o=parseInt(o)}else{if(o.isBoolean()){o=(o=="true")}}m[q]=o}function e(o,m,q){jTB.LevelEntity.call(this,m,q);this.xmlfile=o;this.version="";this.orientation="";this.width=0;this.height=0;this.tilewidth=0;this.tileheight=0;this.tileset=[];this.mapLayers=[];this.mapObjectGroup=[];this.tileMapCanvas=null;this.load()}e.prototype=new jTB.LevelEntity();e.prototype.load=function(){var s=jTB.loader.getXMLRessource(this.xmlfile);if(!s){alert(this.xmlfile+" map not found");return}jTB.XMLParser.parseFromString(s);var v=jTB.XMLParser.getFirstElementByTagName(k.TAG_MAP);this.version=jTB.XMLParser.getStringAttribute(v,k.TAG_VERSION);this.orientation=jTB.XMLParser.getStringAttribute(v,k.TAG_ORIENTATION);this.width=jTB.XMLParser.getIntAttribute(v,k.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(v,k.TAG_HEIGHT);this.tilewidth=jTB.XMLParser.getIntAttribute(v,k.TAG_TILEWIDTH);this.tileheight=jTB.XMLParser.getIntAttribute(v,k.TAG_TILEHEIGHT);this.realwidth=this.width*this.tilewidth;this.realheight=this.height*this.tileheight;if(this.orientation!="orthogonal"){alert("%s type tilemap not supported!",this.orientation);return}var u=v.getElementsByTagName(k.TAG_TILESET);for(var q=0;q<u.length;q++){this.tileset[q]=new a(u[q])}var t=v.getElementsByTagName(k.TAG_LAYER);for(var q=0;q<t.length;q++){this.mapLayers[q]=new b(t[q],this.tileset)}var m=v.getElementsByTagName(k.TAG_OBJECTGROUP);for(var q=0;q<m.length;q++){var o=jTB.XMLParser.getStringAttribute(m[q],k.TAG_NAME);this.mapObjectGroup[o]=new l(o,m[q])}this.collisionBox.set(this.pos,this.realwidth,this.realheight);jTB.XMLParser.free()};e.prototype.getObjectGroupByName=function(m){return this.mapObjectGroup[m]};e.prototype.update=function(){return false};e.prototype.draw=function(o){for(var m=0;m<this.mapLayers.length;m++){this.mapLayers[m].draw(o,this.pos.x,this.pos.y)}};function a(o){this.firstgid=jTB.XMLParser.getIntAttribute(o,k.TAG_FIRSTGID);jTB.TileSet.call(this,jTB.XMLParser.getStringAttribute(o,k.TAG_NAME),jTB.XMLParser.getIntAttribute(o,k.TAG_TILEWIDTH),jTB.XMLParser.getIntAttribute(o,k.TAG_TILEHEIGHT),jTB.XMLParser.getIntAttribute(o,k.TAG_SPACING,0),jTB.XMLParser.getIntAttribute(o,k.TAG_MARGIN,0),o.getElementsByTagName(k.TAG_IMAGE)[0].getAttribute(k.TAG_SOURCE));var m=o.getElementsByTagName(k.TAG_TILE);for(var q=0;q<m.length;q++){var s=jTB.XMLParser.getIntAttribute(m[q],k.TAG_ID);if(this.TileProperties[s]==null){this.TileProperties[s]={}}g(this.TileProperties[s],m[q])}}a.prototype=new jTB.TileSet();a.prototype.isTileCollidable=function(m){return(this.TileProperties[m]?this.TileProperties[m][k.COLLIDABLE]:false)};a.prototype.isTileCollectable=function(m){return(this.TileProperties[m]?this.TileProperties[m][k.COLLECTABLE]:false)};function b(o,t){jTB.TiledLayer.call(this,jTB.XMLParser.getIntAttribute(o,k.TAG_WIDTH),jTB.XMLParser.getIntAttribute(o,k.TAG_HEIGHT),t[0]);this.parallax=null;this.parallaxEntity=null;this.layerInvalidated=true;this.name=jTB.XMLParser.getStringAttribute(o,k.TAG_NAME);this.visible=(jTB.XMLParser.getIntAttribute(o,k.TAG_VISIBLE,1)==1);g(this,o);this.isCollisionMap=(this.name==k.COLLISION_MAP);if(this.isCollisionMap){this.visible=false;if(t[1]){this.tileset=t[1]}}this.vp=jTB.GameMngr.viewport;if(this.parallax){this.draw=this.drawParallax;this.parallaxEntity=new jTB.ParallaxEntity(this.imagesrc)}else{var s=o.getElementsByTagName(k.TAG_DATA)[0];var q=jTB.XMLParser.getStringAttribute(s,k.TAG_ENCODING);var m=jTB.XMLParser.getStringAttribute(s,k.TAG_COMPRESSION);if(this.visible){this.layerSurface=jTB.VideoMngr.createCanvasSurface(this.width*this.tilewidth,this.height*this.tileheight);this.layerCanvas=this.layerSurface.canvas;this.draw=this.drawTiled}else{this.draw=function(){}}this.initArray();this.fillArray(s,q,m)}}b.prototype=new jTB.TiledLayer();b.prototype.fillArray=function(v,t,q){if(q!=null){alert(q+" compressed tilemap not supported!");return}if(t==k.TAG_ATTR_BASE64){var u=jTB.Utils.decodeNumeric_base64(v.childNodes[0].nodeValue)}else{var u=v.getElementsByTagName(k.TAG_TILE)}var o=0;for(var w=0;w<this.height;w++){for(var m=0;m<this.width;m++){if(t==k.TAG_ATTR_BASE64){var s=u[o]|u[o+1]<<8|u[o+2]<<16|u[o+3]<<24;o+=4}else{var s=jTB.XMLParser.getIntAttribute(u[o++],k.TAG_GID)}if(s>0){this.setTile(m,w,s-this.tileset.firstgid);if(this.visible){this.tileset.drawTile(this.layerSurface,m*this.tilewidth,w*this.tileheight,this.layerData[m][w].tileId)}}else{}}}};b.prototype.checkCollision=function(q,o){var m=(o.x<0)?q.pos.x+q.colPos.x+o.x:q.pos.x+q.colPos.x+q.width+o.x;var s=(o.y<0)?q.pos.y+q.colPos.y+o.y:q.pos.y+q.colPos.y+q.height+o.y+1;this.collide.x=false;if(m<=0||m>=this.realwidth){this.collide.x=true}else{this.collide.tile=this.getTile(m,q.pos.y+q.colPos.y+q.height-1);if(this.collide.tile&&this.tileset.isTileCollidable(this.collide.tile.tileId)){this.collide.x=true}else{this.collide.tile=this.getTile(m,q.pos.y+q.colPos.y);if(this.collide.tile&&this.tileset.isTileCollidable(this.collide.tile.tileId)){this.collide.x=true}}}this.collide.y=false;this.collide.tile=this.getTile(q.pos.x+q.colPos.x,s);if(this.collide.tile&&this.tileset.isTileCollidable(this.collide.tile.tileId)){this.collide.y=true}else{this.collide.tile=this.getTile(q.pos.x+q.colPos.x+q.width,s);if(this.collide.tile&&this.tileset.isTileCollidable(this.collide.tile.tileId)){this.collide.y=true}}return this.collide};b.prototype.isTileCollidable=function(m,o){return this.tileset.isTileCollidable(this.getTileId(m,o))};b.prototype.drawTiled=function(o,m,q){o.drawImage(this.layerCanvas,this.vp.pos.x,this.vp.pos.y,this.vp.width,this.vp.height,m,q,this.vp.width,this.vp.height)};b.prototype.drawParallax=function(o,m,q){this.parallaxEntity.draw(o,this.vp.pos.x-m,q)};function l(o,m){this.objects=[];this.name=o;this.width=jTB.XMLParser.getIntAttribute(m,k.TAG_WIDTH);this.height=jTB.XMLParser.getIntAttribute(m,k.TAG_HEIGHT);var s=m.getElementsByTagName(k.TAG_OBJECT);for(var q=0;q<s.length;q++){this.objects.push(new j(s[q]))}}l.prototype.getObjectCount=function(){return this.objects.length};l.prototype.getObjectByIndex=function(m){return this.objects[m]};function j(m){this.name=jTB.XMLParser.getStringAttribute(m,k.TAG_NAME);this.x=jTB.XMLParser.getIntAttribute(m,k.TAG_X);this.y=jTB.XMLParser.getIntAttribute(m,k.TAG_Y);this.width=jTB.XMLParser.getIntAttribute(m,k.TAG_WIDTH,0);this.height=jTB.XMLParser.getIntAttribute(m,k.TAG_HEIGHT,0);g(this,m)}j.prototype.getObjectPropertyByName=function(m){return this[m]};f.jTB.TMXTileMap=e;f.jTB.TMXConstants=k})(window);